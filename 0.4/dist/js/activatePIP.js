define("utils/polyfills",[],function(){function e(){console.log.apply(console,arguments)}Date.now||(Date.now=function(){return(new Date).getTime()}),console.group||(console.group=e),console.groupCollapsed||(console.groupCollapsed=e),console.groupEnd||(console.groupEnd=e),console.table||(console.table=e),function(){"use strict";for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout}}();var t=function(e){function n(e,t){return function n(s){var d;try{if(!t||null==s||"object"!=typeof s&&"function"!=typeof s||"function"!=typeof(d=s.then))l(function(){t||0!==e.length||console.error("Possible unhandled promise rejection:",s);for(var r=0;r<e.length;r++)e[r](s);a.length=0,o.length=0,c.state=t,c.retry=function(){n(s)}});else{if(s===i)throw new TypeError("Promise can't be resolved w/ itself");r(d.bind(s))}}catch(f){u(f)}}}function r(e){function t(e){return function(t){n++>0||e(t)}}var n=0,r=t(u);try{e(t(s),r)}catch(i){r(i)}}if(!(this instanceof t))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var i=this,a=[],o=[],s=n(a,!0),u=n(o,!1),c=i._instance={resolvers:a,rejectors:o},l="function"==typeof setImmediate?setImmediate:setTimeout;r(e)};t.prototype.then=function(e,n){function r(e,t,n,r){t.push(function(t){if("function"!=typeof e)n(t);else try{i(e(t))}catch(r){a&&a(r)}}),"function"==typeof s.retry&&r===s.state&&s.retry()}var i,a,o=this,s=o._instance,u=new t(function(e,t){i=e,a=t});return r(e,s.resolvers,i,!0),r(n,s.rejectors,a,!1),u},t.prototype["catch"]=function(e){return this.then(null,e)},t.resolve=function(e){return e instanceof t?e:new t(function(t){t(e)})},t.reject=function(e){return new t(function(t,n){n(e)})},t.all=function(e){return new t(function(t,n){var r=e.length,i=0,a=[];if(0===e.length)t([]);else for(var o=0;o<e.length;o++)!function(o){function s(e){i++,a[o]=e,i===r&&t(a)}null==e[o]||"object"!=typeof e[o]&&"function"!=typeof e[o]||"function"!=typeof e[o].then?s(e[o]):e[o].then(s,n)}(o)})},t.race=function(e){return new t(function(t,n){for(var r=0;r<e.length;r++)e[r].then(t,n)})},"undefined"==typeof window.Promise&&(window.Promise=t)}),define("app/task/script",[],function(){function e(e){return e&&(t=e),t}var t={};return e}),define("app/global",["require","underscore"],function(e){function t(e,i){return i?r=e:(n.isPlainObject(e)&&(n.each(function(e,n){console.warn&&t[n]&&console.warn('Overwriting "'+n+'" in global object.')}),n.merge(r,e)),r)}window.piGlobal||(window.piGlobal={});var n=e("underscore"),r=window.piGlobal;return t}),define("utils/database/mixer/mixer",["underscore"],function(e){function t(t,n){function r(t){var n=t.mixer;if(!(e.isPlainObject(t)&&"mixer"in t))return[t];if(e.isUndefined(r.mixers[n]))throw new Error("Mixer: unknow mixer type = "+n);if(!t.remix&&t.$parsed)return t.$parsed;if(t.$parsed=r.mixers[n].apply(null,arguments),!e.isArray(t.$parsed))throw new Error("Mixer: mixers must return an array (mixer: "+n+")");return t.$parsed}function i(t,n){return e.reduce(t,function(t,a){if(e.isPlainObject(a)&&"mixer"in a&&"wrapper"!=a.mixer&&!a.wrapper){var o=i(r(a,n),n);return t.concat(o)}return t.concat([a])},[])}function a(t,r){function a(){var e,r=n()*l,i=0;for(e=0;e<s.length;e++)if(i+=t.weights[e],i=+i.toFixed(3),i>=r)return t.data[e];throw new Error("Mixer: something went wrong with weightedRandom")}var o,s=t.data?i(t.data,r):[],u=t.n||1,c=[],l=e.reduce(t.weights,function(e,t){return e+t});for(o=0;u>o;o++)c.push(a());return c}return r.mixers={wrapper:function(e){return e.data},repeat:function(t){var n,r=t.data||[],i=[];for(n=0;n<t.times;n++)i=i.concat(e.clone(r,!0));return i},random:function(e,n){var r=e.data?i(e.data,n):[];return t(r)},choose:function(n,r){var a=n.data?i(n.data,r):[];return e.take(t(a),n.n?n.n:1)},custom:function(t,n){return e.isFunction(t.fn)?t.fn(t,n):[]},weightedRandom:a,weightedChoose:a},r}return t.$inject=["randomizeShuffle","randomizeRandom"],t}),define("utils/database/mixer/branching/dotNotation",["require","underscore"],function(e){function t(e,t){return n.isUndefined(e)?void 0:(n.isString(e)&&(e=e.split(".")),e.reduce(function(e,t){return n.isPlainObject(e)||n.isArray(e)?e[t]:void 0},t))}var n=e("underscore");return t}),define("utils/database/mixer/branching/mixerDotNotationProvider",["require","underscore"],function(e){function t(e){function t(t,r){var i=/[^\/]\./;return n.isString(t)?i.test(t)?e(t,r):t.replace("/.","."):t}return t}var n=e("underscore");return t.$inject=["dotNotation"],t}),define("utils/database/mixer/branching/mixerConditionProvider",["require","underscore"],function(e){function t(e,t){function r(n,r){var a=i(n),o=e(n.compare,r),s=e(n.to,r);return t(["conditions"]).info("Condition: ",o,a||"equals",s,n),n.DEBUG&&console&&console.info("Condition: ",o,n.operator||"equals",s,n),n.negate?!a.apply(r,[o,s,r]):a.apply(r,[o,s,r])}function i(e){var t=e.operator;return n.isFunction(e)?e:n.has(e,"operator")?n.isFunction(t)?t:u[t]:n.has(e,"to")?n.eq:a}function a(e){return!!e}function o(e,t){return e===t}function s(e){return function(t,r){return[t,r].every(n.isNumber)?e(t,r):!1}}var u={gt:s(n.gt),greaterThan:s(n.gt),gte:s(n.gte),greaterThanOrEqual:s(n.gte),equals:n.eq,"in":n.rearg(n.contains,1,0),contains:n.rearg(n.contains,1,0),exactly:o,isTruthy:a};return r}var n=e("underscore");return t.$inject=["mixerDotNotation","piConsole"],t}),define("utils/database/mixer/branching/mixerEvaluateProvider",["require","underscore"],function(e){function t(e){function t(r,i){function a(e){return t(e,i)}return n.isArray(r)&&(r={and:r}),r.and?n.every(r.and,a):r.nand?!n.every(r.nand,a):r.or?n.some(r.or,a):r.nor?!n.some(r.nor,a):e(r,i)}return t}var n=e("underscore");return t.$inject=["mixerCondition"],t}),define("utils/database/mixer/branching/mixerBranchingDecorator",["require","underscore"],function(e){function t(e,t,r){function i(e,i){return i=n.extend(i||{},r),t(e.conditions,i)?e.data||[]:e.elseData||[]}function a(e,i){i=n.extend(i||{},r);var a;return a=n.find(e.branches,function(e){return t(e.conditions,i)}),a?a.data||[]:e.elseData||[]}return e.mixers.branch=i,e.mixers.multiBranch=a,e}var n=e("underscore");return t.$inject=["$delegate","mixerEvaluate","mixerDefaultContext"],t}),define("utils/database/mixer/mixerSequenceProvider",["require","underscore"],function(e){function t(e){function t(e){this.sequence=e,this.stack=[],this.add(e),this.pointer=0}return n.extend(t.prototype,{add:function(e,t){this.stack.push({pointer:t?e.length:-1,sequence:e})},proceed:function(t,r){var i=this.stack[this.stack.length-1],a="next"===t;if(!i)throw new Error("mixerSequence: subSequence not found");i.pointer+=a?1:-1;var o=i.sequence[i.pointer];return n.isUndefined(o)&&this.stack.length>1?(this.stack.pop(),this.proceed.call(this,t,r)):o&&o.mixer?(this.add(e(o,r),!a),this.proceed.call(this,t,r)):this},next:function(e){return this.pointer++,this.proceed.call(this,"next",e)},prev:function(e){return this.pointer--,this.proceed.call(this,"prev",e)},current:function(){var e=this.stack[this.stack.length-1];if(!e)throw new Error("mixerSequence: subSequence not found");var t=e.sequence[e.pointer];if(t)return t.$meta=this.meta(),t},meta:function(){return{number:this.pointer,outOf:n.reduce(this.stack,function(e,t){return e+t.sequence.length-1},0)+1}}}),t}var n=e("underscore");return t.$inject=["mixer"],t}),define("utils/database/mixer/main",["require","underscore","./mixer","./branching/dotNotation","./branching/mixerDotNotationProvider","./branching/mixerConditionProvider","./branching/mixerEvaluateProvider","./branching/mixerBranchingDecorator","./mixerSequenceProvider"],function(e){function t(){return console}var n=e("underscore"),r=e("./mixer")(n.shuffle,Math.random),i=e("./branching/dotNotation"),a=e("./branching/mixerDotNotationProvider")(i),o=e("./branching/mixerConditionProvider")(a,t),s=e("./branching/mixerEvaluateProvider")(o),u={};e("./branching/mixerBranchingDecorator")(r,s,u);var c=e("./mixerSequenceProvider")(r);return c}),define("utils/database/template/templateObjProvider",["require","underscore"],function(e){function t(e){function t(t,r,i){function a(e){return n.isString(e)?o(e,l):n.isArray(e)?e.map(a):n.isPlainObject(e)?n.mapValues(e,a):e}function o(e){return~e.indexOf("<%")?n.template(e)(r):e}var s,u=n.get(i,"skip",[]),c={},l=n.assign({},r,e);for(s in t)c[s]=-1==u.indexOf(s)?a(t[s]):t[s];return c}return t}var n=e("underscore");return t.$inject=["templateDefaultContext"],t}),define("utils/database/template/main",["require","./templateObjProvider"],function(e){return e("./templateObjProvider")({})}),define("utils/database/collection/collectionProvider",["underscore"],function(e){function t(){function t(n){if(n instanceof t)return n;if(!(e.isUndefined(n)||e.isArray(n)||n instanceof t))throw new Error("Collections can only be constructed from arrays");this.collection=n||[],this.length=this.collection.length,this.pointer=-1}e.extend(t.prototype,{first:function(){return this.pointer=0,this.collection[this.pointer]},last:function(){return this.pointer=this.collection.length-1,this.collection[this.pointer]},end:function(){this.pointer=this.collection.length},current:function(){return this.collection[this.pointer]},next:function(){return this.collection[++this.pointer]},previous:function(){return this.collection[--this.pointer]},add:function(t){return arguments.length?(t=e.isArray(t)?t:[t],this.collection=this.collection.concat(t),this.length=this.collection.length,this):this},at:function(e){return this.collection[e]}});var n=["where","filter"],r=Array.prototype.slice;return e.each(n,function(n){t.prototype[n]=function(){var i=r.call(arguments);i.unshift(this.collection);var a=e[n].apply(e,i);return new t(a)}}),t}return t}),define("utils/database/randomizer/randomizerProvider",["underscore"],function(e){function t(t,n,r){function i(){this._cache={random:{},exRandom:{},sequential:{}}}function a(n,r,i){var a=this._cache.random;return i&&!e.isUndefined(a[r])?a[r]:(a[r]=t(n),a[r])}function o(t,n,i){var a,o=this._cache.sequential,s=o[n];if(e.isUndefined(s))return s=o[n]=new r(e.range(t)),s.first();if(s.length!==t)throw new Error("This seed  ("+n+") points to a collection with the wrong length, you can only use a seed for sets of the same length");return i?s.current():(a=s.next(),e.isUndefined(a)?s.first():a)}function s(t,i,a){var o,s=this._cache.exRandom,u=s[i];if(e.isUndefined(u))return u=s[i]=new r(n(t)),u.first();if(u.length!==t)throw new Error("This seed  ("+i+") points to a collection with the wrong length, you can only use a seed for sets of the same length");return a?u.current():(o=u.next(),e.isUndefined(o)?(u=s[i]=new r(n(t)),u.first()):o)}return e.extend(i.prototype,{random:a,exRandom:s,sequential:o}),i}return t.$inject=["randomizeInt","randomizeRange","Collection"],t}),define("utils/database/queryProvider",["underscore"],function(e){function t(t,n){function r(r,i,a){var o=new t(i);if(e.isFunction(r))return r(i);(e.isString(r)||e.isNumber(r))&&(r={set:r,type:"random"}),r.set&&(o=o.where({set:r.set})),e.isString(r.data)&&(o=o.filter(function(e){return e.handle===r.data||e.data&&e.data.handle===r.data})),e.isPlainObject(r.data)&&(o=o.where({data:r.data})),e.isFunction(r.data)&&(o=o.filter(r.data));var s,u,c=r.seed||"$"+i.namespace+r.set,l=o.length,d=r.repeat;switch(r.type){case void 0:case"byData":case"random":s=a.random(l,c,d);break;case"exRandom":s=a.exRandom(l,c,d);break;case"sequential":s=a.sequential(l,c,d);break;case"first":s=0;break;case"last":s=l-1;break;default:throw new Error("Unknow query type: "+r.type)}if(e.isUndefined(o.at(s)))throw u=new Error("Query failed, object ("+JSON.stringify(r)+") not found. If you are trying to apply a template, you should know that they are not supported for inheritance."),n("query").error(u),u;return o.at(s)}return r}return t.$inject=["Collection","piConsole"],t}),define("utils/database/inflateProvider",["require","underscore"],function(e){function t(e,t,r){function i(e){return n.isFunction(e.customize)&&e.customize.apply(e,[e,t.global]),e}function a(t,o,s,u,c){if(c=u?--c:10,!c)throw new Error("Inheritance loop too deep, you can only inherit up to 10 levels down");if(!n.isPlainObject(t))throw console.error("You are trying to inflate a non object",t),new Error("You are trying to inflate a non object");var l,d,f=n.cloneDeep(t),p=f.inherit;if(!f.inherit)return!u&&i(f),f;if(l=e(p,o,s),!l)throw d=new Error("Query failed, object ("+JSON.stringify(p)+") not found."),r("query").error(d),d;if(l=a(l,o,s,!0,c),p.merge&&!n.isArray(p.merge))throw new Error("Inheritance error: inherit.merge must be an array.");return n.each(l,function(e,t){var r,i;if(!(t in f))return void(f[t]=n.isFunction(e)?e:n.cloneDeep(e));if(-1!=n.indexOf(p.merge,t)){if(r=f[t],i=e,n.isArray(r)){if(!n.isArray(i))throw new Error('Inheritance error: You tried merging an array with an non array (for "'+t+'")');f[t]=r.concat(i)}if(n.isPlainObject(r)){if(!n.isPlainObject(i))throw new Error('Inheritance error: You tried merging an object with an non object (for "'+t+'")');f[t]=n.extend({},i,r)}}}),l.data&&(f.data=n.extend(l.data,f.data||{})),!u&&i(f),f}return a}var n=e("underscore");return t.$inject=["databaseQuery","$rootScope","piConsole"],t}),define("utils/database/store/storeProvider",["underscore"],function(e){function t(t){function n(){this.store={}}return e.extend(n.prototype,{create:function(e){if(this.store[e])throw new Error("The name space "+e+" already exists");this.store[e]=new t,this.store[e].namespace=e},read:function(e){if(!this.store[e])throw new Error("The name space "+e+" does not exist");return this.store[e]},update:function(e,t){var n=this.read(e);n.add(t)},del:function(e){this.store[e]=void 0}}),n}return t.$inject=["Collection"],t}),define("utils/database/databaseSequenceProvider",["require","underscore"],function(e){function t(e){function t(t,n,r){this.namespace=t,this.mixerSequence=new e(n),this.db=r}return n.extend(t.prototype,{next:function(e){return this.mixerSequence.next(e),this},prev:function(e){return this.mixerSequence.prev(e),this},current:function(e,t){e||(e={});var n=this.mixerSequence.current(e);return n?this.db.inflate(this.namespace,n,e,t):n},all:function(e,t){for(var n=[],r=this.next().current(e,t);r;)n.push(r),r=this.next().current(e,t);return n}}),t}var n=e("underscore");return t.$inject=["MixerSequence"],t}),define("utils/database/databaseProvider",["require","underscore"],function(e){function t(e,t,r,i,a){function o(){this.store=new e,this.randomizer=new t}return n.extend(o.prototype,{createColl:function(e){this.store.create(e)},getColl:function(e){return this.store.read(e)},add:function(e,t){var n=this.store.read(e);n.add(t)},inflate:function(e,t,a,o){var s,u=this.getColl(e);return(!t.$inflated||t.reinflate)&&(t.$inflated=r(t,u,this.randomizer),t.$templated=null),(!t.$templated||t.$inflated.regenerateTemplate)&&(a[e+"Meta"]=t.$meta,a[e+"Data"]=i(t.$inflated.data||{},a,o),t.$templated=i(t.$inflated,a,o)),s=t.$templated,a.global&&s.addGlobal&&n.extend(a.global,s.addGlobal),a.current&&s.addCurrent&&n.extend(a.current,s.addCurrent),t.$templated},sequence:function(e,t){if(!n.isArray(t))throw new Error("Sequence must be an array.");return new a(e,t,this)}}),o}var n=e("underscore");return t.$inject=["DatabaseStore","DatabaseRandomizer","databaseInflate","templateObj","databaseSequence"],t}),define("utils/database/main",["require","underscore","./mixer/main","./template/main","./collection/collectionProvider","./randomizer/randomizerProvider","./queryProvider","./inflateProvider","./store/storeProvider","./databaseSequenceProvider","./databaseProvider"],function(e){function t(e){return i.shuffle(i.range(e))}function n(e){return Math.floor(Math.random()*e)}function r(){return console}var i=e("underscore"),a=e("./mixer/main"),o=e("./template/main"),s=e("./collection/collectionProvider")(),u=e("./randomizer/randomizerProvider")(n,t,s),c=e("./queryProvider")(s,r),l=e("./inflateProvider")(c,{global:window.piGlobal},r),d=e("./store/storeProvider")(s),f=e("./databaseSequenceProvider")(a),p=e("./databaseProvider")(d,u,l,o,f);return p}),define("app/sequencer/sequenceGoto",["require","underscore"],function(e){function t(e,t,r){var i=this.mixerSequence;switch(e){case"nextWhere":n("next",t,r,i);break;case"previousWhere":n("next",t,r,i);break;case"current":break;case"first":do i.prev(r);while(i.current(r));break;case"last":do i.next(r);while(i.current(r));i.prev();break;case"end":do i.next(r);while(i.current(r));break;case"next":i.next(r);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function n(e,t,n,i){var a;do i[e](),a=i.current(n);while(a&&!r.callback(t)(a.data))}var r=e("underscore");return t}),define("app/task/parser",["require","underscore","utils/database/main","../sequencer/sequenceGoto"],function(e){var t=e("underscore"),n=e("utils/database/main"),r=e("../sequencer/sequenceGoto");return function(e){var i=new n;if(i.createColl("trial"),i.createColl("stimulus"),i.createColl("media"),i.add("trial",e.trialSets||[]),i.add("stimulus",e.stimulusSets||[]),i.add("media",e.mediaSets||[]),!t.isArray(e.sequence))throw new Error("You must set a sequence array.");var a=i.sequence("trial",e.sequence);return a.go=r,i.currentSequence=a,i}}),define("utils/getSize",[],function(){function e(e){var n=window.getComputedStyle(e);return{height:t(e.offsetHeight)-t(n.borderTopWidth)-t(n.borderBottomWidth),width:t(e.offsetWidth)-t(n.borderLeftWidth)-t(n.borderRightWidth)}}function t(e){return parseFloat(e,10)||0}return e}),define("app/task/adjust_canvas",["require","underscore","utils/getSize"],function(e){function t(e,t){function n(e){"orientationchange"==e.type?setTimeout(o,500):o()}function o(){var n=r(t,e),a=window.getComputedStyle(e);n.height-=i(a.borderTopWidth)+i(a.borderBottomWidth)+i(a.marginTop),n.width-=i(a.borderLeftWidth)+i(a.borderRightWidth),e.style.width=n.width+"px",e.style.height=n.height+"px",e.style.fontSize=n.height*(t.textSize||3)/100+"px",window.scrollTo(0,1)}return a.throttle(n,16)}function n(e){if(a.isPlainObject(e.proportions)){if("number"!=typeof e.proportions.height||"number"!=typeof e.proportions.width)throw new Error("The canvas proportions object`s height and a width properties must be numeric");return e.proportions.height/e.proportions.width}return e.proportions||.8}function r(e,t){var r=n(e);if(e.width)return{width:e.width,height:e.width*r};var i=window.document.documentElement,a=i.clientHeight,s=Math.min(e.maxWidth,i.clientWidth,o(t.parentNode).width);return a>r*s?{height:s*r,width:s}:{height:a,width:a/r}}function i(e){return parseFloat(e,10)||0}var a=e("underscore"),o=e("utils/getSize");return t}),define("app/task/applyCanvasStyles",["require","underscore"],function(e){function t(e,t){var i;if(!r.isPlainObject(e))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(r.isUndefined(t))return r.noop;if(!r.isPlainObject(t))throw new Error("canvas(settings): canvas settings must be an object");return i=r.map(t,function(t,r){var i=e[r];if(i)return n(i.element,i.property,t);throw new Error("canvas("+r+"): unknow key in canvas object.")}),function(){r.forEach(i,function(e){e.call()})}}function n(e,t,n){var r=e.style[t];return e.style[t]=n,function(){e.style[t]=r}}var r=e("underscore");return t}),define("utils/stream",[],function(){function e(){function e(){return arguments.length>0&&arguments[0]!==E&&n(e,arguments[0]),e._state.value}return t(e),arguments.length>0&&arguments[0]!==E&&n(e,arguments[0]),e}function t(t){t.constructor=e,t._state={id:q++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},t.map=t["fantasy-land/map"]=l,t["fantasy-land/ap"]=d,t["fantasy-land/of"]=e,t.valueOf=f,t.toJSON=p,t.toString=f,Object.defineProperties(t,{end:{get:function(){if(!t._state.endStream){var n=e();n.map(function(e){return e===!0&&(c(t),n._state.unregister=function(){c(n)}),e}),t._state.endStream=n}return t._state.endStream}}})}function n(e,t){r(e,t);for(var n in e._state.deps)i(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),a(e)}function r(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function i(e,t){var n=e._state,i=n.parents;if(i.length>0&&i.every(m)&&(t||i.some(g))){var a=e._state.derive();if(a===E)return!1;r(e,a)}}function a(e){e._state.changed=!1;for(var t in e._state.deps)e._state.deps[t]._state.changed=!1}function o(t,n){if(!n.every(h))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return s(e(),n,function(){return t.apply(this,n.concat([n.filter(g)]))})}function s(e,t,n){var r=e._state;return r.derive=n,r.parents=t.filter(v),u(e,r.parents),i(e,!0),e}function u(e,t){for(var n=0;n<t.length;n++)t[n]._state.deps[e._state.id]=e,u(e,t[n]._state.parents)}function c(e){for(var t=0;t<e._state.parents.length;t++){var n=e._state.parents[t];delete n._state.deps[e._state.id]}for(var r in e._state.deps){var i=e._state.deps[r],a=i._state.parents.indexOf(e);a>-1&&i._state.parents.splice(a,1)}e._state.state=2,e._state.deps={}}function l(e){return o(function(t){return e(t())},[this])}function d(e){return o(function(e,t){return e()(t())},[e,this])}function f(){return this._state.value}function p(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function h(e){return e._state}function m(e){return 1===e._state.state}function g(e){return e._state.changed}function v(e){return 2!==e._state.state}function y(e){return o(function(){return e.map(function(e){return e()})},e)}function w(e,t,n){var r=o(function(n){return t=e(t,n._state.value)},[n]);return 0===r._state.state&&r(t),r}function b(e,t){var n=e.map(function(e){var t=e[0];return 0===t._state.state&&t(void 0),t}),r=o(function(){var r=arguments[arguments.length-1];return n.forEach(function(n,i){r.indexOf(n)>-1&&(t=e[i][1](t,n._state.value))}),t},n);return r}var q=0,E={};return e["fantasy-land/of"]=e,e.merge=y,e.combine=o,e.scan=w,e.scanMerge=b,e.HALT=E,e}),define("utils/css",[],function(){function e(e,t){function n(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})}var r=e.style;if(t)for(var i in t)r[n(i)]=t[i]}return e}),define("app/task/canvasSetup",["require","underscore","./adjust_canvas","./applyCanvasStyles","utils/stream","utils/css"],function(e){function t(e,t){function s(){window.removeEventListener("orientationchange",c),window.removeEventListener("resize",c)}var u=n.get(t,"settings.canvas",{}),c=a();e.classList.add("minno-canvas"),c.map(r(e,u)),c({}),window.addEventListener("orientationchange",c),window.addEventListener("resize",c);var l={background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},d=i(l,n.pick(u,["background","canvasBackground","borderColor","borderWidth"]));return u.css&&o(e,u.css),c.end.map(function(){e.classList.remove("minno-canvas")}).map(s).map(d),c}var n=e("underscore"),r=e("./adjust_canvas"),i=e("./applyCanvasStyles"),a=e("utils/stream"),o=e("utils/css");return t}),define("utils/preloader",[],function(){function e(e,o){var s;if(o=o||"image",-1!==t.indexOf(e))return!1;switch(o){case"template":s=new Promise(function(t,n){requirejs(["text!"+e],t,function(){n(new Error("Template not found: "+e))})});break;case"image":default:s=new Promise(function(t,n){var r=document.createElement("img");r.onload=function(){t(r)},r.onerror=function(){n(new Error("Image not found: "+r.src))},r.src=e,i[e]=r})}return s.then(function(){r++}).then(function(){a.onload&&a.onload()}),n.push(s),t.push(e),s}var t=[],n=[],r=0,i={},a={load:e,all:function(){return Promise.all(n)},getImage:function(e){return i[e].cloneNode()},reset:function(){t=[],n=[]},progress:function(){return n.length?r/n.length:1}};return a}),define("app/task/settings",["require","./script"],function(e){function t(e){var t=n().settings||{};return e?t[e]:t}var n=e("./script");return t}),define("app/task/build_url",["require","underscore","./settings"],function(e){var t=e("underscore"),n=e("./settings");return function(e,r){var i,a=n();return t.isString(a.base_url)?i=a.base_url:t.isObject(a.base_url)&&(i=a.base_url[r]),"image"==r&&/^data:image/.test(e)?e:(i?"/"!=i[i.length-1]&&(i+="/"):i="",i+e)}}),define("app/sequencer/sequencePreload",["require","underscore","utils/preloader","app/task/build_url"],function(e){function t(e){u.isUndefined(e.image)||c.load(l(e.image,"image"),"image"),u.isUndefined(e.template)||c.load(l(e.template,"template"),"template")}function n(e){e.media&&t(e.media)}function r(e){e.element&&t(e.element)}function i(e){u.each(e.layout||[],n),u.each(e.stimuli||[],n),u.each(e.input||[],r)}function a(e){u.each(e,function(e){u.isUndefined(e.mixer)?i(e):a(e.data)})}function o(e){u.each(e.mediaSets||[],t),u.each(e.stimulusSets||[],n),u.each(e.trialSets||[],i),a(e.sequence)}function s(e,r,a){switch(a&&c.reset(),r){case"media":t(e);break;case"stimulus":n(e);break;case"trial":i(e);break;case"script":default:o(e)}return c}var u=e("underscore"),c=e("utils/preloader"),l=e("app/task/build_url");return s}),!function(e){function t(){var t=this;t.reads=[],t.writes=[],t.raf=u.bind(e),s("initialized",t)}function n(e){e.scheduled||(e.scheduled=!0,e.raf(r.bind(null,e)),s("flush scheduled"))}function r(e){s("flush");var t,r=e.writes,a=e.reads;try{s("flushing reads",a.length),i(a),s("flushing writes",r.length),i(r)}catch(o){t=o}if(e.scheduled=!1,(a.length||r.length)&&n(e),t){if(s("task errored",t.message),!e["catch"])throw t;e["catch"](t)}}function i(e){s("run tasks");for(var t;t=e.shift();)t()}function a(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}function o(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}var s=function(){},u=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};t.prototype={constructor:t,measure:function(e,t){s("measure");var r=t?e.bind(t):e;return this.reads.push(r),n(this),r},mutate:function(e,t){s("mutate");var r=t?e.bind(t):e;return this.writes.push(r),n(this),r},clear:function(e){return s("clear",e),a(this.reads,e)||a(this.writes,e)},extend:function(e){if(s("extend",e),"object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return o(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},"catch":null};var c=e.fastdom=e.fastdom||new t;"function"==typeof define?define("utils/fastdom",[],function(){return c}):"object"==typeof module&&(module.exports=c)}("undefined"!=typeof window?window:this),define("app/preloadPhase",["require","./sequencer/sequencePreload","utils/fastdom"],function(e){function t(e,t){function i(){for(;e.firstChild;)e.removeChild(e.firstChild)}var a=n(t);if(1==a.progress())return Promise.resolve().then(i);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var o=e.getElementsByClassName("minno-progress-bar")[0].style;return o.width=a.progress()+"%",a.onload=function(){r.mutate(function(){o.width=100*a.progress()+"%"})},a.all().then(i)["catch"](function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")})}var n=e("./sequencer/sequencePreload"),r=e("utils/fastdom");return t}),define("app/trial/input/bindings/mouseEvents",["require","utils/css","utils/fastdom"],function(e){var t=e("utils/css"),n=e("utils/fastdom");return function(e,r,i,a){function o(e){var t=e.target;return u&&t===u?r(e):u||t.getAttribute("data-handle")!==i.stimHandle?void 0:r(e)}function s(){u&&a.removeChild(u),a.removeEventListener(e,r)}var u=i.element;return u&&(t(u,i.css),n.mutate(function(){a.appendChild(u)})),a.addEventListener(e,o),r.end.map(s),r}}),define("app/trial/input/bindings/keypressed",[],function(){var e=[];return document.addEventListener("keyup",function(t){e[t.which]=!1}),function(t,n){function r(n){e[n.which]||-1===o.indexOf(n.which)||(n.preventDefault(),e[n.which]=!0,t(n))}function i(){document.removeEventListener("keydown",r)}var a=Array.isArray(n.key)?n.key:[n.key],o=a.map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",r),t.end.map(i),t}}),define("app/trial/input/bindings/keyup",[],function(){return function(e,t){function n(t){return-1!==a.indexOf(t.which)?(t.preventDefault(),e(t)):void 0}function r(){document.removeEventListener("keyup",e)}var i=Array.isArray(t.key)?t.key:[t.key],a=i.map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",n),e.end.map(r),e}}),define("utils/simpleRandomize",["require","underscore"],function(e){function t(e,t){if(n.isArray(e)){var r=Math.floor(Math.random()*e.length);return e[r]}if(n.isFunction(e))return e.call(t);if(n.isPlainObject(e)){if(!n.isNumber(e.min)||!n.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}var n=e("underscore");return t}),define("app/trial/input/bindings/timeout",["require","utils/simpleRandomize"],function(e){function t(e,t){function r(){clearTimeout(i)}var i,a=n(t.duration)||0;return e.end.map(r),a?setTimeout(e.bind(null,{}),a):e({}),e}var n=e("utils/simpleRandomize");return t}),define("app/trial/input/binder",["require","underscore","./bindings/mouseEvents","./bindings/keypressed","./bindings/keyup","./bindings/timeout","utils/css"],function(e){function t(e,t,u){function c(e,t){var n=document.createElement("div");return s(n,t),s(n,e),n}var l=t.on;switch(l){case"keypressed":return i(e,t);case"keyup":return a(e,t);case"click":case"mousedown":return r("mousedown",e,t,u);case"mouseup":return r("mouseup",e,t);case"mouseenter":return r("mouseenter",e,t);case"mouseleave":return r("mouseleave",e,t);case"timeout":return o(e,t);case"enter":return i(e,n.assign({key:13},t));case"space":return i(e,n.assign({key:32},t));case"esc":return i(e,n.assign({key:27},t));case"leftTouch":return t.element=c(t.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),r("mousedown",e,t);case"rightTouch":return t.element=c(t.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),r("mousedown",e,t);case"topTouch":return t.element=c(t.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),r("mousedown",e,t);case"bottomTouch":return t.element=c(t.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),r("mousedown",e,t);default:throw new Error('You have an input element without a recognized "on" property: '+l)}}var n=e("underscore"),r=e("./bindings/mouseEvents"),i=e("./bindings/keypressed"),a=e("./bindings/keyup"),o=e("./bindings/timeout"),s=e("utils/css");return t}),define("app/trial/input/createListener",["require","./binder","utils/stream","underscore"],function(e){function t(e,t){var o=i();if(o.handle=e.handle,a.isFunction(e)){if(o=e(o,e,t),n(o))return o;throw new Error("Input functions must return valid streams")}if(!a.isPlainObject(e))throw new Error("Input must only contain objects and functions, do you have an undefined value?");return a.isString(e.on)?r(o,e,t):(a.isFunction(e.on)&&e.on(o,e,t),a.isFunction(e.off)&&o.end.map(e.off),o)}function n(e){return e._state}var r=e("./binder"),i=e("utils/stream"),a=e("underscore");
return t}),define("app/trial/input/now",[],function(){return window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date)}),define("app/trial/input/input",["require","./createListener","./now"],function(e){function t(e,t){function i(i){function a(e){return{handle:i.handle,event:e,trialId:t._id,counter:t.counter,timestamp:+new Date,latency:r()-c}}if(!i)throw new Error("Missing input element. Could not add input listener");var o=n(i,t.canvas);o.map(a).map(e),u.push(o)}function a(e){for(var t=u.length-1;t>=0;t--){var n=u[t];n.handle===e&&(n.end(!0),u.splice(t,1))}}function o(){u.forEach(function(e){e.end(!0)}),u.length=0}function s(){c=r()}var u=[],c=0;return{add:i,remove:a,destroy:o,resetTimer:s}}var n=e("./createListener"),r=e("./now");return t}),define("app/trial/stimulus/getMedia",[],function(){function e(e){var t,n=e.html||e.inlineTemplate||e.template;return e.word?(t=document.createElement("div"),t.textContent=e.word,Promise.resolve(t)):e.image?new Promise(function(n,r){t=document.createElement("img"),t.onload=function(){n(t)},t.onerror=function(){r(new Error("Image not found: "+t.src))},t.src=e.image}):(e.jquery&&Promise.reject(new Error("Jquery is no longer supported in minno-time")),n?(t=document.createElement("div"),t.innerHTML=n,Promise.resolve(t)):Promise.reject(new Error("Unrecognized media type")))}return e}),define("app/trial/stimulus/setSize",[],function(){function e(e,n){var r=e.style,i=n.size||{};return i.font_size&&(r.fontSize=i.font_size),t("height",i)&&!n.media.word&&(r.height=i.height+"%"),t("width",i)&&(r.width=i.width+"%"),e}function t(e,t){return e in t}return e}),define("app/trial/stimulus/setPlace",[],function(){function e(e,t){function n(e){return!isNaN(+e)}function r(t){n(i[t])&&(e.style[t]=i[t]+"%")}var i=t.location||{};("center"==i.top||"center"==i.bottom||void 0===i.top&&void 0===i.bottom)&&e.classList.add("minno-stimulus-center-y"),("center"==i.left||"center"==i.right||void 0===i.left&&void 0===i.right)&&e.classList.add("minno-stimulus-center-x"),["top","bottom","left","right"].forEach(r)}return e}),define("app/trial/stimulus/Stimulus",["require","utils/fastdom","./getMedia","./setSize","./setPlace","utils/css"],function(e){function t(e,t,r){var c={el:null,source:e,trial:t,canvas:r,init:n,show:i,hide:a,name:s,mediaName:u,destroy:o};return c.data=e.data||{},c.handle=c.data.handle=c.data.handle||e.handle||e.set,c}function n(){if(!this.source.media)throw new Error("Media object not defined for "+this.name());return d(this.source.media).then(r.bind(this,this.canvas))}function r(e,t){var n=this;return this.el=t,new Promise(function(r){l.mutate(function(){t.classList.add("minno-stimulus"),t.setAttribute("data-handle",n.handle),f(t,n.source),p(t,n.source),h(t,n.source.css||{}),n.source.isLayout&&t.classList.add("minno-stimulus-visible"),e.appendChild(t),r(t)})})}function i(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");l.mutate(function(){e.classList.add("minno-stimulus-visible")})}function a(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");l.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function o(){var e=this.el,t=this.canvas;l.mutate(function(){t.removeChild(e)})}function s(){var e=this.source;return e.alias?e.alias:this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle?this.handle:void 0}function u(e){var t=this.source.media,n=e&&e.fullpath;if(t.alias)return t.alias;for(var r in t){if(c(["image","template"],r))return n?t[r]:t[r].replace(/^.*[\\\/]/,"");if(c(["word","html","inlineTemplate"],r)&&t[r])return t[r]}}function c(e,t){return-1!=e.indexOf(t)}var l=e("utils/fastdom"),d=e("./getMedia"),f=e("./setSize"),p=e("./setPlace"),h=e("utils/css");return t}),define("app/trial/stimulus/stimulusCollection",["require","./Stimulus"],function(e){function t(e,t){function o(n){return a(n,e,t)}function s(e){return e.isLayout=!0,e}var u=e._source,c=u.stimuli.map(o),l=u.layout.map(s).map(o),d=Promise.all(c.concat(l).map(function(e){return e.init()})),f={canvas:t,stimuli:c,layout:l,ready:d,getStimlist:n,getMedialist:r,destroy:i};return f}function n(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function r(e){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(t,n){return t.mediaName(e)||"media"+n})}function i(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}var a=e("./Stimulus");return t}),define("app/trial/evaluate",["require","underscore","app/global"],function(e){var t=e("underscore"),n=e("app/global");return function(e,r,i){function a(e){return i.stimulusCollection.stimuli.some(function(t){var n=t.data;for(var r in e)if(e[r]!==n[r])return!1;return!0})}var o=n(),s=o.current||{};if(!e)throw new Error("There is an interaction without conditions!!");e=Array.isArray(e)?e:[e],r=r||{};var u=!0;return"begin"==r.type&&e.every(function(e){return"begin"!=e.type})?!1:(e.forEach(function(e){var n,c=!0;switch(e.type){case"begin":"begin"!==r.type&&(c=!1);break;case"inputEquals":t.isArray(e.value)||(e.value=[e.value]),-1===t.indexOf(e.value,r.handle)&&(c=!1);break;case"inputEqualsTrial":r.handle!==i.data[e.property]&&(c=!1);break;case"inputEqualsStim":n={},e.handle&&(n.handle=e.handle),n[e.property]=r.handle,a(n)||(c=!1);break;case"trialEquals":if("undefined"==typeof e.property||"undefined"==typeof e.value)throw new Error('trialEquals requires both "property" and "value" to be defined');e.value!==i.data[e.property]&&(c=!1);break;case"inputEqualsGlobal":if("undefined"==typeof e.property)throw new Error('inputEqualsGlobal requires "property" to be defined');r.handle!==o[e.property]&&(c=!1);break;case"globalEquals":if("undefined"==typeof e.property||"undefined"==typeof e.value)throw new Error('globalEquals requires both "property" and "value" to be defined');e.value!==o[e.property]&&(c=!1);break;case"globalEqualsTrial":if("undefined"==typeof e.globalProp||"undefined"==typeof e.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');o[e.globalProp]!==i.data[e.trialProp]&&(c=!1);break;case"globalEqualsStim":if("undefined"==typeof e.globalProp||"undefined"==typeof e.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');n={},e.handle&&(n.handle=e.handle),n[e.stimProp]=o[e.globalProp],a(n)||(c=!1);break;case"inputEqualsCurrent":if("undefined"==typeof e.property)throw new Error('inputEqualsCurrent requires "property" to be defined');r.handle!==s[e.property]&&(c=!1);break;case"currentEquals":if("undefined"==typeof e.property||"undefined"==typeof e.value)throw new Error('currentEquals requires both "property" and "value" to be defined');e.value!==s[e.property]&&(c=!1);break;case"currentEqualsTrial":if("undefined"==typeof e.currentProp||"undefined"==typeof e.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');s[e.currentProp]!==i.data[e.trialProp]&&(c=!1);break;case"currentEqualsStim":if("undefined"==typeof e.currentProp||"undefined"==typeof e.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');n={},e.handle&&(n.handle=e.handle),n[e.stimProp]=s[e.currentProp],a(n)||(c=!1);break;case"function":e.value.apply(i,[e,r,i])||(c=!1);break;case"custom":e.fn.apply(null,[e,r,i])||(c=!1);break;default:throw new Error("Unknown condition type: "+e.type)}u=u&&(e.negate?!c:c)}),u)}}),define("app/trial/actionList",["require","underscore","utils/fastdom","app/global","../task/applyCanvasStyles"],function(e){var t=e("underscore"),n=e("utils/fastdom"),r=e("app/global"),i={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){("All"==r||e.handle==r)&&e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){("All"==r||e.handle==r)&&e.hide()})},setStimAttr:function(e,n,r){var i=e.handle,a=e.setter;r.stimulusCollection.stimuli.forEach(function(e){("All"==i||e.handle==i)&&(t.isFunction(a)?a.apply(e):t.extend(e.data,a))})},setTrialAttr:function(e,n,r){var i=e.setter;if("undefined"==typeof i)throw new Error("The setTrialAttr action requires a setter property");t.isFunction(i)?i.apply(r,[r.data,n]):t.extend(r.data,i)},setInput:function(e,t,n){if("undefined"==typeof e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if("undefined"==typeof e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(e,n,r){var i=r.input,a=e.handle;if("undefined"==typeof a)throw new Error("The removeInput action requires a handle property");"All"==a||t.include(a,"All")?i.destroy():i.remove(a)},"goto":function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(e,t,n){n.end()},resetTimer:function(e,t,r){function i(){t.latency=0,r.input.resetTimer()}e.immidiate?i():n.mutate(i)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[r(),e]);break;case"object":t.extend(r(),e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(n,r,i){var a=e("../task/applyCanvasStyles"),o=i.cavnas,s={background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:o,property:"backgroundColor"},borderColor:{element:o,property:"borderColor"},borderWidth:{element:o,property:"borderWidth"}},u=a(s,t.pick(n,["background","canvasBackground","borderColor","borderWidth"]));i.$end.map(u)}};return i}),define("app/trial/action",["require","underscore","./actionList"],function(e){function t(e,t,i){var a=!0;if(!e)throw new Error("There is an interaction without actions!!");return e=n.isArray(e)?e:[e],n.forEach(e,function(e){var n=r[e.type];if(!n)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(a=!1),n(e,t,i)}),a}var n=e("underscore"),r=e("./actionList");return t}),define("app/trial/interactions",["require","./evaluate","./action"],function(e){function t(e){function t(t){var o,s,u;for(t.trialId=e._id,t.trialCounter=e.counter,a&&console.groupCollapsed("Event: "+(t.handle||t.type),t),o=0;o<i.length&&(s=i[o],u=n(s.conditions,t,e),a&&console.log(u,s.conditions),!u||r(s.actions,t,e));o++);return a&&console.groupEnd("Event: "+(t.handle||t.type)),t}var i=e._source.interactions,a=e._source.DEBUG&&window.DEBUG;return t}var n=e("./evaluate"),r=e("./action");return t}),define("app/trial/Trial",["require","underscore","./input/input","./stimulus/stimulusCollection","./interactions","utils/stream"],function(e){function t(e,t,n){if(!e.interactions)throw new Error("Interactions not defined");this.canvas=t,this.settings=n,this._source=e,this.$logs=u(),this.$events=u(),this.$end=this.$events.end,this.data=e.data||{},this._id=r.uniqueId("trial_"),this.counter=s++,this.input=i(this.$events,this),this.stimulusCollection=a(this,t),this.$events.map(o(this)),this._next=["next",{}]}function n(e){return e?r.isArray(e)?e:[e]:[]}var r=e("underscore"),i=e("./input/input"),a=e("./stimulus/stimulusCollection"),o=e("./interactions"),s=0,u=e("utils/stream");return r.extend(t.prototype,{start:function(){var e=this;return this._source.DEBUG&&window.DEBUG&&console.group("Trial: "+this.counter),e.stimulusCollection.ready.then(function(){n(e._source.input).forEach(e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this._source.DEBUG&&window.DEBUG&&console.groupEnd("Trial: "+this.counter),this.input.destroy(),this.$events.end(!0),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:r.isString(this._source.inherit)?this._source.inherit:r.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),t}),define("app/sequencer/nextTrial",["require","underscore","../global","../task/build_url"],function(e){function t(e,t){function a(t,r,a){var o=t[r];return n.isUndefined(o)?!1:(n.isString(o)&&(o={word:o}),o=e.inflate("media",o,a),o.image&&(o.image=i(o.image,"image")),o.template&&(o.inlineTemplate=requirejs("text!"+i(o.template,"template")),o.inlineTemplate=n.template(o.inlineTemplate)(a)),t[r]=o,a.mediaData=null,void(a.mediaMeta=null))}function o(t){var n=this;return t=e.inflate("stimulus",t,n,{skip:["media","touchMedia"]}),a(t,"media",n),a(t,"touchMedia",n),n.stimulusData=null,n.stimulusMeta=null,t}var s,u=t[0],c=t[1],l=e.currentSequence,d=r(),f={global:d,current:d.current};return l.go(u,c,f),(s=l.current(f,{skip:["layout","stimuli"]}))?(s.stimuli=n.map(s.stimuli||[],o,f),s.layout=n.map(s.layout||[],o,f),f.trialData=null,{value:s}):{done:!0}}var n=e("underscore"),r=e("../global"),i=e("../task/build_url");return t}),define("utils/post",[],function(){function e(e,n){return new Promise(function(r,i){var a=new XMLHttpRequest;a.open("POST",e,!0),a.setRequestHeader("Content-Type","application/json; charset=UTF-8"),a.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?r(this.responseText):i(new Error("Failed posting to: "+e)))},a.send(t(n))})}function t(e){return"string"==typeof e?e:JSON.stringify(e)}return e}),define("app/task/logger/poster",["require","underscore","utils/post"],function(e){function t(e,t){function i(e){u.push(e),t.pulse&&u.length>=t.pulse&&(o(u),u.length=0)}function a(){u.length&&o(u)}function o(e){var i={json:JSON.stringify(e)},a=n.assign(i,t.metaData),o=s(a);return r(c,o)["catch"](function(){return r(c,o)})["catch"](t.error||n.noop)}function s(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")}var u=[],c=t.url;c&&(e.map(i),e.end.map(a))}var n=e("underscore"),r=e("utils/post");return t}),define("app/task/logger/transformLogs",["require","underscore","app/global"],function(e){function t(e,t,i){var a=i.data,o=t,s=r().current.logs,u=n.get(i,"settings.logger.fullpath",!1),c=i.stimulusCollection.getStimlist(),l=i.stimulusCollection.getMedialist({fullpath:u});return{log_serial:s.length,trial_id:i.counter,name:i.name(),responseHandle:o.handle,latency:Math.floor(o.latency),stimuli:c,media:l,data:a}}var n=e("underscore"),r=e("app/global");return t}),define("app/task/logger/createLogs",["require","./poster","./transformLogs","app/global"],function(e){function t(e,t){function a(e){return function(t){return e.apply(null,t)}}var o=e.map(a(t.logger||t.transformLogs||r));return o.map(function(e){i().current.logs.push(e)}),n(o,t),t.poster&&t.poster(o,t),o}var n=e("./poster"),r=e("./transformLogs"),i=e("app/global");return t}),define("app/playPhase",["require","underscore","app/trial/Trial","./sequencer/nextTrial","utils/stream","utils/fastdom","./task/logger/createLogs"],function(e){function t(e,t,u){function c(){var e=p();e&&e.stimulusCollection.destroy()}function l(e){var n=i(t,e);n.done?f.end(!0):f(n.value)}function d(t){function n(n){var i=t,a=t=new r(n,e,u.settings);return a.$logs.map(h),a.$end.map(function(){l(a._next)}),a.start(),i&&o.mutate(function(){i.stimulusCollection.destroy()}),a}return n}var f=a(),p=f.map(d()),h=a(),m=n.get(u,"settings.hooks.endTask",u.settings.onEnd||n.noop);return f.end.map(c).map(m),{$trial:p,end:f.end,$logs:s(h,u.settings.logger||{}),play:l}}var n=e("underscore"),r=e("app/trial/Trial"),i=e("./sequencer/nextTrial"),a=e("utils/stream"),o=e("utils/fastdom"),s=e("./task/logger/createLogs");return t}),define("activatePIP",["require","utils/polyfills","underscore","app/task/script","app/global","app/task/parser","app/task/canvasSetup","app/preloadPhase","app/playPhase"],function(e){function t(e,t){var r=s(e,t),i=o(t),a=c(e,i,t);return n(t),a.end.map(function(){r.end(!0)}),u(e,t).then(a.play.bind(null,["next",{}])),a}function n(e){var t=a(a()),n=e.name||"anonymous minno-time",o=r.isPlainObject(e.current)?e.current:{};o.logs||(o.logs=[]),t[n]=t.current=o,i(e)}e("utils/polyfills");var r=e("underscore"),i=e("app/task/script"),a=e("app/global"),o=e("app/task/parser"),s=e("app/task/canvasSetup"),u=e("app/preloadPhase"),c=e("app/playPhase");return t}),define("pipScorer/computeD",["require","underscore"],function(e){function t(){n.assign(this,{dataArray:{},AnalyzedVar:"latency",ErrorVar:"error",condVar:"",cond1VarValues:[],cond2VarValues:[],parcelVar:"",parcelValue:[],fastRT:300,maxFastTrialsRate:.1,minRT:400,maxRT:1e4,maxErrorParcelRate:.4,errorLatency:{use:"latency",penalty:600,useForSTD:!0},postSettings:{}})}var n=e("underscore");return n.assign(t.prototype,{setComputeObject:function(e){n.assign(this,e)},setDataArray:function(){var e=window.piGlobal;this.dataArray=e.current.logs}}),t}),define("pipScorer/msgMan",["require","underscore"],function(e){function t(){this.messages=n.extend({},r)}var n=e("underscore"),r={MessageDef:[],manyErrors:"There were too many errors made to determine a result.",tooFast:"There were too many fast trials to determine a result.",notEnough:"There were not enough trials to determine a result."};return n.extend(t.prototype,{setMsgObject:function(e){n.extend(this.messages,e)},getScoreMsg:function(e){var t=this.messages.MessageDef;if(Array.isArray(t)||!t.length)throw new Error('You must define a "MessageDef" array.');var r=parseFloat(e),i=null,a=null,o="error: msg was not set",s=!1;if(n.each(t,function(e){i=parseFloat(e.cut),a=e.message,i>=r&&!s&&(o=a,s=!0)}),!s){var u=t.length,c=t[u-1];o=c.message}return o},getMessage:function(e){return this.messages[e]}}),t}),define("pipScorer/parcelMng",["require","underscore"],function(e){function t(e){this.parcelArray=[],this.scoreData={},this.msgMan=e}var n=e("underscore");return n.extend(t.prototype,{Init:function(e){var t=this,r=this.msgMan,i=window.piGlobal,a=i.current.logs;t.parcelArray=[],t.scoreData={},t.msgMan=r;var o=e.AnalyzedVar,s=e.ErrorVar,u=e.parcelVar,c=e.parcelValue,l=e.minRT,d=e.maxRT,f=e.fastRT,p=0,h=0,m=0,g=0,v=parseFloat(e.maxFastTrialsRate);if("undefined"==typeof c||0===c.length){m=0,p=0,h=0,g=0;var y={};y.name="general",y.trialIData=[],n.each(a,function(n){n[o]>=l&&n[o]<=d?(m++,1==n.data[s]&&g++,t.validate(y,n,e)&&p++):n[o]<=f&&h++}),t.checkErrors(m,g,e),t.parcelArray[0]=y}else n.each(c,function(r,i){m=0,p=0,h=0,g=0;var c={};c.name=r,c.trialIData=[],n.each(a,function(n){var i=n.data[u];i==r&&(n[o]>=l&&n[o]<=d?(m++,1==n.data[s]&&g++,t.validate(c,n,e)&&p++):n[o]<=f&&h++)}),t.checkErrors(m,g,e),t.parcelArray[i]=c});h/p>v&&(t.scoreData.errorMessage=this.msgMan.getMessage("tooFast"))},checkErrors:function(e,t,n){var r=n.maxErrorParcelRate;t/e>r&&(this.scoreData.errorMessage=this.msgMan.getMessage("manyErrors"))},validate:function(e,t,n){var r=n.errorLatency,i=n.ErrorVar,a=t.data;return"latency"==r.use?(e.trialIData.push(t),!0):"false"==r.use?"1"==a[i]?!1:(e.trialIData.push(t),!0):"penalty"==r.use?(e.trialIData.push(t),!0):void 0},addPenalty:function(e,t){var r=t.errorLatency,i=this;if("penalty"==r.use){var a=parseFloat(r.penalty),o=t.ErrorVar,s=t.AnalyzedVar,u=t.condVar,c=t.cond1VarValues,l=t.cond2VarValues,d=e.trialIData,f=e.avgCon1,p=e.avgCon2;n.each(d,function(e){var t=e.data,n=t[o],r=t[u],d=i.checkArray(r,c),h=i.checkArray(r,l);"1"==n&&(d?e[s]+=f+a:h&&(e[s]+=p+a))})}},avgAll:function(e){var t=this;n.each(t.parcelArray,function(n){t.avgParcel(n,e)})},avgParcel:function(e,t){var r=this,i=e.trialIData,a=t.condVar,o=t.cond1VarValues,s=t.cond2VarValues,u=t.AnalyzedVar,c=0,l=0,d=0,f=0,p=0,h=0;n.each(i,function(e){var t=e[u],n=e.data;d+=t,h++;var i=n[a],m=r.checkArray(i,o),g=r.checkArray(i,s);m?(f++,c+=t):g&&(p++,l+=t)}),(2>=f||2>=p)&&(r.scoreData.errorMessage=this.msgMan.getMessage("notEnough")),0!==f&&(c/=f),0!==p&&(l/=p),e.avgCon1=c,e.avgCon2=l,e.diff=e.avgCon1-e.avgCon2,0!==h&&(e.avgBoth=d/h),r.addPenalty(e,t)},checkArray:function(e,t){for(var n=0;n<t.length;n++){var r=t[n];if(r==e)return!0}return!1},varianceAll:function(e){var t=this;n.each(t.parcelArray,function(n){t.varianceParcel(n,e)})},varianceParcel:function(e,t){var r=this,i=t.AnalyzedVar,a=e.trialIData,o=t.cond1VarValues,s=t.cond2VarValues,u=t.condVar,c=e.avgBoth,l=0,d=0,f=[],p=[],h=[],m=t.errorLatency,g=m.useForSTD;n.each(a,function(e){var n=e.data,a=e[i],c=t.ErrorVar,l=n[c],d=n[u],h=r.checkArray(d,o),m=r.checkArray(d,s);h?g?f.push(a):"0"==l&&f.push(a):m&&(g?p.push(a):"0"==l&&f.push(a))}),h=f.concat(p),n.each(h,function(e){var t=e;l=t-c,d+=l*l}),e.variance=d/(h.length-1)},scoreAll:function(e){var t=this,r=0;n.each(t.parcelArray,function(n){t.scoreParcel(n,e),r+=n.score});var i=r/t.parcelArray.length;t.scoreData.score=i.toFixed(2)},scoreParcel:function(e){var t=this,n=Math.sqrt(e.variance);0===n?(t.scoreData.errorMessage=this.msgMan.getMessage("notEnough"),e.score=e.diff):e.score=e.diff/n}}),t}),define("pipScorer/Scorer",["require","./computeD","./msgMan","./parcelMng","underscore","utils/post"],function(e){function t(){this.computeData=new n,this.msgMan=new r,this.parcelMng=new i(this.msgMan)}var n=e("./computeD"),r=e("./msgMan"),i=e("./parcelMng"),a=e("underscore"),o=e("utils/post");return a.assign(t.prototype,{addSettings:function(e,t){switch(e){case"compute":this.computeData.setComputeObject(t);break;case"message":this.msgMan.setMsgObject(t);break;default:throw new Error('SCORER:addSettings: unknow "type" '+e)}},computeD:function(){var e=this.computeData,t=this.parcelMng;e.setDataArray(),t.Init(e),t.avgAll(e),t.varianceAll(e),t.scoreAll(e);var n=t.scoreData;return void 0===n.errorMessage||null===n.errorMessage?{FBMsg:this.getFBMsg(n.score),DScore:n.score,error:!1}:{FBMsg:n.errorMessage,DScore:"",error:!0}},postToServer:function(e,t,n,r){var i=this.computeData.postSettings||{},a=i.url,s={};return n||(n=i.score),r||(r=i.msg),s[n]=e,s[r]=t,o(a,JSON.stringify(s))},dynamicPost:function(e){var t=this.computeData.postSettings||{},n=t.url;return o(n,JSON.stringify(e))},getFBMsg:function(e){var t=this.msgMan.getScoreMsg(e);return t}}),t}),define("pipScorer",["pipScorer/Scorer"],function(e){return e}),define("pipAPI",["require","underscore","utils/post"],function(e){function t(e){this.script={global:{},current:{},trialSets:[],stimulusSets:[],mediaSets:[],sequence:[]},this.script.name=e||"anonymous PIP",this.settings=this.script.settings={canvas:{maxWidth:800,proportions:.8},hooks:{}}}function n(e){function t(t,n){var i,a=this.script[e+"Sets"]||(this.script[e+"Sets"]=[]);r.isPlainObject(t)&&(i=r(t).map(function(e,t){return r.each(e,function(e){e.set=t}),e}).flatten().value()),r.isArray(t)&&(i=t),r.isString(t)&&(i=r.isArray(n)?n:[n],i=r.map(i,function(e){return e.set=t,e})),a.push.apply(a,i)}return t}var r=e("underscore"),i=e("utils/post");return r.extend(t.prototype,{addTrialSets:n("trial"),addStimulusSets:n("stimulus"),addMediaSets:n("media"),addSettings:function(e,t){var n;return r.isPlainObject(t)?(n=this.settings[e]=this.settings[e]||{},r.extend(n,t)):this.settings[e]=t,this},addSequence:function(e){var t=this.script;return r.isArray(e)||(e=[e]),t.sequence=t.sequence.concat(e),this},addGlobal:function(e){if(!r.isPlainObject(e))throw new Error("global must be an object");r.merge(this.getGlobal(),e)},getGlobal:function(){return window.piGlobal},addCurrent:function(e){if(!r.isPlainObject(e))throw new Error("current must be an object");r.merge(this.script.current,e)},getCurrent:function(){return this.script.current},addScript:function(e){r.merge(this.script,e)},getScript:function(){return this.script},getLogs:function(){return this.script.current.logs},play:function(){throw new Error("you should return API.script instead of calling API.play()!!")},post:i,shuffle:function(e){return r.shuffle(e)}}),t});