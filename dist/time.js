!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(e,t){"use strict";function n(){console.log.apply(console,arguments)}function r(e){return e&&(R=e),R}function i(t,n){return n?H=t:(e.isPlainObject(t)&&(e.each(function(e,t){console.warn&&i[t]&&console.warn('Overwriting "'+t+'" in global object.')}),e.merge(H,t)),H)}function o(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":case"previousWhere":a("next",t,n,r);break;case"current":break;case"first":do{r.prev(n)}while(r.current(n));break;case"last":do{r.next(n)}while(r.current(n));r.prev();break;case"end":do{r.next(n)}while(r.current(n));break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function a(t,n,r,i){var o;do{i[t](),o=i.current(r)}while(o&&!e.callback(n)(o.data))}function s(e){return parseFloat(e,10)||0}function u(t,n){function r(){var r=function(t,n){var r=function(t){if(e.isPlainObject(t.proportions)){if("number"!=typeof t.proportions.height||"number"!=typeof t.proportions.width)throw new Error("The canvas proportions object`s height and a width properties must be numeric");return t.proportions.height/t.proportions.width}return t.proportions||.8}(t);if(t.width)return{width:t.width,height:t.width*r};var i=window.document.documentElement,o=i.clientHeight,a=Math.min(t.maxWidth,i.clientWidth,function(e){var t=window.getComputedStyle(e);return{height:s(e.offsetHeight)-s(t.borderTopWidth)-s(t.borderBottomWidth),width:s(e.offsetWidth)-s(t.borderLeftWidth)-s(t.borderRightWidth)}}(n.parentNode).width);return o>r*a?{height:a*r,width:a}:{height:o,width:o/r}}(n,t),i=window.getComputedStyle(t);r.height-=c(i.borderTopWidth)+c(i.borderBottomWidth)+c(i.marginTop),r.width-=c(i.borderLeftWidth)+c(i.borderRightWidth),t.style.width=r.width+"px",t.style.height=r.height+"px",t.style.fontSize=r.height*(n.textSize||3)/100+"px",window.scrollTo(0,1)}return e.throttle(function(e){"orientationchange"==e.type?setTimeout(r,500):r()},16)}function c(e){return parseFloat(e,10)||0}function l(t,n){var r;if(!e.isPlainObject(t))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(e.isUndefined(n))return e.noop;if(!e.isPlainObject(n))throw new Error("canvas(settings): canvas settings must be an object");return r=e.map(n,function(e,n){var r=t[n];if(r)return function(e,t,n){var r=e.style[t];return e.style[t]=n,function(){e.style[t]=r}}(r.element,r.property,e);throw new Error("canvas("+n+"): unknow key in canvas object.")}),function(){e.forEach(r,function(e){e.call()})}}function d(e,t){return t={exports:{}},e(t,t.exports),t.exports}function f(t,n){var i,o=function(e){var t=r().settings||{};return e?t[e]:t}();return e.isString(o.base_url)?i=o.base_url:e.isObject(o.base_url)&&(i=o.base_url[n]),"image"==n&&/^data:image/.test(t)?t:(i?"/"!=i[i.length-1]&&(i+="/"):i="",i+t)}function h(t){e.isUndefined(t.image)||ee.load(f(t.image,"image"),"image"),e.isUndefined(t.template)||ee.load(f(t.template,"template"),"template")}function p(e){e.media&&h(e.media)}function m(e){e.element&&h(e.element)}function v(t){e.each(t.layout||[],p),e.each(t.stimuli||[],p),e.each(t.input||[],m)}function w(t){e.each(t,function(t){e.isUndefined(t.mixer)?v(t):w(t.data)})}function g(t,n,r){switch(r&&ee.reset(),n){case"media":h(t);break;case"stimulus":p(t);break;case"trial":v(t);break;case"script":default:!function(t){e.each(t.mediaSets||[],h),e.each(t.stimulusSets||[],p),e.each(t.trialSets||[],v),w(t.sequence)}(t)}return ee}function y(e,t,n,r){var i=n.element;return i&&(X(i,n.css),te.mutate(function(){r.appendChild(i)})),r.addEventListener(e,function(e){var r=e.target;return i&&r===i?t(e):i||r.getAttribute("data-handle")!==n.stimHandle?void 0:t(e)}),t.end.map(function(){i&&r.removeChild(i),r.removeEventListener(e,t)}),t}function b(e,t){function n(t){ne[t.which]||-1===r.indexOf(t.which)||(t.preventDefault(),ne[t.which]=!0,e(t))}var r=(Array.isArray(t.key)?t.key:[t.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",n),e.end.map(function(){document.removeEventListener("keydown",n)}),e}function E(t,n){var r,i=function(t,n){if(e.isArray(t))return t[Math.floor(Math.random()*t.length)];if(e.isFunction(t))return t.call(n);if(e.isPlainObject(t)){if(!e.isNumber(t.min)||!e.isNumber(t.max)||t.min>t.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return t.min+(t.max-t.min)*Math.random()}return t}(n.duration)||0;return t.end.map(function(){clearTimeout(r)}),i?setTimeout(t.bind(null,{}),i):t({}),t}function k(t,n,r){function i(e,t){var n=document.createElement("div");return X(n,t),X(n,e),n}var o=n.on;switch(o){case"keypressed":return b(t,n);case"keyup":return function(e,t){var n=(Array.isArray(t.key)?t.key:[t.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",function(t){if(-1!==n.indexOf(t.which))return t.preventDefault(),e(t)}),e.end.map(function(){document.removeEventListener("keyup",e)}),e}(t,n);case"click":case"mousedown":return y("mousedown",t,n,r);case"mouseup":return y("mouseup",t,n);case"mouseenter":return y("mouseenter",t,n);case"mouseleave":return y("mouseleave",t,n);case"timeout":return E(t,n);case"enter":return b(t,e.assign({key:13},n));case"space":return b(t,e.assign({key:32},n));case"esc":return b(t,e.assign({key:27},n));case"leftTouch":return n.element=i(n.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),y("mousedown",t,n);case"rightTouch":return n.element=i(n.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),y("mousedown",t,n);case"topTouch":return n.element=i(n.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),y("mousedown",t,n);case"bottomTouch":return n.element=i(n.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),y("mousedown",t,n);default:throw new Error('You have an input element without a recognized "on" property: '+o)}}function _(t,n){var r=Y();if(r.handle=t.handle,e.isFunction(t)){if(r=t(r,t,n),function(e){return e._state}(r))return r;throw new Error("Input functions must return valid streams")}if(!e.isPlainObject(t))throw new Error("Input must only contain objects and functions, do you have an undefined value?");return e.isString(t.on)?k(r,t,n):(e.isFunction(t.on)&&t.on(r,t,n),e.isFunction(t.off)&&r.end.map(t.off),r)}function q(e,t){return e in t}function T(e,t){var n=t.location||{};("center"==n.top||"center"==n.bottom||void 0===n.top&&void 0===n.bottom)&&e.classList.add(ie),("center"==n.left||"center"==n.right||void 0===n.left&&void 0===n.right)&&e.classList.add(oe),["top","bottom","left","right"].forEach(function(t){(function(e){return!isNaN(+e)})(n[t])&&(e.style[t]=n[t]+"%")})}function P(){if(!this.source.media)throw new Error("Media object not defined for "+this.name());return function(e){var t,n=e.html||e.inlineTemplate||e.template;return e.word?(t=document.createElement("div"),t.textContent=e.word,Promise.resolve(t)):e.image?new Promise(function(n,r){(t=document.createElement("img")).onload=function(){n(t)},t.onerror=function(){r(new Error("Image not found: "+t.src))},t.src=e.image}):(e.jquery&&Promise.reject(new Error("Jquery is no longer supported in minno-time")),n?(t=document.createElement("div"),t.innerHTML=n,Promise.resolve(t)):Promise.reject(new Error("Unrecognized media type")))}(this.source.media).then(function(e,t){var n=this;return this.el=t,new Promise(function(r){te.mutate(function(){t.classList.add("minno-stimulus"),t.setAttribute("data-handle",n.handle),function(e,t){var n=e.style,r=t.size||{};r.font_size&&(n.fontSize=r.font_size),q("height",r)&&!t.media.word&&(n.height=r.height+"%"),q("width",r)&&(n.width=r.width+"%")}(t,n.source),T(t,n.source),X(t,n.source.css||{}),n.source.isLayout&&t.classList.add("minno-stimulus-visible"),e.appendChild(t),document.documentMode?function(e,t){var n=e.style,r=e.classList.contains(oe),i=e.classList.contains(ie);if(!r&&!i)return t(e);te.measure(function(){var t=window.getComputedStyle(e),o=parseFloat(t.width),a=parseFloat(t.height);te.mutate(function(){n.transform="none",r&&(n.marginLeft="-"+o/2+"px"),i&&(n.marginTop="-"+a/2+"px")})})}(t,r):r(t)})})}.bind(this,this.canvas))}function x(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");te.mutate(function(){e.classList.add("minno-stimulus-visible")})}function C(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");te.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function A(){var e=this.el,t=this.canvas;te.mutate(function(){t.removeChild(e)})}function S(){var e=this.source;return e.alias?e.alias:this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle?this.handle:void 0}function j(e){var t=this.source.media,n=e&&e.fullpath;if(t.alias)return t.alias;for(var r in t){if(F(["image","template"],r))return n?t[r]:t[r].replace(/^.*[\\/]/,"");if(F(["word","html","inlineTemplate"],r)&&t[r])return t[r]}}function F(e,t){return-1!=e.indexOf(t)}function L(e,t){function n(n){return function(e,t,n){var r={el:null,source:e,trial:t,canvas:n,init:P,show:x,hide:C,name:S,mediaName:j,destroy:A};return r.data=e.data||{},r.handle=r.data.handle=r.data.handle||e.handle||e.set,r}(n,e,t)}var r=e._source,i=r.stimuli.map(n),o=r.layout.map(function(e){return e.isLayout=!0,e}).map(n),a=Promise.all(i.concat(o).map(function(e){return e.init()}));return{canvas:t,stimuli:i,layout:o,ready:a,getStimlist:O,getMedialist:D,destroy:U}}function O(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function D(e){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(t,n){return t.mediaName(e)||"media"+n})}function U(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function M(t,n,r){function o(e){return r.stimulusCollection.stimuli.some(function(t){var n=t.data;for(var r in e)if(e[r]!==n[r])return!1;return!0})}var a=i(),s=a.current||{};if(!t)throw new Error("There is an interaction without conditions!!");t=Array.isArray(t)?t:[t];var u=!0;return("begin"!=(n=n||{}).type||!t.every(function(e){return"begin"!=e.type}))&&(t.forEach(function(t){var i,c=!0;switch(t.type){case"begin":"begin"!==n.type&&(c=!1);break;case"inputEquals":e.isArray(t.value)||(t.value=[t.value]),-1===e.indexOf(t.value,n.handle)&&(c=!1);break;case"inputEqualsTrial":n.handle!==r.data[t.property]&&(c=!1);break;case"inputEqualsStim":i={},t.handle&&(i.handle=t.handle),i[t.property]=n.handle,o(i)||(c=!1);break;case"trialEquals":if(void 0===t.property||void 0===t.value)throw new Error('trialEquals requires both "property" and "value" to be defined');t.value!==r.data[t.property]&&(c=!1);break;case"inputEqualsGlobal":if(void 0===t.property)throw new Error('inputEqualsGlobal requires "property" to be defined');n.handle!==a[t.property]&&(c=!1);break;case"globalEquals":if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');t.value!==a[t.property]&&(c=!1);break;case"globalEqualsTrial":if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');a[t.globalProp]!==r.data[t.trialProp]&&(c=!1);break;case"globalEqualsStim":if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');i={},t.handle&&(i.handle=t.handle),i[t.stimProp]=a[t.globalProp],o(i)||(c=!1);break;case"inputEqualsCurrent":if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');n.handle!==s[t.property]&&(c=!1);break;case"currentEquals":if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');t.value!==s[t.property]&&(c=!1);break;case"currentEqualsTrial":if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');s[t.currentProp]!==r.data[t.trialProp]&&(c=!1);break;case"currentEqualsStim":if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');i={},t.handle&&(i.handle=t.handle),i[t.stimProp]=s[t.currentProp],o(i)||(c=!1);break;case"function":t.value.apply(r,[t,n,r])||(c=!1);break;case"custom":t.fn.apply(null,[t,n,r])||(c=!1);break;default:throw new Error("Unknown condition type: "+t.type)}u=u&&(t.negate?!c:c)}),u)}function W(t,n,r){var i=!0;if(!t)throw new Error("There is an interaction without actions!!");return t=e.isArray(t)?t:[t],e.forEach(t,function(e){var t=ae[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(i=!1),t(e,n,r)}),i}function z(t,n,r){if(!t.interactions)throw new Error("Interactions not defined");this.canvas=n,this.settings=r,this._source=t,this.$logs=Y(),this.$events=Y(),this.$end=this.$events.end,this.data=t.data||{},this._id=e.uniqueId("trial_"),this.counter=se++,this.input=function(e,t){var n=[],r=0;return{add:function(i){if(!i)throw new Error("Missing input element. Could not add input listener");var o=_(i,t.canvas);o.map(function(e){return{handle:i.handle,event:e,trialId:t._id,counter:t.counter,timestamp:+new Date,latency:re()-r}}).map(e),n.push(o)},remove:function(e){for(var t=n.length-1;t>=0;t--){var r=n[t];r.handle===e&&(r.end(!0),n.splice(t,1))}},destroy:function(){n.forEach(function(e){e.end(!0)}),n.length=0},resetTimer:function(){r=re()}}}(this.$events,this),this.stimulusCollection=L(this,n),this.$events.map(function(e){var t=e._source.interactions,n=e._source.DEBUG&&window.DEBUG;return function(r){var i,o,a;for(n&&console.groupCollapsed("Event: "+(r.handle||r.type),r),i=0;i<t.length&&(o=t[i],a=M(o.conditions,r,e),n&&console.log(a,o.conditions),!a||W(o.actions,r,e));i++);return n&&console.groupEnd("Event: "+(r.handle||r.type)),r}}(this)),this._next=["next",{}]}function I(e,t){return new Promise(function(n,r){var i=new XMLHttpRequest;i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?n(this.responseText):r(new Error("Failed posting to: "+e)))},i.send(function(e){return"string"==typeof e?e:JSON.stringify(e)}(t))})}function $(t,n){function r(t){var r={json:JSON.stringify(t)},i=function(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")}(e.assign(r,n.metaData));return I(o,i).catch(function(){return I(o,i)}).catch(n.error||e.noop)}var i=[],o=n.url;o&&(t.map(function(e){i.push(e),n.pulse&&i.length>=n.pulse&&(r(i),i.length=0)}),t.end.map(function(){i.length&&r(i)}))}function N(t,n){var r=t.map(function(e){return function(t){return e.apply(null,t)}}(n.logger||n.transformLogs||function(t,n,r){var i=window.piGlobal,o=r.data,a=n,s=i.current.logs,u=e.get(r,"settings.logger.fullpath",!1),c=r.stimulusCollection.getStimlist(),l=r.stimulusCollection.getMedialist({fullpath:u});return{log_serial:s.length,trial_id:r.counter,name:r.name(),responseHandle:a.handle,latency:Math.floor(a.latency),stimuli:c,media:l,data:o}}));return r.map(function(e){i().current.logs.push(e)}),$(r,n),n.poster&&n.poster(r,n),r}function B(t,n,r){function o(t){var r=function(t,n){function r(n,r,i){var o=n[r];if(e.isUndefined(o))return!1;e.isString(o)&&(o={word:o}),(o=t.inflate("media",o,i)).image&&(o.image=f(o.image,"image")),o.template&&(o.inlineTemplate=requirejs("text!"+f(o.template,"template")),o.inlineTemplate=e.template(o.inlineTemplate)(i)),n[r]=o,i.mediaData=null,i.mediaMeta=null}function o(e){return e=t.inflate("stimulus",e,this,{skip:["media","touchMedia"]}),r(e,"media",this),r(e,"touchMedia",this),this.stimulusData=null,this.stimulusMeta=null,e}var a,s=n[0],u=n[1],c=t.currentSequence,l=i(),d={global:l,current:l.current};return c.go(s,u,d),(a=c.current(d,{skip:["layout","stimuli"]}))?(a.stimuli=e.map(a.stimuli||[],o,d),a.layout=e.map(a.layout||[],o,d),d.trialData=null,{value:a}):{done:!0}}(n,t);r.done?a.end(!0):a(r.value)}var a=Y(),s=a.map(function(e){return function(n){var i=e,a=e=new z(n,t,r.settings);return a.$logs.map(u),a.$end.map(function(){o(a._next)}),a.start(),i&&te.mutate(function(){i.stimulusCollection.destroy()}),a}}()),u=Y(),c=e.get(r,"settings.hooks.endTask",r.settings.onEnd||e.noop);return a.end.map(function(){var e=s();e&&e.stimulusCollection.destroy()}).map(c),{$trial:s,end:a.end,$logs:N(u,r.settings.logger||{}),play:o}}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,Date.now||(Date.now=function(){return(new Date).getTime()}),console.group||(console.group=n),console.groupCollapsed||(console.groupCollapsed=n),console.groupEnd||(console.groupEnd=n),console.table||(console.table=n),function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout}}();var G=function(e){function t(e,t){return function a(l){var d;try{if(!t||null==l||"object"!=typeof l&&"function"!=typeof l||"function"!=typeof(d=l.then))c(function(){t||0!==e.length||console.error("Possible unhandled promise rejection:",l);for(var n=0;n<e.length;n++)e[n](l);i.length=0,o.length=0,u.state=t,u.retry=function(){a(l)}});else{if(l===r)throw new TypeError("Promise can't be resolved w/ itself");n(d.bind(l))}}catch(e){s(e)}}}function n(e){function t(e){return function(t){n++>0||e(t)}}var n=0,r=t(s);try{e(t(a),r)}catch(e){r(e)}}if(!(this instanceof G))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var r=this,i=[],o=[],a=t(i,!0),s=t(o,!1),u=r._instance={resolvers:i,rejectors:o},c="function"==typeof setImmediate?setImmediate:setTimeout;n(e)};G.prototype.then=function(e,t){function n(e,t,n,a){t.push(function(t){if("function"!=typeof e)n(t);else try{r(e(t))}catch(e){i&&i(e)}}),"function"==typeof o.retry&&a===o.state&&o.retry()}var r,i,o=this._instance,a=new G(function(e,t){r=e,i=t});return n(e,o.resolvers,r,!0),n(t,o.rejectors,i,!1),a},G.prototype.catch=function(e){return this.then(null,e)},G.resolve=function(e){return e instanceof G?e:new G(function(t){t(e)})},G.reject=function(e){return new G(function(t,n){n(e)})},G.all=function(e){return new G(function(t,n){var r=e.length,i=0,o=[];if(0===e.length)t([]);else for(var a=0;a<e.length;a++)!function(a){function s(e){i++,o[a]=e,i===r&&t(o)}null==e[a]||"object"!=typeof e[a]&&"function"!=typeof e[a]||"function"!=typeof e[a].then?s(e[a]):e[a].then(s,n)}(a)})},G.race=function(e){return new G(function(t,n){for(var r=0;r<e.length;r++)e[r].then(t,n)})},void 0===window.Promise&&(window.Promise=G);var R={},H=window.piGlobal||(window.piGlobal={}),J="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},Y=d(function(e){!function(){function t(){function e(){return arguments.length>0&&arguments[0]!==w&&n(e,arguments[0]),e._state.value}return function(e){e.constructor=t,e._state={id:v++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},e.map=e["fantasy-land/map"]=u,e["fantasy-land/ap"]=c,e["fantasy-land/of"]=t,e.valueOf=l,e.toJSON=d,e.toString=l,Object.defineProperties(e,{end:{get:function(){if(!e._state.endStream){var n=t();n.map(function(t){return!0===t&&(s(e),n._state.unregister=function(){s(n)}),t}),e._state.endStream=n}return e._state.endStream}}})}(e),arguments.length>0&&arguments[0]!==w&&n(e,arguments[0]),e}function n(e,t){r(e,t);for(var n in e._state.deps)i(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),function(e){e._state.changed=!1;for(var t in e._state.deps)e._state.deps[t]._state.changed=!1}(e)}function r(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function i(e,t){var n=e._state.parents;if(n.length>0&&n.every(h)&&(t||n.some(p))){var i=e._state.derive();if(i===w)return!1;r(e,i)}}function o(e,n){if(!n.every(f))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return function(e,t,n){var r=e._state;return r.derive=n,r.parents=t.filter(m),a(e,r.parents),i(e,!0),e}(t(),n,function(){return e.apply(this,n.concat([n.filter(p)]))})}function a(e,t){for(var n=0;n<t.length;n++)t[n]._state.deps[e._state.id]=e,a(e,t[n]._state.parents)}function s(e){for(var t=0;t<e._state.parents.length;t++){delete e._state.parents[t]._state.deps[e._state.id]}for(var n in e._state.deps){var r=e._state.deps[n],i=r._state.parents.indexOf(e);i>-1&&r._state.parents.splice(i,1)}e._state.state=2,e._state.deps={}}function u(e){return o(function(t){return e(t())},[this])}function c(e){return o(function(e,t){return e()(t())},[e,this])}function l(){return this._state.value}function d(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function f(e){return e._state}function h(e){return 1===e._state.state}function p(e){return e._state.changed}function m(e){return 2!==e._state.state}var v=0,w={};t["fantasy-land/of"]=t,t.merge=function(e){return o(function(){return e.map(function(e){return e()})},e)},t.combine=o,t.scan=function(e,t,n){var r=o(function(n){return t=e(t,n._state.value)},[n]);return 0===r._state.state&&r(t),r},t.scanMerge=function(e,t){var n=e.map(function(e){var t=e[0];return 0===t._state.state&&t(void 0),t});return o(function(){var r=arguments[arguments.length-1];return n.forEach(function(n,i){r.indexOf(n)>-1&&(t=e[i][1](t,n._state.value))}),t},n)},t.HALT=w,e.exports=t}()}),X=function(e,t){var n=e.style;if(t)for(var r in t)n[r.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})]=t[r]},K=[],Q=[],V=0,Z={},ee={load:function(e,t){var n;if(t=t||"image",-1!==K.indexOf(e))return!1;switch(t){case"template":n=new Promise(function(t,n){requirejs(["text!"+e],t,function(){n(new Error("Template not found: "+e))})});break;case"image":default:n=new Promise(function(t,n){var r=document.createElement("img");r.onload=function(){t(r)},r.onerror=function(){n(new Error("Image not found: "+r.src))},r.src=e,Z[e]=r})}return n.then(function(){V++}).then(function(){ee.onload&&ee.onload()}),Q.push(n),K.push(e),n},all:function(){return Promise.all(Q)},getImage:function(e){return Z[e].cloneNode()},reset:function(){K=[],Q=[]},progress:function(){return Q.length?V/Q.length:1}},te=d(function(e){!function(t){function n(){this.reads=[],this.writes=[],this.raf=s.bind(t)}function r(e){e.scheduled||(e.scheduled=!0,e.raf(function(e){var t,n=e.writes,o=e.reads;try{a("flushing reads",o.length),i(o),a("flushing writes",n.length),i(n)}catch(e){t=e}e.scheduled=!1,(o.length||n.length)&&r(e);if(t){if(a("task errored",t.message),!e.catch)throw t;e.catch(t)}}.bind(null,e)))}function i(e){for(var t;t=e.shift();)t()}function o(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}var a=function(){},s=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||function(e){return setTimeout(e,16)};n.prototype={constructor:n,measure:function(e,t){var n=t?e.bind(t):e;return this.reads.push(n),r(this),n},mutate:function(e,t){var n=t?e.bind(t):e;return this.writes.push(n),r(this),n},clear:function(e){return o(this.reads,e)||o(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var u=t.fastdom=t.fastdom||new n;e.exports=u}("undefined"!=typeof window?window:J)}),ne=[];document.addEventListener("keyup",function(e){ne[e.which]=!1});var re=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),ie="minno-stimulus-center-y",oe="minno-stimulus-center-x",ae={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(t,n,r){var i=t.handle,o=t.setter;r.stimulusCollection.stimuli.forEach(function(t){"All"!=i&&t.handle!=i||(e.isFunction(o)?o.apply(t):e.extend(t.data,o))})},setTrialAttr:function(t,n,r){var i=t.setter;if(void 0===i)throw new Error("The setTrialAttr action requires a setter property");e.isFunction(i)?i.apply(r,[r.data,n]):e.extend(r.data,i)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(t,n,r){var i=r.input,o=t.handle;if(void 0===o)throw new Error("The removeInput action requires a handle property");"All"==o||e.include(o,"All")?i.destroy():i.remove(o)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(e,t,n){n.end()},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():te.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(t){switch(typeof t.setter){case"function":t.setter.apply(null,[i(),t]);break;case"object":e.extend(i(),t.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(t,n,r){var i=r.cavnas,o=l({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:i,property:"backgroundColor"},borderColor:{element:i,property:"borderColor"},borderWidth:{element:i,property:"borderWidth"}},e.pick(t,["background","canvasBackground","borderColor","borderWidth"]));r.$end.map(o)}},se=0;return e.extend(z.prototype,{start:function(){var t=this;return this._source.DEBUG&&window.DEBUG&&console.group("Trial: "+this.counter),t.stimulusCollection.ready.then(function(){(function(t){return t?e.isArray(t)?t:[t]:[]})(t._source.input).forEach(t.input.add),t.input.resetTimer(),t.$events({type:"begin",latency:0})})},end:function(){this._source.DEBUG&&window.DEBUG&&console.groupEnd("Trial: "+this.counter),this.input.destroy(),this.$events.end(!0),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:e.isString(this._source.inherit)?this._source.inherit:e.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),function(n,a){var s=function(t,n){var r=e.get(n,"settings.canvas",{}),i=Y();t.classList.add("minno-canvas"),i.map(u(t,r)),i({}),window.addEventListener("orientationchange",i),window.addEventListener("resize",i);var o=l({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:t,property:"backgroundColor"},borderColor:{element:t,property:"borderColor"},borderWidth:{element:t,property:"borderWidth"}},e.pick(r,["background","canvasBackground","borderColor","borderWidth"]));return r.css&&X(t,r.css),i.end.map(function(){t.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",i),window.removeEventListener("resize",i)}).map(o),i}(n,a),c=B(n,function(n){var r=new t;if(r.createColl("trial"),r.createColl("stimulus"),r.createColl("media"),r.add("trial",n.trialSets||[]),r.add("stimulus",n.stimulusSets||[]),r.add("media",n.mediaSets||[]),!e.isArray(n.sequence))throw new Error("You must set a sequence array.");var i=r.sequence("trial",n.sequence);return i.go=o,r.currentSequence=i,r}(a),a);return function(t){var n=i(i()),o=t.name||"anonymous minno-time",a=e.isPlainObject(t.current)?t.current:{};a.logs||(a.logs=[]),n[o]=n.current=a,r(t)}(a),c.end.map(function(){s.end(!0)}),function(e,t){function n(){for(;e.firstChild;)e.removeChild(e.firstChild)}var r=g(a);if(1==r.progress())return Promise.resolve().then(n);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=e.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){te.mutate(function(){i.width=100*r.progress()+"%"})},r.all().then(n).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")})}(n).then(c.play.bind(null,["next",{}])),c}});
//# sourceMappingURL=time.js.map
