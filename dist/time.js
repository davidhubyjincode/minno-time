!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(e,t){"use strict";function n(){console.log.apply(console,arguments)}function r(e){return e&&(me=e),me}function i(t,n){return n?ve=t:(e.isPlainObject(t)&&(e.each(function(e,t){console.warn&&i[t]&&console.warn('Overwriting "'+t+'" in global object.')}),e.merge(ve,t)),ve)}function o(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":case"previousWhere":a("next",t,n,r);break;case"current":break;case"first":do{r.prev(n)}while(r.current(n));break;case"last":do{r.next(n)}while(r.current(n));r.prev();break;case"end":do{r.next(n)}while(r.current(n));break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function a(t,n,r,i){var o;do{i[t](),o=i.current(r)}while(o&&!e.callback(n)(o.data))}function u(n){var r=new t;if(r.createColl("trial"),r.createColl("stimulus"),r.createColl("media"),r.add("trial",n.trialSets||[]),r.add("stimulus",n.stimulusSets||[]),r.add("media",n.mediaSets||[]),!e.isArray(n.sequence))throw new Error("You must set a sequence array.");var i=r.sequence("trial",n.sequence);return i.go=o,r.currentSequence=i,r}function s(e){var t=window.getComputedStyle(e);return{height:c(e.offsetHeight)-c(t.borderTopWidth)-c(t.borderBottomWidth),width:c(e.offsetWidth)-c(t.borderLeftWidth)-c(t.borderRightWidth)}}function c(e){return parseFloat(e,10)||0}function l(t,n){function r(){var e=f(n,t),r=window.getComputedStyle(t);e.height-=h(r.borderTopWidth)+h(r.borderBottomWidth)+h(r.marginTop),e.width-=h(r.borderLeftWidth)+h(r.borderRightWidth),t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.fontSize=e.height*(n.textSize||3)/100+"px",window.scrollTo(0,1)}return e.throttle(function(e){"orientationchange"==e.type?setTimeout(r,500):r()},16)}function d(t){if(e.isPlainObject(t.proportions)){if("number"!=typeof t.proportions.height||"number"!=typeof t.proportions.width)throw new Error("The canvas proportions object`s height and a width properties must be numeric");return t.proportions.height/t.proportions.width}return t.proportions||.8}function f(e,t){var n=d(e);if(e.width)return{width:e.width,height:e.width*n};var r=window.document.documentElement,i=r.clientHeight,o=Math.min(e.maxWidth,r.clientWidth,s(t.parentNode).width);return i>n*o?{height:o*n,width:o}:{height:i,width:i/n}}function h(e){return parseFloat(e,10)||0}function p(t,n){var r;if(!e.isPlainObject(t))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(e.isUndefined(n))return e.noop;if(!e.isPlainObject(n))throw new Error("canvas(settings): canvas settings must be an object");return r=e.map(n,function(e,n){var r=t[n];if(r)return m(r.element,r.property,e);throw new Error("canvas("+n+"): unknow key in canvas object.")}),function(){e.forEach(r,function(e){e.call()})}}function m(e,t,n){var r=e.style[t];return e.style[t]=n,function(){e.style[t]=r}}function v(e,t){return t={exports:{}},e(t,t.exports),t.exports}function w(e,t){var n=e.style;if(t)for(var r in t)n[function(e){return e.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()})}(r)]=t[r]}function g(t,n){var r=e.get(n,"settings.canvas",{}),i=ge();t.classList.add("minno-canvas"),i.map(l(t,r)),i({}),window.addEventListener("orientationchange",i),window.addEventListener("resize",i);var o=p({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:t,property:"backgroundColor"},borderColor:{element:t,property:"borderColor"},borderWidth:{element:t,property:"borderWidth"}},e.pick(r,["background","canvasBackground","borderColor","borderWidth"]));return r.css&&w(t,r.css),i.end.map(function(){t.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",i),window.removeEventListener("resize",i)}).map(o),i}function y(e){var t=r().settings||{};return e?t[e]:t}function b(t,n){var r,i=y();return e.isString(i.base_url)?r=i.base_url:e.isObject(i.base_url)&&(r=i.base_url[n]),"image"==n&&/^data:image/.test(t)?t:(r?"/"!=r[r.length-1]&&(r+="/"):r="",r+t)}function E(t){e.isUndefined(t.image)||_e.load(b(t.image,"image"),"image"),e.isUndefined(t.template)||_e.load(b(t.template,"template"),"template")}function k(e){e.media&&E(e.media)}function _(e){e.element&&E(e.element)}function q(t){e.each(t.layout||[],k),e.each(t.stimuli||[],k),e.each(t.input||[],_)}function P(t){e.each(t,function(t){e.isUndefined(t.mixer)?q(t):P(t.data)})}function T(t){e.each(t.mediaSets||[],E),e.each(t.stimulusSets||[],k),e.each(t.trialSets||[],q),P(t.sequence)}function x(e,t,n){switch(n&&_e.reset(),t){case"media":E(e);break;case"stimulus":k(e);break;case"trial":q(e);break;case"script":default:T(e)}return _e}function C(e,t){function n(){for(;e.firstChild;)e.removeChild(e.firstChild)}var r=x(t);if(1==r.progress())return Promise.resolve().then(n);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=e.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){qe.mutate(function(){i.width=100*r.progress()+"%"})},r.all().then(n).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")})}function A(e,t,n,r){var i=n.element;return i&&(w(i,n.css),qe.mutate(function(){r.appendChild(i)})),r.addEventListener(e,function(e){var r=e.target;return i&&r===i?t(e):i||r.getAttribute("data-handle")!==n.stimHandle?void 0:t(e)}),t.end.map(function(){i&&r.removeChild(i),r.removeEventListener(e,t)}),t}function S(e,t){function n(t){Pe[t.which]||-1===r.indexOf(t.which)||(t.preventDefault(),Pe[t.which]=!0,e(t))}var r=(Array.isArray(t.key)?t.key:[t.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",n),e.end.map(function(){document.removeEventListener("keydown",n)}),e}function j(e,t){var n=(Array.isArray(t.key)?t.key:[t.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",function(t){if(-1!==n.indexOf(t.which))return t.preventDefault(),e(t)}),e.end.map(function(){document.removeEventListener("keyup",e)}),e}function F(t,n){if(e.isArray(t))return t[Math.floor(Math.random()*t.length)];if(e.isFunction(t))return t.call(n);if(e.isPlainObject(t)){if(!e.isNumber(t.min)||!e.isNumber(t.max)||t.min>t.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return t.min+(t.max-t.min)*Math.random()}return t}function O(e,t){var n,r=F(t.duration)||0;return e.end.map(function(){clearTimeout(n)}),r?setTimeout(e.bind(null,{}),r):e({}),e}function L(t,n,r){function i(e,t){var n=document.createElement("div");return w(n,t),w(n,e),n}var o=n.on;switch(o){case"keypressed":return S(t,n);case"keyup":return j(t,n);case"click":case"mousedown":return A("mousedown",t,n,r);case"mouseup":return A("mouseup",t,n);case"mouseenter":return A("mouseenter",t,n);case"mouseleave":return A("mouseleave",t,n);case"timeout":return O(t,n);case"enter":return S(t,e.assign({key:13},n));case"space":return S(t,e.assign({key:32},n));case"esc":return S(t,e.assign({key:27},n));case"leftTouch":return n.element=i(n.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),A("mousedown",t,n);case"rightTouch":return n.element=i(n.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),A("mousedown",t,n);case"topTouch":return n.element=i(n.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),A("mousedown",t,n);case"bottomTouch":return n.element=i(n.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),A("mousedown",t,n);default:throw new Error('You have an input element without a recognized "on" property: '+o)}}function D(t,n){var r=ge();if(r.handle=t.handle,e.isFunction(t)){if(r=t(r,t,n),U(r))return r;throw new Error("Input functions must return valid streams")}if(!e.isPlainObject(t))throw new Error("Input must only contain objects and functions, do you have an undefined value?");return e.isString(t.on)?L(r,t,n):(e.isFunction(t.on)&&t.on(r,t,n),e.isFunction(t.off)&&r.end.map(t.off),r)}function U(e){return e._state}function W(e,t){var n=[],r=0;return{add:function(i){if(!i)throw new Error("Missing input element. Could not add input listener");var o=D(i,t.canvas);o.map(function(e){return{handle:i.handle,event:e,trialId:t._id,counter:t.counter,timestamp:+new Date,latency:Te()-r}}).map(e),n.push(o)},remove:function(e){for(var t=n.length-1;t>=0;t--){var r=n[t];r.handle===e&&(r.end(!0),n.splice(t,1))}},destroy:function(){n.forEach(function(e){e.end(!0)}),n.length=0},resetTimer:function(){r=Te()}}}function M(e){var t,n=e.html||e.inlineTemplate||e.template;return e.word?(t=document.createElement("div"),t.textContent=e.word,Promise.resolve(t)):e.image?new Promise(function(n,r){(t=document.createElement("img")).onload=function(){n(t)},t.onerror=function(){r(new Error("Image not found: "+t.src))},t.src=e.image}):(e.jquery&&Promise.reject(new Error("Jquery is no longer supported in minno-time")),n?(t=document.createElement("div"),t.innerHTML=n,Promise.resolve(t)):Promise.reject(new Error("Unrecognized media type")))}function z(e,t){var n=e.style,r=t.size||{};return r.font_size&&(n.fontSize=r.font_size),I("height",r)&&!t.media.word&&(n.height=r.height+"%"),I("width",r)&&(n.width=r.width+"%"),e}function I(e,t){return e in t}function $(e,t){function n(e){return!isNaN(+e)}var r=t.location||{};("center"==r.top||"center"==r.bottom||void 0===r.top&&void 0===r.bottom)&&e.classList.add("minno-stimulus-center-y"),("center"==r.left||"center"==r.right||void 0===r.left&&void 0===r.right)&&e.classList.add("minno-stimulus-center-x"),["top","bottom","left","right"].forEach(function(t){n(r[t])&&(e.style[t]=r[t]+"%")})}function N(e,t,n){var r={el:null,source:e,trial:t,canvas:n,init:B,show:R,hide:H,name:Y,mediaName:X,destroy:J};return r.data=e.data||{},r.handle=r.data.handle=r.data.handle||e.handle||e.set,r}function B(){if(!this.source.media)throw new Error("Media object not defined for "+this.name());return M(this.source.media).then(G.bind(this,this.canvas))}function G(e,t){var n=this;return this.el=t,new Promise(function(r){qe.mutate(function(){t.classList.add("minno-stimulus"),t.setAttribute("data-handle",n.handle),z(t,n.source),$(t,n.source),w(t,n.source.css||{}),n.source.isLayout&&t.classList.add("minno-stimulus-visible"),e.appendChild(t),r(t)})})}function R(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");qe.mutate(function(){e.classList.add("minno-stimulus-visible")})}function H(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");qe.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function J(){var e=this.el,t=this.canvas;qe.mutate(function(){t.removeChild(e)})}function Y(){var e=this.source;return e.alias?e.alias:this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle?this.handle:void 0}function X(e){var t=this.source.media,n=e&&e.fullpath;if(t.alias)return t.alias;for(var r in t){if(K(["image","template"],r))return n?t[r]:t[r].replace(/^.*[\\/]/,"");if(K(["word","html","inlineTemplate"],r)&&t[r])return t[r]}}function K(e,t){return-1!=e.indexOf(t)}function Q(e,t){function n(n){return N(n,e,t)}var r=e._source,i=r.stimuli.map(n),o=r.layout.map(function(e){return e.isLayout=!0,e}).map(n),a=Promise.all(i.concat(o).map(function(e){return e.init()}));return{canvas:t,stimuli:i,layout:o,ready:a,getStimlist:V,getMedialist:Z,destroy:ee}}function V(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function Z(e){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(t,n){return t.mediaName(e)||"media"+n})}function ee(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function te(t,n,r){function o(e){return r.stimulusCollection.stimuli.some(function(t){var n=t.data;for(var r in e)if(e[r]!==n[r])return!1;return!0})}var a=i(),u=a.current||{};if(!t)throw new Error("There is an interaction without conditions!!");t=Array.isArray(t)?t:[t];var s=!0;return("begin"!=(n=n||{}).type||!t.every(function(e){return"begin"!=e.type}))&&(t.forEach(function(t){var i,c=!0;switch(t.type){case"begin":"begin"!==n.type&&(c=!1);break;case"inputEquals":e.isArray(t.value)||(t.value=[t.value]),-1===e.indexOf(t.value,n.handle)&&(c=!1);break;case"inputEqualsTrial":n.handle!==r.data[t.property]&&(c=!1);break;case"inputEqualsStim":i={},t.handle&&(i.handle=t.handle),i[t.property]=n.handle,o(i)||(c=!1);break;case"trialEquals":if(void 0===t.property||void 0===t.value)throw new Error('trialEquals requires both "property" and "value" to be defined');t.value!==r.data[t.property]&&(c=!1);break;case"inputEqualsGlobal":if(void 0===t.property)throw new Error('inputEqualsGlobal requires "property" to be defined');n.handle!==a[t.property]&&(c=!1);break;case"globalEquals":if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');t.value!==a[t.property]&&(c=!1);break;case"globalEqualsTrial":if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');a[t.globalProp]!==r.data[t.trialProp]&&(c=!1);break;case"globalEqualsStim":if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');i={},t.handle&&(i.handle=t.handle),i[t.stimProp]=a[t.globalProp],o(i)||(c=!1);break;case"inputEqualsCurrent":if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');n.handle!==u[t.property]&&(c=!1);break;case"currentEquals":if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');t.value!==u[t.property]&&(c=!1);break;case"currentEqualsTrial":if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');u[t.currentProp]!==r.data[t.trialProp]&&(c=!1);break;case"currentEqualsStim":if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');i={},t.handle&&(i.handle=t.handle),i[t.stimProp]=u[t.currentProp],o(i)||(c=!1);break;case"function":t.value.apply(r,[t,n,r])||(c=!1);break;case"custom":t.fn.apply(null,[t,n,r])||(c=!1);break;default:throw new Error("Unknown condition type: "+t.type)}s=s&&(t.negate?!c:c)}),s)}function ne(t,n,r){var i=!0;if(!t)throw new Error("There is an interaction without actions!!");return t=e.isArray(t)?t:[t],e.forEach(t,function(e){var t=xe[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(i=!1),t(e,n,r)}),i}function re(e){var t=e._source.interactions,n=e._source.DEBUG&&window.DEBUG;return function(r){var i,o,a;for(n&&console.groupCollapsed("Event: "+(r.handle||r.type),r),i=0;i<t.length&&(o=t[i],a=te(o.conditions,r,e),n&&console.log(a,o.conditions),!a||ne(o.actions,r,e));i++);return n&&console.groupEnd("Event: "+(r.handle||r.type)),r}}function ie(t,n,r){if(!t.interactions)throw new Error("Interactions not defined");this.canvas=n,this.settings=r,this._source=t,this.$logs=ge(),this.$events=ge(),this.$end=this.$events.end,this.data=t.data||{},this._id=e.uniqueId("trial_"),this.counter=Ce++,this.input=W(this.$events,this),this.stimulusCollection=Q(this,n),this.$events.map(re(this)),this._next=["next",{}]}function oe(t){return t?e.isArray(t)?t:[t]:[]}function ae(t,n){function r(n,r,i){var o=n[r];if(e.isUndefined(o))return!1;e.isString(o)&&(o={word:o}),(o=t.inflate("media",o,i)).image&&(o.image=b(o.image,"image")),o.template&&(o.inlineTemplate=requirejs("text!"+b(o.template,"template")),o.inlineTemplate=e.template(o.inlineTemplate)(i)),n[r]=o,i.mediaData=null,i.mediaMeta=null}function o(e){var n=this;return e=t.inflate("stimulus",e,n,{skip:["media","touchMedia"]}),r(e,"media",n),r(e,"touchMedia",n),n.stimulusData=null,n.stimulusMeta=null,e}var a,u=n[0],s=n[1],c=t.currentSequence,l=i(),d={global:l,current:l.current};return c.go(u,s,d),(a=c.current(d,{skip:["layout","stimuli"]}))?(a.stimuli=e.map(a.stimuli||[],o,d),a.layout=e.map(a.layout||[],o,d),d.trialData=null,{value:a}):{done:!0}}function ue(e,t){return new Promise(function(n,r){var i=new XMLHttpRequest;i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?n(this.responseText):r(new Error("Failed posting to: "+e)))},i.send(se(t))})}function se(e){return"string"==typeof e?e:JSON.stringify(e)}function ce(t,n){function r(t){var r={json:JSON.stringify(t)},o=i(e.assign(r,n.metaData));return ue(a,o).catch(function(){return ue(a,o)}).catch(n.error||e.noop)}function i(e){var t,n=[];for(t in e)n.push(encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return n.join("&").replace(/%20/g,"+")}var o=[],a=n.url;a&&(t.map(function(e){o.push(e),n.pulse&&o.length>=n.pulse&&(r(o),o.length=0)}),t.end.map(function(){o.length&&r(o)}))}function le(t,n,r){var i=window.piGlobal,o=r.data,a=n,u=i.current.logs,s=e.get(r,"settings.logger.fullpath",!1),c=r.stimulusCollection.getStimlist(),l=r.stimulusCollection.getMedialist({fullpath:s});return{log_serial:u.length,trial_id:r.counter,name:r.name(),responseHandle:a.handle,latency:Math.floor(a.latency),stimuli:c,media:l,data:o}}function de(e,t){var n=e.map(function(e){return function(t){return e.apply(null,t)}}(t.logger||t.transformLogs||le));return n.map(function(e){i().current.logs.push(e)}),ce(n,t),t.poster&&t.poster(n,t),n}function fe(t,n,r){function i(e){var t=ae(n,e);t.done?o.end(!0):o(t.value)}var o=ge(),a=o.map(function(e){return function(n){var o=e,a=e=new ie(n,t,r.settings);return a.$logs.map(u),a.$end.map(function(){i(a._next)}),a.start(),o&&qe.mutate(function(){o.stimulusCollection.destroy()}),a}}()),u=ge(),s=e.get(r,"settings.hooks.endTask",r.settings.onEnd||e.noop);return o.end.map(function(){var e=a();e&&e.stimulusCollection.destroy()}).map(s),{$trial:a,end:o.end,$logs:de(u,r.settings.logger||{}),play:i}}function he(t){var n=i(i()),o=t.name||"anonymous minno-time",a=e.isPlainObject(t.current)?t.current:{};a.logs||(a.logs=[]),n[o]=n.current=a,r(t)}e=e&&e.hasOwnProperty("default")?e.default:e,t=t&&t.hasOwnProperty("default")?t.default:t,Date.now||(Date.now=function(){return(new Date).getTime()}),console.group||(console.group=n),console.groupCollapsed||(console.groupCollapsed=n),console.groupEnd||(console.groupEnd=n),console.table||(console.table=n),function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout}}();var pe=function(e){function t(e,t){return function a(l){var d;try{if(!t||null==l||"object"!=typeof l&&"function"!=typeof l||"function"!=typeof(d=l.then))c(function(){t||0!==e.length||console.error("Possible unhandled promise rejection:",l);for(var n=0;n<e.length;n++)e[n](l);i.length=0,o.length=0,s.state=t,s.retry=function(){a(l)}});else{if(l===r)throw new TypeError("Promise can't be resolved w/ itself");n(d.bind(l))}}catch(e){u(e)}}}function n(e){function t(e){return function(t){n++>0||e(t)}}var n=0,r=t(u);try{e(t(a),r)}catch(e){r(e)}}if(!(this instanceof pe))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var r=this,i=[],o=[],a=t(i,!0),u=t(o,!1),s=r._instance={resolvers:i,rejectors:o},c="function"==typeof setImmediate?setImmediate:setTimeout;n(e)};pe.prototype.then=function(e,t){function n(e,t,n,a){t.push(function(t){if("function"!=typeof e)n(t);else try{r(e(t))}catch(e){i&&i(e)}}),"function"==typeof o.retry&&a===o.state&&o.retry()}var r,i,o=this._instance,a=new pe(function(e,t){r=e,i=t});return n(e,o.resolvers,r,!0),n(t,o.rejectors,i,!1),a},pe.prototype.catch=function(e){return this.then(null,e)},pe.resolve=function(e){return e instanceof pe?e:new pe(function(t){t(e)})},pe.reject=function(e){return new pe(function(t,n){n(e)})},pe.all=function(e){return new pe(function(t,n){var r=e.length,i=0,o=[];if(0===e.length)t([]);else for(var a=0;a<e.length;a++)!function(a){function u(e){i++,o[a]=e,i===r&&t(o)}null==e[a]||"object"!=typeof e[a]&&"function"!=typeof e[a]||"function"!=typeof e[a].then?u(e[a]):e[a].then(u,n)}(a)})},pe.race=function(e){return new pe(function(t,n){for(var r=0;r<e.length;r++)e[r].then(t,n)})},void 0===window.Promise&&(window.Promise=pe);var me={},ve=window.piGlobal||(window.piGlobal={}),we="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},ge=v(function(e){!function(){function t(){function e(){return arguments.length>0&&arguments[0]!==b&&r(e,arguments[0]),e._state.value}return n(e),arguments.length>0&&arguments[0]!==b&&r(e,arguments[0]),e}function n(e){e.constructor=t,e._state={id:y++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},e.map=e["fantasy-land/map"]=d,e["fantasy-land/ap"]=f,e["fantasy-land/of"]=t,e.valueOf=h,e.toJSON=p,e.toString=h,Object.defineProperties(e,{end:{get:function(){if(!e._state.endStream){var n=t();n.map(function(t){return!0===t&&(l(e),n._state.unregister=function(){l(n)}),t}),e._state.endStream=n}return e._state.endStream}}})}function r(e,t){i(e,t);for(var n in e._state.deps)o(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),a(e)}function i(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function o(e,t){var n=e._state.parents;if(n.length>0&&n.every(v)&&(t||n.some(w))){var r=e._state.derive();if(r===b)return!1;i(e,r)}}function a(e){e._state.changed=!1;for(var t in e._state.deps)e._state.deps[t]._state.changed=!1}function u(e,n){if(!n.every(m))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return s(t(),n,function(){return e.apply(this,n.concat([n.filter(w)]))})}function s(e,t,n){var r=e._state;return r.derive=n,r.parents=t.filter(g),c(e,r.parents),o(e,!0),e}function c(e,t){for(var n=0;n<t.length;n++)t[n]._state.deps[e._state.id]=e,c(e,t[n]._state.parents)}function l(e){for(var t=0;t<e._state.parents.length;t++)delete e._state.parents[t]._state.deps[e._state.id];for(var n in e._state.deps){var r=e._state.deps[n],i=r._state.parents.indexOf(e);i>-1&&r._state.parents.splice(i,1)}e._state.state=2,e._state.deps={}}function d(e){return u(function(t){return e(t())},[this])}function f(e){return u(function(e,t){return e()(t())},[e,this])}function h(){return this._state.value}function p(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function m(e){return e._state}function v(e){return 1===e._state.state}function w(e){return e._state.changed}function g(e){return 2!==e._state.state}var y=0,b={};t["fantasy-land/of"]=t,t.merge=function(e){return u(function(){return e.map(function(e){return e()})},e)},t.combine=u,t.scan=function(e,t,n){var r=u(function(n){return t=e(t,n._state.value)},[n]);return 0===r._state.state&&r(t),r},t.scanMerge=function(e,t){var n=e.map(function(e){var t=e[0];return 0===t._state.state&&t(void 0),t});return u(function(){var r=arguments[arguments.length-1];return n.forEach(function(n,i){r.indexOf(n)>-1&&(t=e[i][1](t,n._state.value))}),t},n)},t.HALT=b,e.exports=t}()}),ye=[],be=[],Ee=0,ke={},_e={load:function(e,t){var n;if(t=t||"image",-1!==ye.indexOf(e))return!1;switch(t){case"template":n=new Promise(function(t,n){requirejs(["text!"+e],t,function(){n(new Error("Template not found: "+e))})});break;case"image":default:n=new Promise(function(t,n){var r=document.createElement("img");r.onload=function(){t(r)},r.onerror=function(){n(new Error("Image not found: "+r.src))},r.src=e,ke[e]=r})}return n.then(function(){Ee++}).then(function(){_e.onload&&_e.onload()}),be.push(n),ye.push(e),n},all:function(){return Promise.all(be)},getImage:function(e){return ke[e].cloneNode()},reset:function(){ye=[],be=[]},progress:function(){return be.length?Ee/be.length:1}},qe=v(function(e){!function(t){function n(){var e=this;e.reads=[],e.writes=[],e.raf=c.bind(t)}function r(e){e.scheduled||(e.scheduled=!0,e.raf(i.bind(null,e)))}function i(e){var t,n=e.writes,i=e.reads;try{s("flushing reads",i.length),o(i),s("flushing writes",n.length),o(n)}catch(e){t=e}if(e.scheduled=!1,(i.length||n.length)&&r(e),t){if(s("task errored",t.message),!e.catch)throw t;e.catch(t)}}function o(e){for(var t;t=e.shift();)t()}function a(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}function u(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}var s=function(){},c=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.msRequestAnimationFrame||function(e){return setTimeout(e,16)};n.prototype={constructor:n,measure:function(e,t){var n=t?e.bind(t):e;return this.reads.push(n),r(this),n},mutate:function(e,t){var n=t?e.bind(t):e;return this.writes.push(n),r(this),n},clear:function(e){return a(this.reads,e)||a(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return u(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var l=t.fastdom=t.fastdom||new n;e.exports=l}("undefined"!=typeof window?window:we)}),Pe=[];document.addEventListener("keyup",function(e){Pe[e.which]=!1});var Te=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),xe={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(t,n,r){var i=t.handle,o=t.setter;r.stimulusCollection.stimuli.forEach(function(t){"All"!=i&&t.handle!=i||(e.isFunction(o)?o.apply(t):e.extend(t.data,o))})},setTrialAttr:function(t,n,r){var i=t.setter;if(void 0===i)throw new Error("The setTrialAttr action requires a setter property");e.isFunction(i)?i.apply(r,[r.data,n]):e.extend(r.data,i)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(t,n,r){var i=r.input,o=t.handle;if(void 0===o)throw new Error("The removeInput action requires a handle property");"All"==o||e.include(o,"All")?i.destroy():i.remove(o)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(e,t,n){n.end()},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():qe.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(t){switch(typeof t.setter){case"function":t.setter.apply(null,[i(),t]);break;case"object":e.extend(i(),t.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(t,n,r){var i=r.cavnas,o=p({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:i,property:"backgroundColor"},borderColor:{element:i,property:"borderColor"},borderWidth:{element:i,property:"borderWidth"}},e.pick(t,["background","canvasBackground","borderColor","borderWidth"]));r.$end.map(o)}},Ce=0;return e.extend(ie.prototype,{start:function(){var e=this;return this._source.DEBUG&&window.DEBUG&&console.group("Trial: "+this.counter),e.stimulusCollection.ready.then(function(){oe(e._source.input).forEach(e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this._source.DEBUG&&window.DEBUG&&console.groupEnd("Trial: "+this.counter),this.input.destroy(),this.$events.end(!0),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:e.isString(this._source.inherit)?this._source.inherit:e.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),function(e,t){var n=g(e,t),r=fe(e,u(t),t);return he(t),r.end.map(function(){n.end(!0)}),C(e,t).then(r.play.bind(null,["next",{}])),r}});
//# sourceMappingURL=time.js.map
