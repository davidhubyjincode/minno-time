!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(h,i){"use strict";function e(){console.log.apply(console,arguments)}h=h&&h.hasOwnProperty("default")?h.default:h,i=i&&i.hasOwnProperty("default")?i.default:i,Date.now||(Date.now=function(){return(new Date).getTime()}),function(e){var t,n=["now","webkitNow","msNow","mozNow"];if(e.performance)for(var r=0;r<n.length;++r){var i=n[r];if(e.performance[i]){t=function(){return e.performance[i]()};break}}t=t||Date.now,e.perfNow=t}(window),console.group||(console.group=e),console.groupCollapsed||(console.groupCollapsed=e),console.groupEnd||(console.groupEnd=e),console.table||(console.table=e),function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout}}();var f=function(e){if(!(this instanceof f))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var o=this,a=[],u=[],i=t(a,!0),s=t(u,!1),c=o._instance={resolvers:a,rejectors:u},l="function"==typeof setImmediate?setImmediate:setTimeout;function t(r,i){return function t(n){var e;try{if(!i||null==n||"object"!=typeof n&&"function"!=typeof n||"function"!=typeof(e=n.then))l(function(){i||0!==r.length||console.error("Possible unhandled promise rejection:",n);for(var e=0;e<r.length;e++)r[e](n);a.length=0,u.length=0,c.state=i,c.retry=function(){t(n)}});else{if(n===o)throw new TypeError("Promise can't be resolved w/ itself");d(e.bind(n))}}catch(e){s(e)}}}function d(e){var n=0;function t(t){return function(e){0<n++||t(e)}}var r=t(s);try{e(t(i),r)}catch(e){r(e)}}d(e)};f.prototype.then=function(e,t){var i,o,a=this._instance;function n(t,e,n,r){e.push(function(e){if("function"!=typeof t)n(e);else try{i(t(e))}catch(e){o&&o(e)}}),"function"==typeof a.retry&&r===a.state&&a.retry()}var r=new f(function(e,t){i=e,o=t});return n(e,a.resolvers,i,!0),n(t,a.rejectors,o,!1),r},f.prototype.catch=function(e){return this.then(null,e)},f.resolve=function(t){return t instanceof f?t:new f(function(e){e(t)})},f.reject=function(n){return new f(function(e,t){t(n)})},f.all=function(u){return new f(function(n,r){var i=u.length,o=0,a=[];if(0===u.length)n([]);else for(var e=0;e<u.length;e++)!function(t){function e(e){o++,a[t]=e,o===i&&n(a)}null==u[t]||"object"!=typeof u[t]&&"function"!=typeof u[t]||"function"!=typeof u[t].then?e(u[t]):u[t].then(e,r)}(e)})},f.race=function(r){return new f(function(e,t){for(var n=0;n<r.length;n++)r[n].then(e,t)})},void 0===window.Promise&&(window.Promise=f),function(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===n&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".minno-canvas{height:400px;width:500px;position:relative;border:5px solid #fff;margin:10px auto auto;-webkit-text-size-adjust:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;display:flex;justify-content:center;align-items:center}.minno-stimulus{position:absolute;text-align:center;overflow:hidden;visibility:hidden;width:auto;height:auto;max-width:100%}.minno-stimulus-visible{visibility:visible}.minno-progress{background-color:#20201f;border-radius:20px;padding:4px;position:absolute;top:50%;left:10%;width:80%;height:24px;margin-top:-12px}.minno-progress-bar{background-color:#807b7a;width:0;height:16px;border-radius:10px}",{});var t=window.piGlobal||(window.piGlobal={});function m(){return t}function o(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":a("next",t,n,r);break;case"previousWhere":a("prev",t,n,r);break;case"current":break;case"first":for(;r.prev(n),r.current(n););break;case"last":for(;r.next(n),r.current(n););r.prev();break;case"end":for(;r.next(n),r.current(n););break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function a(e,t,n,r){for(var i;r[e](),(i=r.current(n))&&!h.iteratee(t)(i.data););}var n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var s=r(function(s){!function(e){var i=function(){},t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};function n(){this.reads=[],this.writes=[],this.raf=t.bind(e)}function o(e){e.scheduled||(e.scheduled=!0,e.raf(function(e){var t,n=e.writes,r=e.reads;try{i("flushing reads",r.length),a(r),i("flushing writes",n.length),a(n)}catch(e){t=e}e.scheduled=!1,(r.length||n.length)&&o(e);if(t){if(i("task errored",t.message),!e.catch)throw t;e.catch(t)}}.bind(null,e)))}function a(e){for(var t;t=e.shift();)t()}function r(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}n.prototype={constructor:n,measure:function(e,t){var n=t?e.bind(t):e;return this.reads.push(n),o(this),n},mutate:function(e,t){var n=t?e.bind(t):e;return this.writes.push(n),o(this),n},clear:function(e){return r(this.reads,e)||r(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var u=e.fastdom=e.fastdom||new n;s.exports=u}("undefined"!=typeof window?window:n)});function u(e){return parseFloat(e,10)||0}function c(n,r){return h.throttle(function(e){"orientationchange"==e.type?setTimeout(t,500):t()},16);function t(){s.measure(function(){var e=function(e,t){var n=function(e){if(!h.isPlainObject(e))return e||.8;if([e.height,e.width].every(h.isFinite))return e.height/e.width;throw new Error("The canvas proportions object`s height and a width properties must be numeric")}(e.proportions);if(e.width)return{width:e.width,height:e.width*n};var r=window.document.documentElement,i=r.clientHeight,o=Math.min(e.maxWidth||1/0,r.clientWidth,function(e){var t=window.getComputedStyle(e);return{height:u(e.offsetHeight)-u(t.borderTopWidth)-u(t.borderBottomWidth),width:u(e.offsetWidth)-u(t.borderLeftWidth)-u(t.borderRightWidth)}}(t.parentNode).width);return n*o<i?{height:o*n,width:o}:{height:i,width:i/n}}(r,n),t=window.getComputedStyle(n);e.height-=l(t.borderTopWidth)+l(t.borderBottomWidth)+l(t.marginTop),e.width-=l(t.borderLeftWidth)+l(t.borderRightWidth),s.mutate(function(){n.style.width=e.width+"px",n.style.height=e.height+"px",n.style.fontSize=e.height*(r.textSize||3)/100+"px",window.scrollTo(0,1)})})}}function l(e){return parseFloat(e,10)||0}function d(r,e){var t;if(!h.isPlainObject(r))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(h.isUndefined(e))return h.noop;if(!h.isPlainObject(e))throw new Error("canvas(settings): canvas settings must be an object");return t=h.map(e,function(e,t){var n=r[t];if(n)return function(e,t,n){var r=e.style[t];return e.style[t]=n,function(){e.style[t]=r}}(n.element,n.property,e);throw new Error("canvas("+t+"): unknow key in canvas object.")}),function(){h.forEach(t,function(e){e.call()})}}var p=r(function(e){function r(){function e(){return 0<arguments.length&&arguments[0]!==v&&t(e,arguments[0]),e._state.value}return function(n){n.constructor=r,n._state={id:p++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},n.map=n["fantasy-land/map"]=s,n["fantasy-land/ap"]=c,n["fantasy-land/of"]=r,n.valueOf=l,n.toJSON=d,n.toString=l,Object.defineProperties(n,{end:{get:function(){if(!n._state.endStream){var t=r();t.map(function(e){return!0===e&&(u(n),t._state.unregister=function(){u(t)}),e}),n._state.endStream=t}return n._state.endStream}}})}(e),0<arguments.length&&arguments[0]!==v&&t(e,arguments[0]),e}function t(e,t){for(var n in i(e,t),e._state.deps)o(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),function(e){for(var t in e._state.changed=!1,e._state.deps)e._state.deps[t]._state.changed=!1}(e)}function i(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function o(e,t){var n=e._state.parents;if(0<n.length&&n.every(f)&&(t||n.some(m))){var r=e._state.derive();if(r===v)return!1;i(e,r)}}function a(e,t){if(!t.every(n))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return function(e,t,n){var r=e._state;return r.derive=n,r.parents=t.filter(h),function e(t,n){for(var r=0;r<n.length;r++)n[r]._state.deps[t._state.id]=t,e(t,n[r]._state.parents)}(e,r.parents),o(e,!0),e}(r(),t,function(){return e.apply(this,t.concat([t.filter(m)]))})}function u(e){for(var t=0;t<e._state.parents.length;t++){delete e._state.parents[t]._state.deps[e._state.id]}for(var n in e._state.deps){var r=e._state.deps[n],i=r._state.parents.indexOf(e);-1<i&&r._state.parents.splice(i,1)}e._state.state=2,e._state.deps={}}function s(t){return a(function(e){return t(e())},[this])}function c(e){return a(function(e,t){return e()(t())},[e,this])}function l(){return this._state.value}function d(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function n(e){return e._state}function f(e){return 1===e._state.state}function m(e){return e._state.changed}function h(e){return 2!==e._state.state}var p,v;p=0,v={},(r["fantasy-land/of"]=r).merge=function(e){return a(function(){return e.map(function(e){return e()})},e)},r.combine=a,r.scan=function(t,n,e){var r=a(function(e){return n=t(n,e._state.value)},[e]);return 0===r._state.state&&r(n),r},r.scanMerge=function(r,i){var e=r.map(function(e){var t=e[0];return 0===t._state.state&&t(void 0),t});return a(function(){var n=arguments[arguments.length-1];return e.forEach(function(e,t){-1<n.indexOf(e)&&(i=r[t][1](i,e._state.value))}),i},e)},r.HALT=v,e.exports=r}),v=function(e,t){var n=e.style;if(!t)return;for(var r in t)n[(i=r,i.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}))]=t[r];var i};function w(e,t){var n=function(e,t){t=t||{};var n=p();if(!h.isElement(e))throw new Error("Minno-time: canvas is not a DOM element");e.classList.add("minno-canvas");var r=d({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},h.pick(t,["background","canvasBackground","borderColor","borderWidth"]));return t.css&&v(e,t.css),n.map(c(e,t)),n({}),window.addEventListener("orientationchange",n),window.addEventListener("resize",n),n.end.map(function(){e.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",n),window.removeEventListener("resize",n)}).map(r),n}(e,h.get(t,"settings.canvas",{})),r=function(e){var t=new i;if(t.createColl("trial"),t.createColl("stimulus"),t.createColl("media"),t.add("trial",e.trialSets||[]),t.add("stimulus",e.stimulusSets||[]),t.add("media",e.mediaSets||[]),!h.isArray(e.sequence))throw new Error("You must set a sequence array.");var n=t.sequence("trial",e.sequence);return n.go=o,t.currentSequence=n,t}(t);return function(e){var t=m(m()),n=e.name||"anonymous minno-time",r=e.current?e.current:{};r.logs||(r.logs=[]),t[n]=t.current=r}(t),{db:r,$resize:n,canvas:e,script:t,settings:t.settings||{}}}var g=[],y=[],b=0,E=h.memoize(function(r){return new Promise(function(e,t){var n=new XMLHttpRequest;n.open("GET",r,!0),n.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?e(this.responseText):t(new Error("Template not found:"+r)))},n.send()})}),_={load:function(t,e){if(-1!==g.indexOf(t))return!1;var n="template"==e?E(t):function(r){return new Promise(function(e,t){var n=document.createElement("img");n.onload=function(){e(n)},n.onerror=function(){t(new Error("Image not found: "+r))},n.src=r})}(t);return n.then(function(){b++}).then(function(){_.onload&&_.onload(t)}).catch(function(e){_.onerror&&_.onerror(e,t)}),y.push(n),g.push(t),n},all:function(){return Promise.all(y)},progress:function(){return y.length?b/y.length:1}};function k(e,t,n){return"image"==n&&/^data:image/.test(t)?t:(h.isObject(e)&&(e=e[n]),e?"/"!=e[e.length-1]&&(e+="/"):e="",e+t)}function x(e,t){return function(e){var t=e.mediaSets,n=h.map(e.stimulusSets,C),r=h.map(e.trialSets,q),i=h.filter(e.sequence,A).map(q);return h.flattenDeep([t,n,r,i]).filter(P)}(e).forEach(function(e){h.isUndefined(e.image)||_.load(k(t,e.image,"image"),"image");h.isUndefined(e.template)||_.load(k(t,e.template,"template"),"template")}),_}function q(e){return[h.map(e.input,function(e){return e.element}),h.map(e.stimuli,C),h.map(e.layout,C)]}function C(e){return e.media}function A(e){return!e.mixer}function P(e){return!h.isUndefined(e)}function T(e,n,t){var r=p(),i=n.element;return i&&(v(i,n.css),s.mutate(function(){t.appendChild(i)})),t.addEventListener(e,function(e){var t=e.target;return i&&t===i?r(e):i||t.getAttribute("data-handle")!==n.stimHandle?void 0:r(e)}),r.end.map(function(){i&&t.removeChild(i);t.removeEventListener(e,r)}),r}var S=[];function F(e){var t=p(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",r),t.end.map(function(){document.removeEventListener("keydown",r)}),t;function r(e){S[e.which]||-1===n.indexOf(e.which)||(e.preventDefault(),S[e.which]=!0,t(e))}}function $(e){var t=p(),n=function(e,t){if(h.isArray(e))return e[Math.floor(Math.random()*e.length)];if(h.isFunction(e))return e.call(t);if(h.isPlainObject(e)){if(!h.isNumber(e.min)||!h.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}(e.duration)||0;return t.end.map(function(){clearTimeout(void 0)}),n?setTimeout(t.bind(null,{}),n):t({}),t}function j(e,t){var n=e.on;switch(n){case"keypressed":return F(e);case"keyup":return function(e){var t=p(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keyup",function(e){if(-1===n.indexOf(e.which))return;return e.preventDefault(),t(e)}),t.end.map(function(){document.removeEventListener("keyup",t)}),t}(e);case"click":case"mousedown":return T("mousedown",e,t);case"mouseup":return T("mouseup",e,t);case"mouseenter":return T("mouseenter",e,t);case"mouseleave":return T("mouseleave",e,t);case"timeout":return $(e);case"enter":return F(h.assign({key:13},e));case"space":return F(h.assign({key:32},e));case"esc":return F(h.assign({key:27},e));case"leftTouch":return e.element=r(e.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),T("mousedown",e,t);case"rightTouch":return e.element=r(e.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),T("mousedown",e,t);case"topTouch":return e.element=r(e.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),T("mousedown",e,t);case"bottomTouch":return e.element=r(e.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),T("mousedown",e,t);default:throw new Error('You have an input element with an unrecognized "on" property: '+n)}function r(e,t){var n=document.createElement("div");return v(n,t),v(n,e),n}}function L(e,t){var n=function(e,t){var n;if(h.isFunction(e))return e(e,t,p);if(h.isPlainObject(e)){if(h.isString(e.on))return j(e,t);h.isFunction(e.on)&&(n=e.on(e,t,p)),h.isFunction(e.off)&&n.end.map(e.off)}throw new Error("Input must only contain objects and functions, do you have an undefined value?")}(e,t);if(!function(e){return e._state}(n))throw new Error("Input functions must return valid streams: "+function(e){return h.isFunction(e)?e.toString():JSON.stringify(e)}(e));return"handle"in e&&(n.handle=e.handle),n}document.addEventListener("keyup",function(e){S[e.which]=!1});var O=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date);function M(n){var r,e=n.html||n.inlineTemplate||n.template;return h.isFunction(n)?function(e){var t=e();return function(e){return e&&h.isFunction(e.then)}(t)?t.then(function(e){return h.isElement(e)?e:Promise.reject("Custom media must resolve with an element")}):Promise.reject(new Error("Custom media must return a promise"))}(n):(z(n)&&(n={word:n}),z(n.word)?((r=document.createElement("div")).textContent=n.word,Promise.resolve(r)):e?((r=document.createElement("div")).innerHTML=e,Promise.resolve(r)):n.$image?new Promise(function(e,t){(r=document.createElement("img")).onload=function(){e(r)},r.onerror=function(){t(new Error("Image not found: "+r.src))},r.src=n.$image}):n.jquery?Promise.reject(new Error("Jquery is no longer supported in minno-time")):Promise.reject(new Error("Unrecognized media type")))}function z(e){return h.isString(e)||h.isNumber(e)}function W(e,t){var n=e.style,r=t.size||{};return r.font_size&&(n.fontSize=r.font_size),N("height",r)&&!function(e){return h.isString(e)||h.isString(e.word)}(t.media)&&(n.height=r.height+"%"),N("width",r)&&(n.width=r.width+"%"),e}function N(e,t){return e in t}function D(t,e){var n=e.location||{};["top","bottom","left","right"].forEach(function(e){!function(e){return!isNaN(+e)}(n[e])||(t.style[e]=n[e]+"%")})}var I=window.document.documentMode;function U(t){var n=this,r=n.canvas;return this.el=t,new Promise(function(e){s.mutate(function(){t.classList.add("minno-stimulus"),t.setAttribute("data-handle",n.handle),r.appendChild(t),W(t,n.source),D(t,n.source),v(t,n.source.css||{}),I?function(r,i){var e=r.canvas,o=r.el,a=r.source.location||{};function u(e,t){return"center"===e||"center"===t||void 0===e&&void 0===t}s.measure(function(){var t=100*o.clientWidth/e.clientWidth,n=100*o.clientHeight/e.clientHeight;s.mutate(function(){var e=o.style;e.width=t+"%",e.height=n+"%",u(a.top,a.bottom)&&(e.top=(100-n)/2+"%"),u(a.left,a.right)&&(e.left=(100-t)/2+"%"),r.source.isLayout&&o.classList.add("minno-stimulus-visible"),i(o)})})}(n,e):(n.source.isLayout&&t.classList.add("minno-stimulus-visible"),e(t))})})}function B(){var t=this.source,n=this.trial.$messages;if(!this.source.media)throw new Error("Media object not defined for "+this.name());return M(this.source.media).then(U.bind(this)).catch(function(e){throw n({type:"error",message:"trial.stimulus error",error:e,context:t}),e})}function H(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");s.mutate(function(){e.classList.add("minno-stimulus-visible")})}function R(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");s.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function G(){var e=this.el,t=this.canvas;s.mutate(function(){t.removeChild(e)})}function J(){var e=this.source;return e.alias?e.alias:this.data&&this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle?this.handle:void 0}function Y(e){var t=this.source.media,n=e&&e.fullpath;if(t.alias)return t.alias;if(t.data&&t.data.alias)return t.data.alias;for(var r in t){if(X(["image","template"],r))return n?t[r]:t[r].replace(/^.*[\\/]/,"");if(X(["word","html","inlineTemplate"],r)&&t[r])return t[r]}}function X(e,t){return-1!=e.indexOf(t)}function V(t,n){ee("stimuli",t._source),ee("layout",t._source);var e=t._source,r=h.map(e.stimuli,a),i=h.map(e.layout,function(e){return e.isLayout=!0,e}).map(a),o=r.concat(i).map(function(e){return e.init()});return{canvas:n,stimuli:r,layout:i,ready:Promise.all(o),getStimlist:K,getMedialist:Q,destroy:Z};function a(e){return function(e,t,n){var r={el:null,source:e,trial:t,canvas:n,init:B,show:H,hide:R,name:J,mediaName:Y,destroy:G};return r.data=e.data||{},r.handle=r.data.handle=r.data.handle||e.handle||e.set,r}(e,t,n)}}function K(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function Q(n){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.mediaName(n)||"media"+t})}function Z(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function ee(e,t){var n=t[e];if(n){if(!Array.isArray(n))throw new Error(e+" must be an array");if(!n.every(function(e){return"media"in e}))throw new Error("Each "+e+" stimulus must have a media property")}}var te=m(),ne={begin:function(e){return"begin"===e.type},inputEquals:function(e,t){return-1!==(Array.isArray(t.value)?t.value:[t.value]).indexOf(e.handle)},inputEqualsTrial:function(e,t,n){return e.handle===n.data[t.property]},inputEqualsStim:function(e,t,n){var r={};t.handle&&(r.handle=t.handle);return r[t.property]=e.handle,re(r,n)},trialEquals:function(e,t,n){if(h.isUndefined(t.property)||h.isUndefined(t.value))throw new Error('trialEquals requires both "property" and "value" to be defined');return t.value===n.data[t.property]},inputEqualsGlobal:function(e,t){if(h.isUndefined(t.property))throw new Error('inputEqualsGlobal requires "property" to be defined');return e.handle===te[t.property]},globalEquals:function(e,t){if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');return t.value===te[t.property]},globalEqualsTrial:function(e,t,n){if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');return te[t.globalProp]===n.data[t.trialProp]},globalEqualsStim:function(e,t,n){if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');var r={};t.handle&&(r.handle=t.handle);return r[t.stimProp]=te[t.globalProp],re(r,n)},currentEquals:function(e,t){var n=te.current;if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');return t.value===n[t.property]},currentEqualsTrial:function(e,t,n){var r=te.current;if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');return r[t.currentProp]===n.data[t.trialProp]},currentEqualsStim:function(e,t,n){var r=te.current;if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');var i={};t.handle&&(i.handle=t.handle);return i[t.stimProp]=r[t.currentProp],re(i,n)},inputEqualsCurrent:function(e,t){var n=te.current;if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');return e.handle===n[t.property]},fn:function(e,t,n){return t.value.apply(n,[t,e,n])},custom:function(e,t,n){return t.fn.apply(null,[t,e,n])}};function re(r,e){return e.stimulusCollection.stimuli.some(function(e){var t=e.data;for(var n in r)if(r[n]!==t[n])return!1;return!0})}function ie(e,n,r){return e=Array.isArray(e)?e:[e],("begin"!=n.type||!e.every(function(e){return"begin"!=e.type}))&&e.every(function(e){var t=function(e){if(h.isFunction(e))return e;if(h.isFunction(ne[e.type]))return ne[e.type];throw new Error("Unknown condition type: "+JSON.stringify(e))}(e)(n,e,r);return e.negate?!t:t})}var oe={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(e,t,n){var r=e.handle,i=e.setter;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||(h.isFunction(i)?i.apply(e):h.extend(e.data,i))})},setTrialAttr:function(e,t,n){var r=e.setter;if(void 0===r)throw new Error("The setTrialAttr action requires a setter property");h.isFunction(r)?r.apply(n,[n.data,t]):h.extend(n.data,r)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(e,t,n){var r=n.input,i=e.handle;if(void 0===i)throw new Error("The removeInput action requires a handle property");Array.isArray(i)||(i=[i]),h.includes(i,"All")?r.removeAll():i.forEach(r.remove)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(){},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():s.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[m(),e]);break;case"object":h.extend(m(),e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(e,t,n){var r=n.cavnas,i=d({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:r,property:"backgroundColor"},borderColor:{element:r,property:"borderColor"},borderWidth:{element:r,property:"borderWidth"}},h.pick(e,["background","canvasBackground","borderColor","borderWidth"]));n.$end.map(i)},startMouseTracking:function(t,e,u){if(u.data.listener)return u.$message({type:"warn",message:"Mouse tracking has already been activated."});var s=performance.now(),c=u.canvas,l=t.logAs||"mousetracker",n=getComputedStyle(c),d=parseInt(n.getPropertyValue("border-top-width")),f=parseInt(n.getPropertyValue("border-left-width")),m=u.stimulusCollection.stimuli.filter(function(e){return h.includes(t.logStimulusLocation,e.handle)}),r=h.throttle(function(e){var t=c.getBoundingClientRect(),r=t.x+f,i=t.y+d,n={mouseX:e.clientX-r,mouseY:e.clientY-i},o=m.reduce(function(e,t){var n=t.el.getBoundingClientRect();return h.set(e,t.handle+"X",n.x-r),h.set(e,t.handle+"Y",n.y-i),h.set(e,t.handle+"Width",n.width),h.set(e,t.handle+"Height",n.height),e},n),a=h.mapValues(h.set(o,"time",performance.now()-s),Math.round);u.data[l].push(a)},t.logRate||15);u.data[l]||(u.data[l]=[]),u.data.$listener=r,document.addEventListener("mousemove",r),u.$events.end.map(function(){document.removeEventListener("mousemove",r)})},stopMouseTracking:function(e,t,n){h.isFunction(n.data.$listener)&&(document.removeEventListener("mousemove",n.data.$listener),n.data.$listener=null)}};function ae(e,n,r){var i=!1;return e=h.isArray(e)?e:[e],h.forEach(e,function(e){var t=h.isFunction(e)?e:oe[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(i=!0),t(e,n,r)}),i}function ue(u){var s=0,c=u._source.interactions;try{!function(e){if(!Array.isArray(e))throw new Error("Interactions must be an array");if(!e.length)throw new Error("There are no interactions defined");if(!e.every(h.isPlainObject))throw new Error("Interactions must be plain objects");if(!e.every(t("conditions")))throw new Error("Conditions must be either an array or a function");if(!e.every(t("actions")))throw new Error("Actions must be either an array or a function");function t(t){return function(e){return Array.isArray(e[t])||h.isFunction(e[t])}}}(c)}catch(e){throw u.$messages({type:"error",message:"trial.interactions error",error:e,context:u._source}),e}return function(e){var t,n,r,i,o="Event: "+(e.handle||e.type),a=[];if(50<s)throw new Error("It seem you have created an infinite loop. Minno has been halted");s++;try{for(t=0;t<c.length&&(n=c[t],r=ie(n.conditions,e,u),a.push([r,n.conditions]),r&&(i=ae(n.actions,e,u)),!i);t++);}catch(e){throw u.$messages({type:"error",message:"trial.interactions error",error:e}),e}s--,u.$messages({type:"debug",message:o,rows:a}),i&&u.end();return e}}var se=0;function ce(e,t,n){if(!e.interactions)throw new Error("Interactions not defined");this.canvas=t,this.settings=n,this._source=e,this.$logs=p(),this.$messages=p(),this.$events=p(),this.$end=this.$events.end,this.data=e.data||{},this._id=h.uniqueId("trial_"),this.counter=se++,this.input=function(n,r){var i=[],o=0;return{add:function(e){if(!e)throw new Error("Missing input element. Could not add input listener");var t=L(e,r);t.map(function(e){return{handle:t.handle,event:e,timestamp:+new Date,latency:O()-o}}).map(n),i.push(t)},remove:function(e){for(var t=i.length-1;0<=t;t--){var n=i[t];n.handle===e&&(n.end(!0),i.splice(t,1))}},removeAll:function(){i.forEach(function(e){e.end(!0)}),i.length=0},resetTimer:function(){o=O()}}}(this.$events,t),this.stimulusCollection=V(this,t),this._next=["next",{}]}function le(e,t,n){var r=window.piGlobal,i=n.data,o=t,a=r.current.logs,u=h.get(n,"settings.logger.fullpath",!1),s=n.stimulusCollection.getStimlist(),c=n.stimulusCollection.getMedialist({fullpath:u});return{log_serial:a.length,trial_id:n.counter,name:n.name(),responseHandle:o.handle,latency:Math.floor(o.latency),stimuli:s,media:c,data:i}}function de(e){var r,i=e.canvas,n=e.db,o=e.settings,t=m(),a=p(),u=a.map(function(e){var t=r,n=r=new ce(e,i,o);return n.$logs.map(s),n.$messages.map(c),e.DEBUG&&window.DEBUG&&function(e){var t="Trial :"+e.counter;console.group(t),e.$messages.map(function(e){return"debug"!==e.type||(e.rows?(console.groupCollapsed(e.message),e.rows.forEach(function(e){console.log.apply(console,e)}),console.groupEnd(e.message)):console.log(e.message)),e}),e.$events.end.map(function(){console.groupEnd(t)})}(n),n.$end.map(function(){f(n._next)}),n.start(),t&&n.stimulusCollection.ready.then(function(){t.stimulusCollection.destroy()}),n}),s=p(),c=p(),l=function(e,t,n){var r,i=t.logger||t.logMap||n;return e.map((r=i,function(e){return r.apply(null,e)}))}(s,function(e,t){var n=h.assign({},h.get(e,"settings.logger")),r=h.assign({taskName:e.name},t.$meta,n.metaData);return n.metaData=r,n}(e.script,t),le),d=h.get(o,"hooks.endTask",o.onEnd||h.noop);return l.map(function(e){t.current.logs.push(e)}),a.end.map(u.end).map(s.end).map(function(){var e=u();e&&e.stimulusCollection.destroy()}).map(d),h.extend({$trial:u,end:a.end.bind(null,!0),$logs:l,$messages:c,start:f.bind(null,["next",{}]),onEnd:function(e){a.end.map(e)}},e);function f(e){var t=function(i,o,e){var t,n=e[0],r=e[1],a=i.currentSequence,u=m(),s={global:u,current:u.current};return a.go(n,r,s),t=a.current(s,{skip:["layout","stimuli"]}),(t=h.clone(t))?(t.stimuli=h.map(t.stimuli||[],l.bind(s)),t.layout=h.map(t.layout||[],l.bind(s)),s.trialData=null,{value:t}):{done:!0};function c(e,t,n){var r=e[t];if(h.isUndefined(r))return!1;h.isString(r)&&(r={word:r}),(r=i.inflate("media",r,n)).image&&(r.$image=k(o.base_url,r.image,"image")),r.template&&(r.inlineTemplate=requirejs("text!"+k(o.base_url,r.template,"template")),r.inlineTemplate=h.template(r.inlineTemplate)(n)),e[t]=r,n.mediaData=null,n.mediaMeta=null}function l(e){var t=this;return e=i.inflate("stimulus",e,t,{skip:["media","touchMedia"]}),c(e=h.clone(e),"media",t),c(e,"touchMedia",t),t.stimulusData=null,t.stimulusMeta=null,e}}(n,o,e);t.done?a.end(!0):a(t.value)}}return h.extend(ce.prototype,{start:function(){var e=this;return e.stimulusCollection.ready.then(function(){e.$events.map(function(t){return function(e){return h.assign(e,{trialId:t._id,counter:t.counter})}}(e)).map(ue(e)),h.forEach(e._source.input,e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this.input.removeAll(),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:h.isString(this._source.inherit)?this._source.inherit:h.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),function(e,t){var n=de(w(e,t));return n.$trial.end.map(n.$resize.end),function(e,t,n){var r=x(t,t.settings.base_url);if(1==r.progress())return Promise.resolve().then(o);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=e.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){s.mutate(function(){i.width=100*r.progress()+"%"})},r.onerror=function(e,t){n({type:"error",message:"Failed to preload",error:e,context:t})},r.all().then(o).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")});function o(){for(;e.firstChild;)e.removeChild(e.firstChild)}}(e,t,n.$messages).then(n.start),n}});
//# sourceMappingURL=time.js.map
