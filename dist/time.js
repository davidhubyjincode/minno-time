!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],e):t["minno-time"]=e(t._,t.Database)}(this,function(t,e){"use strict";function n(){console.log.apply(console,arguments)}function r(){return Y}function i(t,e,n){var r=this.mixerSequence;switch(t){case"nextWhere":case"previousWhere":o("next",e,n,r);break;case"current":break;case"first":do{r.prev(n)}while(r.current(n));break;case"last":do{r.next(n)}while(r.current(n));r.prev();break;case"end":do{r.next(n)}while(r.current(n));break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+t+'" for goto.')}return this}function o(e,n,r,i){var o;do{i[e](),o=i.current(r)}while(o&&!t.callback(n)(o.data))}function a(t){return parseFloat(t,10)||0}function u(e,n){function r(){var r=function(e,n){var r=function(e){if(t.isPlainObject(e.proportions)){if("number"!=typeof e.proportions.height||"number"!=typeof e.proportions.width)throw new Error("The canvas proportions object`s height and a width properties must be numeric");return e.proportions.height/e.proportions.width}return e.proportions||.8}(e);if(e.width)return{width:e.width,height:e.width*r};var i=window.document.documentElement,o=i.clientHeight,u=Math.min(e.maxWidth,i.clientWidth,function(t){var e=window.getComputedStyle(t);return{height:a(t.offsetHeight)-a(e.borderTopWidth)-a(e.borderBottomWidth),width:a(t.offsetWidth)-a(e.borderLeftWidth)-a(e.borderRightWidth)}}(n.parentNode).width);return o>r*u?{height:u*r,width:u}:{height:o,width:o/r}}(n,e),i=window.getComputedStyle(e);r.height-=s(i.borderTopWidth)+s(i.borderBottomWidth)+s(i.marginTop),r.width-=s(i.borderLeftWidth)+s(i.borderRightWidth),e.style.width=r.width+"px",e.style.height=r.height+"px",e.style.fontSize=r.height*(n.textSize||3)/100+"px",window.scrollTo(0,1)}return t.throttle(function(t){"orientationchange"==t.type?setTimeout(r,500):r()},16)}function s(t){return parseFloat(t,10)||0}function c(e,n){var r;if(!t.isPlainObject(e))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(t.isUndefined(n))return t.noop;if(!t.isPlainObject(n))throw new Error("canvas(settings): canvas settings must be an object");return r=t.map(n,function(t,n){var r=e[n];if(r)return function(t,e,n){var r=t.style[e];return t.style[e]=n,function(){t.style[e]=r}}(r.element,r.property,t);throw new Error("canvas("+n+"): unknow key in canvas object.")}),function(){t.forEach(r,function(t){t.call()})}}function l(t,e){return e={exports:{}},t(e,e.exports),e.exports}function d(n,o){var a=function(e,n){n||(n={});var r=K();if(!t.isElement(e))throw new Error("Minno-time: canvas is not a DOM element");e.classList.add("minno-canvas");var i=c({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},t.pick(n,["background","canvasBackground","borderColor","borderWidth"]));return n.css&&Q(e,n.css),r.map(u(e,n)),r({}),window.addEventListener("orientationchange",r),window.addEventListener("resize",r),r.end.map(function(){e.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",r),window.removeEventListener("resize",r)}).map(i),r}(n,t.get(o,"settings.canvas",{})),s=function(n){var r=new e;if(r.createColl("trial"),r.createColl("stimulus"),r.createColl("media"),r.add("trial",n.trialSets||[]),r.add("stimulus",n.stimulusSets||[]),r.add("media",n.mediaSets||[]),!t.isArray(n.sequence))throw new Error("You must set a sequence array.");var o=r.sequence("trial",n.sequence);return o.go=i,r.currentSequence=o,r}(o);return function(t){var e=r(r()),n=t.name||"anonymous minno-time",i=t.current?t.current:{};i.logs||(i.logs=[]),e[n]=e.current=i}(o),{db:s,$resize:a,canvas:n,script:o,settings:o.settings||{}}}function f(e,n,r){return"image"==r&&/^data:image/.test(n)?n:(t.isObject(e)&&(e=e[r]),e?"/"!=e[e.length-1]&&(e+="/"):e="",e+n)}function h(e,n){return function(e){var n=e.mediaSets,r=t.map(e.stimulusSets,p),i=t.map(e.trialSets,m),o=t.filter(e.sequence,v).map(m);return t.flattenDeep([n,r,i,o]).filter(w)}(e).forEach(function(e){t.isUndefined(e.image)||et.load(f(n,e.image,"image"),"image"),t.isUndefined(e.template)||et.load(f(n,e.template,"template"),"template")}),et}function m(e){return[t.map(e.input,function(t){return t.element}),t.map(e.stimuli,p),t.map(e.layout,p)]}function p(t){return t.media}function v(t){return!t.mixer}function w(e){return!t.isUndefined(e)}function g(t,e,n){var r=K(),i=e.element;return i&&(Q(i,e.css),nt.mutate(function(){n.appendChild(i)})),n.addEventListener(t,function(t){var n=t.target;return i&&n===i?r(t):i||n.getAttribute("data-handle")!==e.stimHandle?void 0:r(t)}),r.end.map(function(){i&&n.removeChild(i),n.removeEventListener(t,r)}),r}function y(t){function e(t){rt[t.which]||-1===r.indexOf(t.which)||(t.preventDefault(),rt[t.which]=!0,n(t))}var n=K(),r=(Array.isArray(t.key)?t.key:[t.key]).map(function(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t});return document.addEventListener("keydown",e),n.end.map(function(){document.removeEventListener("keydown",e)}),n}function b(e){var n,r=K(),i=function(e,n){if(t.isArray(e))return e[Math.floor(Math.random()*e.length)];if(t.isFunction(e))return e.call(n);if(t.isPlainObject(e)){if(!t.isNumber(e.min)||!t.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}(e.duration)||0;return r.end.map(function(){clearTimeout(n)}),i?setTimeout(r.bind(null,{}),i):r({}),r}function E(e,n){function r(t,e){var n=document.createElement("div");return Q(n,e),Q(n,t),n}var i=e.on;switch(i){case"keypressed":return y(e);case"keyup":return function(t){var e=K(),n=(Array.isArray(t.key)?t.key:[t.key]).map(function(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t});return document.addEventListener("keyup",function(t){if(-1!==n.indexOf(t.which))return t.preventDefault(),e(t)}),e.end.map(function(){document.removeEventListener("keyup",e)}),e}(e);case"click":case"mousedown":return g("mousedown",e,n);case"mouseup":return g("mouseup",e,n);case"mouseenter":return g("mouseenter",e,n);case"mouseleave":return g("mouseleave",e,n);case"timeout":return b(e);case"enter":return y(t.assign({key:13},e));case"space":return y(t.assign({key:32},e));case"esc":return y(t.assign({key:27},e));case"leftTouch":return e.element=r(e.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),g("mousedown",e);case"rightTouch":return e.element=r(e.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),g("mousedown",e);case"topTouch":return e.element=r(e.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),g("mousedown",e);case"bottomTouch":return e.element=r(e.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),g("mousedown",e);default:throw new Error('You have an input element with an unrecognized "on" property: '+i)}}function _(e,n){var r=function(e,n){var r;if(t.isFunction(e))return e(e,n,K);if(t.isPlainObject(e)){if(t.isString(e.on))return E(e,n);t.isFunction(e.on)&&(r=e.on(e,n,K)),t.isFunction(e.off)&&r.end.map(e.off)}throw new Error("Input must only contain objects and functions, do you have an undefined value?")}(e,n);if(!function(t){return t._state}(r))throw new Error("Input functions must return valid streams: "+function(e){return t.isFunction(e)?e.toString():JSON.stringify(e)}(e));return"handle"in e&&(r.handle=e.handle),r}function q(e){var n,r=e.html||e.inlineTemplate||e.template;return t.isFunction(e)?function(e){var n=e();return function(e){return e&&t.isFunction(e.then)}(n)?n.then(function(e){return t.isElement(e)?e:Promise.reject("Custom media must resolve with an element")}):Promise.reject(new Error("Custom media must return a promise"))}(e):(t.isString(e)&&(e={word:e}),e.word?(n=document.createElement("div"),n.textContent=e.word,Promise.resolve(n)):r?(n=document.createElement("div"),n.innerHTML=r,Promise.resolve(n)):e.image?new Promise(function(t,r){(n=document.createElement("img")).onload=function(){t(n)},n.onerror=function(){r(new Error("Image not found: "+n.src))},n.src=e.image}):e.jquery?Promise.reject(new Error("Jquery is no longer supported in minno-time")):Promise.reject(new Error("Unrecognized media type")))}function k(t,e){return t in e}function P(t,e){var n=e.location||{};("center"==n.top||"center"==n.bottom||void 0===n.top&&void 0===n.bottom)&&t.classList.add(ot),("center"==n.left||"center"==n.right||void 0===n.left&&void 0===n.right)&&t.classList.add(at),["top","bottom","left","right"].forEach(function(e){(function(t){return!isNaN(+t)})(n[e])&&(t.style[e]=n[e]+"%")})}function T(){if(!this.source.media)throw new Error("Media object not defined for "+this.name());return q(this.source.media).then(function(t,e){var n=this;return this.el=e,new Promise(function(r){nt.mutate(function(){e.classList.add("minno-stimulus"),e.setAttribute("data-handle",n.handle),function(t,e){var n=t.style,r=e.size||{};r.font_size&&(n.fontSize=r.font_size),k("height",r)&&!e.media.word&&(n.height=r.height+"%"),k("width",r)&&(n.width=r.width+"%")}(e,n.source),P(e,n.source),Q(e,n.source.css||{}),n.source.isLayout&&e.classList.add("minno-stimulus-visible"),t.appendChild(e),document.documentMode?function(t,e){var n=t.style,r=t.classList.contains(at),i=t.classList.contains(ot);if(!r&&!i)return e(t);nt.measure(function(){var e=window.getComputedStyle(t),o=parseFloat(e.width),a=parseFloat(e.height);nt.mutate(function(){n.transform="none",r&&(n.marginLeft="-"+o/2+"px"),i&&(n.marginTop="-"+a/2+"px")})})}(e,r):r(e)})})}.bind(this,this.canvas))}function x(){var t=this.el;if(!t)throw new Error("A stimulus can not be shown before init is called");nt.mutate(function(){t.classList.add("minno-stimulus-visible")})}function C(){var t=this.el;if(!t)throw new Error("A stimulus can not be hidden before init is called");nt.mutate(function(){t.classList.remove("minno-stimulus-visible")})}function A(){var t=this.el,e=this.canvas;nt.mutate(function(){e.removeChild(t)})}function S(){var t=this.source;return t.alias?t.alias:this.data.alias?this.data.alias:t.inherit&&t.inherit.set?t.inherit.set:this.handle?this.handle:void 0}function F(t){var e=this.source.media,n=t&&t.fullpath;if(e.alias)return e.alias;for(var r in e){if(j(["image","template"],r))return n?e[r]:e[r].replace(/^.*[\\/]/,"");if(j(["word","html","inlineTemplate"],r)&&e[r])return e[r]}}function j(t,e){return-1!=t.indexOf(e)}function O(e,n){function r(t){return function(t,e,n){var r={el:null,source:t,trial:e,canvas:n,init:T,show:x,hide:C,name:S,mediaName:F,destroy:A};return r.data=t.data||{},r.handle=r.data.handle=r.data.handle||t.handle||t.set,r}(t,e,n)}z("stimuli",e._source),z("layout",e._source);var i=e._source,o=t.map(i.stimuli,r),a=t.map(i.layout,function(t){return t.isLayout=!0,t}).map(r),u=Promise.all(o.concat(a).map(function(t){return t.init()}));return{canvas:n,stimuli:o,layout:a,ready:u,getStimlist:L,getMedialist:D,destroy:M}}function L(){return this.stimuli.filter(function(t){return!t.source.nolog}).map(function(t,e){return t.name()||"stim"+e})}function D(t){return this.stimuli.filter(function(t){return!t.source.nolog}).map(function(e,n){return e.mediaName(t)||"media"+n})}function M(){this.stimuli.concat(this.layout).forEach(function(t){t.destroy()})}function z(t,e){var n=e[t];if(n){if(!Array.isArray(n))throw new Error(t+" must be an array");if(!n.every(function(t){return"media"in t}))throw new Error("Each "+t+" stimulus must have a media property")}}function W(t,e){return e.stimulusCollection.stimuli.some(function(e){var n=e.data;for(var r in t)if(t[r]!==n[r])return!1;return!0})}function $(e,n,r){return e=Array.isArray(e)?e:[e],("begin"!=n.type||!e.every(function(t){return"begin"!=t.type}))&&e.every(function(e){return function(e){if(t.isFunction(e))return e;if(t.isFunction(st[e.type]))return st[e.type];throw new Error("Unknown condition type: "+JSON.stringify(e))}(e)(e,n,r)})}function U(e,n,r){var i=!0;return e=t.isArray(e)?e:[e],t.forEach(e,function(t){var e=ct[t.type];if(!e)throw new Error("unknown action: "+t.type);"endTrial"===t.type&&(i=!1),e(t,n,r)}),i}function I(e){var n=e._source.interactions,r=e._source.DEBUG&&window.DEBUG;return function(e){function n(e){return function(n){return Array.isArray(n[e])||t.isFunction(n[e])}}if(!Array.isArray(e))throw new Error("Interactions must be an array");if(!e.length)throw new Error("There are no interactions defined");if(!e.every(t.isPlainObject))throw new Error("Interactions must be plain objects");if(!e.every(n("conditions")))throw new Error("Conditions must be either an array or a function");if(!e.every(n("actions")))throw new Error("Actions must be either an array or a function")}(n),function(t){var i,o,a,u,s="Event: "+(t.handle||t.type);for(r&&console.groupCollapsed(s,t),i=0;i<n.length&&(o=n[i],a=$(o.conditions,t,e),r&&console.log(a,o.conditions),a&&(u=U(o.actions,t,e)),!u);i++);return r&&console.groupEnd(s),t}}function N(e,n,r){if(!e.interactions)throw new Error("Interactions not defined");this.canvas=n,this.settings=r,this._source=e,this.$logs=K(),this.$events=K(),this.$end=this.$events.end,this.data=e.data||{},this._id=t.uniqueId("trial_"),this.counter=lt++,this.input=function(t,e){var n=[],r=0;return{add:function(i){if(!i)throw new Error("Missing input element. Could not add input listener");var o=_(i,e);o.map(function(t){return{handle:o.handle,event:t,timestamp:+new Date,latency:it()-r}}).map(t),n.push(o)},remove:function(t){for(var e=n.length-1;e>=0;e--){var r=n[e];r.handle===t&&(r.end(!0),n.splice(e,1))}},removeAll:function(){n.forEach(function(t){t.end(!0)}),n.length=0},resetTimer:function(){r=it()}}}(this.$events,n),this.stimulusCollection=O(this,n),this._next=["next",{}]}function B(t,e){return new Promise(function(n,r){var i=new XMLHttpRequest;i.open("POST",t,!0),i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.onreadystatechange=function(){4===this.readyState&&(this.status>=200&&this.status<400?n(this.responseText):r(new Error("Failed posting to: "+t)))},i.send(function(t){return"string"==typeof t?t:JSON.stringify(t)}(e))})}function G(e,n){function r(e){var r=(n.serialize||(n.newServelet?function(e,n){var r=t.assign({data:e},n);return JSON.stringify(r)}:function(t,e){var n="json="+JSON.stringify(t),r=function(t){var e,n=[];for(e in t)n.push(encodeURIComponent(e)+"="+encodeURIComponent(t[e]));return n.join("&").replace(/%20/g,"+")}(e);return n+(r?"&"+r:"")}))(e,n.metaData);return B(o,r).catch(function(){return B(o,r)}).catch(n.error||t.noop)}var i=[],o=n.url;o&&(e.map(function(t){i.push(t),n.pulse&&i.length>=n.pulse&&(r(i),i.length=0)}),e.end.map(function(){i.length&&r(i)}))}function R(e,n,r){var i=window.piGlobal,o=r.data,a=n,u=i.current.logs,s=t.get(r,"settings.logger.fullpath",!1),c=r.stimulusCollection.getStimlist(),l=r.stimulusCollection.getMedialist({fullpath:s});return{log_serial:u.length,trial_id:r.counter,name:r.name(),responseHandle:a.handle,latency:Math.floor(a.latency),stimuli:c,media:l,data:o}}function H(e){function n(e){var n=function(e,n,i){function o(r,i,o){var a=r[i];if(t.isUndefined(a))return!1;t.isString(a)&&(a={word:a}),(a=e.inflate("media",a,o)).image&&(a.image=f(n.base_url,a.image,"image")),a.template&&(a.inlineTemplate=requirejs("text!"+f(n.base_url,a.template,"template")),a.inlineTemplate=t.template(a.inlineTemplate)(o)),r[i]=a,o.mediaData=null,o.mediaMeta=null}function a(t){return t=e.inflate("stimulus",t,this,{skip:["media","touchMedia"]}),o(t,"media",this),o(t,"touchMedia",this),this.stimulusData=null,this.stimulusMeta=null,t}var u,s=i[0],c=i[1],l=e.currentSequence,d=r(),h={global:d,current:d.current};return l.go(s,c,h),(u=l.current(h,{skip:["layout","stimuli"]}))?(u.stimuli=t.map(u.stimuli||[],a,h),u.layout=t.map(u.layout||[],a,h),h.trialData=null,{value:u}):{done:!0}}(o,a,e);n.done?u.end(!0):u(n.value)}var i=e.canvas,o=e.db,a=e.settings,u=K(),s=u.map(function(t){return function(e){var r=t,o=t=new N(e,i,a);return o.$logs.map(c),o.$end.map(function(){n(o._next)}),o.start(),r&&nt.mutate(function(){r.stimulusCollection.destroy()}),o}}()),c=K(),l=function(t,e,n){var r=t.map(function(t){return function(e){return t.apply(null,e)}}(e.logger||e.logMap||n));return e.poster?e.poster(r,e,G):G(r,e),r}(c,function(e,n){var r=t.assign({},t.get(e,"settings.logger")),i=t.assign({taskName:e.name},n.$meta,r.metaData);return r.metaData=i,r}(e.script,r()),R);l.map(function(t){r().current.logs.push(t)});var d=t.get(a,"hooks.endTask",a.onEnd||t.noop);return u.end.map(function(){var t=s();t&&t.stimulusCollection.destroy()}).map(d),t.extend({$trial:s,end:u.end.bind(null,!0),$logs:l,start:n.bind(null,["next",{}])},e)}t=t&&t.hasOwnProperty("default")?t.default:t,e=e&&e.hasOwnProperty("default")?e.default:e,Date.now||(Date.now=function(){return(new Date).getTime()}),console.group||(console.group=n),console.groupCollapsed||(console.groupCollapsed=n),console.groupEnd||(console.groupEnd=n),console.table||(console.table=n),function(){for(var t=["webkit","moz"],e=0;e<t.length&&!window.requestAnimationFrame;++e){var n=t[e];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(t){var e=Date.now(),n=Math.max(r+16,e);return setTimeout(function(){t(r=n)},n-e)},window.cancelAnimationFrame=clearTimeout}}();var J=function(t){function e(t,e){return function a(l){var d;try{if(!e||null==l||"object"!=typeof l&&"function"!=typeof l||"function"!=typeof(d=l.then))c(function(){e||0!==t.length||console.error("Possible unhandled promise rejection:",l);for(var n=0;n<t.length;n++)t[n](l);i.length=0,o.length=0,s.state=e,s.retry=function(){a(l)}});else{if(l===r)throw new TypeError("Promise can't be resolved w/ itself");n(d.bind(l))}}catch(t){u(t)}}}function n(t){function e(t){return function(e){n++>0||t(e)}}var n=0,r=e(u);try{t(e(a),r)}catch(t){r(t)}}if(!(this instanceof J))throw new Error("Promise must be called with `new`");if("function"!=typeof t)throw new TypeError("executor must be a function");var r=this,i=[],o=[],a=e(i,!0),u=e(o,!1),s=r._instance={resolvers:i,rejectors:o},c="function"==typeof setImmediate?setImmediate:setTimeout;n(t)};J.prototype.then=function(t,e){function n(t,e,n,a){e.push(function(e){if("function"!=typeof t)n(e);else try{r(t(e))}catch(t){i&&i(t)}}),"function"==typeof o.retry&&a===o.state&&o.retry()}var r,i,o=this._instance,a=new J(function(t,e){r=t,i=e});return n(t,o.resolvers,r,!0),n(e,o.rejectors,i,!1),a},J.prototype.catch=function(t){return this.then(null,t)},J.resolve=function(t){return t instanceof J?t:new J(function(e){e(t)})},J.reject=function(t){return new J(function(e,n){n(t)})},J.all=function(t){return new J(function(e,n){var r=t.length,i=0,o=[];if(0===t.length)e([]);else for(var a=0;a<t.length;a++)!function(a){function u(t){i++,o[a]=t,i===r&&e(o)}null==t[a]||"object"!=typeof t[a]&&"function"!=typeof t[a]||"function"!=typeof t[a].then?u(t[a]):t[a].then(u,n)}(a)})},J.race=function(t){return new J(function(e,n){for(var r=0;r<t.length;r++)t[r].then(e,n)})},void 0===window.Promise&&(window.Promise=J);var Y=window.piGlobal||(window.piGlobal={}),X="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},K=l(function(t){!function(){function e(){function t(){return arguments.length>0&&arguments[0]!==w&&n(t,arguments[0]),t._state.value}return function(t){t.constructor=e,t._state={id:v++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},t.map=t["fantasy-land/map"]=s,t["fantasy-land/ap"]=c,t["fantasy-land/of"]=e,t.valueOf=l,t.toJSON=d,t.toString=l,Object.defineProperties(t,{end:{get:function(){if(!t._state.endStream){var n=e();n.map(function(e){return!0===e&&(u(t),n._state.unregister=function(){u(n)}),e}),t._state.endStream=n}return t._state.endStream}}})}(t),arguments.length>0&&arguments[0]!==w&&n(t,arguments[0]),t}function n(t,e){r(t,e);for(var n in t._state.deps)i(t._state.deps[n],!1);null!=t._state.unregister&&t._state.unregister(),function(t){t._state.changed=!1;for(var e in t._state.deps)t._state.deps[e]._state.changed=!1}(t)}function r(t,e){t._state.value=e,t._state.changed=!0,2!==t._state.state&&(t._state.state=1)}function i(t,e){var n=t._state.parents;if(n.length>0&&n.every(h)&&(e||n.some(m))){var i=t._state.derive();if(i===w)return!1;r(t,i)}}function o(t,n){if(!n.every(f))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return function(t,e,n){var r=t._state;return r.derive=n,r.parents=e.filter(p),a(t,r.parents),i(t,!0),t}(e(),n,function(){return t.apply(this,n.concat([n.filter(m)]))})}function a(t,e){for(var n=0;n<e.length;n++)e[n]._state.deps[t._state.id]=t,a(t,e[n]._state.parents)}function u(t){for(var e=0;e<t._state.parents.length;e++){delete t._state.parents[e]._state.deps[t._state.id]}for(var n in t._state.deps){var r=t._state.deps[n],i=r._state.parents.indexOf(t);i>-1&&r._state.parents.splice(i,1)}t._state.state=2,t._state.deps={}}function s(t){return o(function(e){return t(e())},[this])}function c(t){return o(function(t,e){return t()(e())},[t,this])}function l(){return this._state.value}function d(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function f(t){return t._state}function h(t){return 1===t._state.state}function m(t){return t._state.changed}function p(t){return 2!==t._state.state}var v=0,w={};e["fantasy-land/of"]=e,e.merge=function(t){return o(function(){return t.map(function(t){return t()})},t)},e.combine=o,e.scan=function(t,e,n){var r=o(function(n){return e=t(e,n._state.value)},[n]);return 0===r._state.state&&r(e),r},e.scanMerge=function(t,e){var n=t.map(function(t){var e=t[0];return 0===e._state.state&&e(void 0),e});return o(function(){var r=arguments[arguments.length-1];return n.forEach(function(n,i){r.indexOf(n)>-1&&(e=t[i][1](e,n._state.value))}),e},n)},e.HALT=w,t.exports=e}()}),Q=function(t,e){var n=t.style;if(e)for(var r in e)n[function(t){return t.replace(/-([a-z])/g,function(t){return t[1].toUpperCase()})}(r)]=e[r]},V=[],Z=[],tt=0,et={load:function(t,e){var n;if(e=e||"image",-1!==V.indexOf(t))return!1;switch(e){case"template":n=new Promise(function(e,n){requirejs(["text!"+t],e,function(){n(new Error("Template not found: "+t))})});break;case"image":default:n=new Promise(function(e,n){var r=document.createElement("img");r.onload=function(){e(r)},r.onerror=function(){n(new Error("Image not found: "+r.src))},r.src=t})}return n.then(function(){tt++}).then(function(){et.onload&&et.onload()}),Z.push(n),V.push(t),n},all:function(){return Promise.all(Z)},progress:function(){return Z.length?tt/Z.length:1}},nt=l(function(t){!function(e){function n(){this.reads=[],this.writes=[],this.raf=u.bind(e)}function r(t){t.scheduled||(t.scheduled=!0,t.raf(function(t){var e,n=t.writes,o=t.reads;try{a("flushing reads",o.length),i(o),a("flushing writes",n.length),i(n)}catch(t){e=t}t.scheduled=!1,(o.length||n.length)&&r(t);if(e){if(a("task errored",e.message),!t.catch)throw e;t.catch(e)}}.bind(null,t)))}function i(t){for(var e;e=t.shift();)e()}function o(t,e){var n=t.indexOf(e);return!!~n&&!!t.splice(n,1)}var a=function(){},u=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(t){return setTimeout(t,16)};n.prototype={constructor:n,measure:function(t,e){var n=e?t.bind(e):t;return this.reads.push(n),r(this),n},mutate:function(t,e){var n=e?t.bind(e):t;return this.writes.push(n),r(this),n},clear:function(t){return o(this.reads,t)||o(this.writes,t)},extend:function(t){if("object"!=typeof t)throw new Error("expected object");var e=Object.create(this);return function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])}(e,t),e.fastdom=this,e.initialize&&e.initialize(),e},catch:null};var s=e.fastdom=e.fastdom||new n;t.exports=s}("undefined"!=typeof window?window:X)}),rt=[];document.addEventListener("keyup",function(t){rt[t.which]=!1});var it=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date),ot="minno-stimulus-center-y",at="minno-stimulus-center-x",ut=r(),st={begin:function(t){return"begin"===t.type},inputEquals:function(t,e){return-1!==(Array.isArray(e.value)?e.value:[e.value]).indexOf(t.handle)},inputEqualsTrial:function(t,e,n){return t.handle===n.data[e.property]},inputEqualsStim:function(t,e,n){var r={};return e.handle&&(r.handle=e.handle),r[e.property]=t.handle,W(r,n)},trialEquals:function(t,e,n){if(void 0===e.property||void 0===e.value)throw new Error('trialEquals requires both "property" and "value" to be defined');return e.value===n.data[e.property]},inputEqualsGlobal:function(t,e){if(void 0===e.property)throw new Error('inputEqualsGlobal requires "property" to be defined');return t.handle===ut[e.property]},globalEquals:function(t,e){if(void 0===e.property||void 0===e.value)throw new Error('globalEquals requires both "property" and "value" to be defined');return e.value===ut[e.property]},globalEqualsTrial:function(t,e,n){if(void 0===e.globalProp||void 0===e.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');return ut[e.globalProp]!==n.data[e.trialProp]},globalEqualsStim:function(t,e,n){if(void 0===e.globalProp||void 0===e.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');var r={};return e.handle&&(r.handle=e.handle),r[e.stimProp]=ut[e.globalProp],W(r,n)},currentEquals:function(t,e){var n=ut.current;if(void 0===e.property||void 0===e.value)throw new Error('currentEquals requires both "property" and "value" to be defined');return e.value!==n[e.property]},currentEqualsTrial:function(t,e,n){var r=ut.current;if(void 0===e.currentProp||void 0===e.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');return r[e.currentProp]===n.data[e.trialProp]},currentEqualsStim:function(t,e,n){var r=ut.current;if(void 0===e.currentProp||void 0===e.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');var i={};return e.handle&&(i.handle=e.handle),i[e.stimProp]=r[e.currentProp],W(i,n)},inputEqualsCurrent:function(t,e){var n=ut.current;if(void 0===e.property)throw new Error('inputEqualsCurrent requires "property" to be defined');return t.handle===n[e.property]},fn:function(t,e,n){return e.value.apply(n,[e,t,n])},custom:function(t,e,n){return e.fn.apply(null,[e,t,n])}},ct={showStim:function(t,e,n){var r=t.handle||t;n.stimulusCollection.stimuli.forEach(function(t){"All"!=r&&t.handle!=r||t.show()})},hideStim:function(t,e,n){var r=t.handle||t;n.stimulusCollection.stimuli.forEach(function(t){"All"!=r&&t.handle!=r||t.hide()})},setStimAttr:function(e,n,r){var i=e.handle,o=e.setter;r.stimulusCollection.stimuli.forEach(function(e){"All"!=i&&e.handle!=i||(t.isFunction(o)?o.apply(e):t.extend(e.data,o))})},setTrialAttr:function(e,n,r){var i=e.setter;if(void 0===i)throw new Error("The setTrialAttr action requires a setter property");t.isFunction(i)?i.apply(r,[r.data,n]):t.extend(r.data,i)},setInput:function(t,e,n){if(void 0===t.input)throw new Error("The setInput action requires an input property");n.input.add(t.input)},trigger:function(t,e,n){if(void 0===t.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:t.handle,on:"timeout",duration:+t.duration||0})},removeInput:function(e,n,r){var i=r.input,o=e.handle;if(void 0===o)throw new Error("The removeInput action requires a handle property");"All"==o||t.include(o,"All")?i.removeAll():i.remove(o)},goto:function(t,e,n){n._next=[t.destination,t.properties]},endTrial:function(t,e,n){n.end()},resetTimer:function(t,e,n){function r(){e.latency=0,n.input.resetTimer()}t.immidiate?r():nt.mutate(r)},log:function(t,e,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[r(),e]);break;case"object":t.extend(r(),e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(t,e,n){if("function"!=typeof t.fn)throw new Error("The custom action requires a fn propery");t.fn(t,e,n)},canvas:function(e,n,r){var i=r.cavnas,o=c({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:i,property:"backgroundColor"},borderColor:{element:i,property:"borderColor"},borderWidth:{element:i,property:"borderWidth"}},t.pick(e,["background","canvasBackground","borderColor","borderWidth"]));r.$end.map(o)}},lt=0;return t.extend(N.prototype,{start:function(){var e=this;return this._source.DEBUG&&window.DEBUG&&(console.group("Trial: "+this.counter),this.$end.map(function(){console.groupEnd("Trial: "+this.counter)})),e.stimulusCollection.ready.then(function(){e.$events.map(function(e){return function(n){return t.assign(n,{trialId:e._id,counter:e.counter})}}(e)).map(I(e)),t.forEach(e._source.input,e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this.input.removeAll(),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:t.isString(this._source.inherit)?this._source.inherit:t.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),function(t,e){var n=H(d(t,e));return n.$trial.end.map(n.$resize.end.bind(null,!0)),function(t,e){function n(){for(;t.firstChild;)t.removeChild(t.firstChild)}var r=h(e,e.base_url);if(1==r.progress())return Promise.resolve().then(n);t.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=t.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){nt.mutate(function(){i.width=100*r.progress()+"%"})},r.all().then(n).catch(function(t){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+t+")")})}(t,e).then(n.start),n}});
//# sourceMappingURL=time.js.map
