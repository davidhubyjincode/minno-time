!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("minno-sequencer")):"function"==typeof define&&define.amd?define(["lodash","minno-sequencer"],t):e["minno-time"]=t(e._,e.Database)}(this,function(_,u){"use strict";function e(){console.log.apply(console,arguments)}_=_&&_.hasOwnProperty("default")?_.default:_,u=u&&u.hasOwnProperty("default")?u.default:u,Date.now||(Date.now=function(){return(new Date).getTime()}),function(e){var t,n=["now","webkitNow","msNow","mozNow"];if(e.performance)for(var r=0;r<n.length;++r){var i=n[r];if(e.performance[i]){t=function(){return e.performance[i]()};break}}t||(t=Date.now),e.perfNow=t}(window),console.group||(console.group=e),console.groupCollapsed||(console.groupCollapsed=e),console.groupEnd||(console.groupEnd=e),console.table||(console.table=e),function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t){var n=e[t];window.requestAnimationFrame=window[n+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n+"CancelAnimationFrame"]||window[n+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var r=0;window.requestAnimationFrame=function(e){var t=Date.now(),n=Math.max(r+16,t);return setTimeout(function(){e(r=n)},n-t)},window.cancelAnimationFrame=clearTimeout}}();var f=function(e){if(!(this instanceof f))throw new Error("Promise must be called with `new`");if("function"!=typeof e)throw new TypeError("executor must be a function");var o=this,a=[],s=[],i=t(a,!0),u=t(s,!1),c=o._instance={resolvers:a,rejectors:s},l="function"==typeof setImmediate?setImmediate:setTimeout;function t(r,i){return function t(n){var e;try{if(!i||null==n||"object"!=typeof n&&"function"!=typeof n||"function"!=typeof(e=n.then))l(function(){i||0!==r.length||console.error("Possible unhandled promise rejection:",n);for(var e=0;e<r.length;e++)r[e](n);a.length=0,s.length=0,c.state=i,c.retry=function(){t(n)}});else{if(n===o)throw new TypeError("Promise can't be resolved w/ itself");d(e.bind(n))}}catch(e){u(e)}}}function d(e){var n=0;function t(t){return function(e){0<n++||t(e)}}var r=t(u);try{e(t(i),r)}catch(e){r(e)}}d(e)};f.prototype.then=function(e,t){var i,o,a=this._instance;function n(t,e,n,r){e.push(function(e){if("function"!=typeof t)n(e);else try{i(t(e))}catch(e){o&&o(e)}}),"function"==typeof a.retry&&r===a.state&&a.retry()}var r=new f(function(e,t){i=e,o=t});return n(e,a.resolvers,i,!0),n(t,a.rejectors,o,!1),r},f.prototype.catch=function(e){return this.then(null,e)},f.resolve=function(t){return t instanceof f?t:new f(function(e){e(t)})},f.reject=function(n){return new f(function(e,t){t(n)})},f.all=function(s){return new f(function(n,r){var i=s.length,o=0,a=[];if(0===s.length)n([]);else for(var e=0;e<s.length;e++)!function(t){function e(e){o++,a[t]=e,o===i&&n(a)}null==s[t]||"object"!=typeof s[t]&&"function"!=typeof s[t]||"function"!=typeof s[t].then?e(s[t]):s[t].then(e,r)}(e)})},f.race=function(r){return new f(function(e,t){for(var n=0;n<r.length;n++)r[n].then(e,t)})},void 0===window.Promise&&(window.Promise=f),function(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===n&&r.firstChild?r.insertBefore(i,r.firstChild):r.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".minno-canvas{height:400px;width:500px;position:relative;border:5px solid #fff;margin:auto;margin-top:10px;-webkit-text-size-adjust:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.minno-stimulus{position:absolute;text-align:center;overflow:hidden;visibility:hidden;width:fit-content}.minno-stimulus-visible{visibility:visible}.minno-stimulus-center-x{left:50%;transform:translateX(-50%)}.minno-stimulus-center-y{top:50%;transform:translateY(-50%)}.minno-stimulus-center-y.minno-stimulus-center-x{transform:translate(-50%,-50%)}.minno-progress{background-color:#20201f;border-radius:20px;padding:4px;position:relative;top:50%;width:80%;margin-left:10%;margin-top:-12px}.minno-progress-bar{background-color:#807b7a;width:0;height:16px;border-radius:10px}",{});var t=window.piGlobal||(window.piGlobal={});function x(){return t}function c(e,t,n){var r=this.mixerSequence;switch(e){case"nextWhere":i("next",t,n,r);break;case"previousWhere":i("prev",t,n,r);break;case"current":break;case"first":for(;r.prev(n),r.current(n););break;case"last":for(;r.next(n),r.current(n););r.prev();break;case"end":for(;r.next(n),r.current(n););break;case"next":r.next(n);break;default:throw new Error('Unknow destination "'+e+'" for goto.')}return this}function i(e,t,n,r){for(var i;r[e](),(i=r.current(n))&&!_.callback(t)(i.data););}var n="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var k=r(function(u){!function(e){var i=function(){},t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};function n(){this.reads=[],this.writes=[],this.raf=t.bind(e)}function o(e){e.scheduled||(e.scheduled=!0,e.raf(function(e){var t,n=e.writes,r=e.reads;try{i("flushing reads",r.length),a(r),i("flushing writes",n.length),a(n)}catch(e){t=e}e.scheduled=!1,(r.length||n.length)&&o(e);if(t){if(i("task errored",t.message),!e.catch)throw t;e.catch(t)}}.bind(null,e)))}function a(e){for(var t;t=e.shift();)t()}function r(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}n.prototype={constructor:n,measure:function(e,t){var n=t?e.bind(t):e;return this.reads.push(n),o(this),n},mutate:function(e,t){var n=t?e.bind(t):e;return this.writes.push(n),o(this),n},clear:function(e){return r(this.reads,e)||r(this.writes,e)},extend:function(e){if("object"!=typeof e)throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var s=e.fastdom=e.fastdom||new n;u.exports=s}("undefined"!=typeof window?window:n)});function l(e){return parseFloat(e,10)||0}function d(n,r){return _.throttle(function(e){"orientationchange"==e.type?setTimeout(t,500):t()},16);function t(){k.measure(function(){var e=function(e,t){var n=function(e){if(!_.isPlainObject(e))return e||.8;if([e.height,e.width].every(_.isFinite))return e.height/e.width;throw new Error("The canvas proportions object`s height and a width properties must be numeric")}(e.proportions);if(e.width)return{width:e.width,height:e.width*n};var r=window.document.documentElement,i=r.clientHeight,o=Math.min(e.maxWidth||1/0,r.clientWidth,(a=t.parentNode,s=window.getComputedStyle(a),{height:l(a.offsetHeight)-l(s.borderTopWidth)-l(s.borderBottomWidth),width:l(a.offsetWidth)-l(s.borderLeftWidth)-l(s.borderRightWidth)}).width);var a,s;return n*o<i?{height:o*n,width:o}:{height:i,width:i/n}}(r,n),t=window.getComputedStyle(n);e.height-=o(t.borderTopWidth)+o(t.borderBottomWidth)+o(t.marginTop),e.width-=o(t.borderLeftWidth)+o(t.borderRightWidth),k.mutate(function(){n.style.width=e.width+"px",n.style.height=e.height+"px",n.style.fontSize=e.height*(r.textSize||3)/100+"px",window.scrollTo(0,1)})})}}function o(e){return parseFloat(e,10)||0}function m(s,e){var t;if(!_.isPlainObject(s))throw new Error("canvas(map): You must set a rule map for canvas to work properly");if(_.isUndefined(e))return _.noop;if(!_.isPlainObject(e))throw new Error("canvas(settings): canvas settings must be an object");return t=_.map(e,function(e,t){var n,r,i,o,a=s[t];if(a)return n=a.element,r=a.property,i=e,o=n.style[r],n.style[r]=i,function(){n.style[r]=o};throw new Error("canvas("+t+"): unknow key in canvas object.")}),function(){_.forEach(t,function(e){e.call()})}}var q=r(function(e){!function(){var t=0,i={};function a(){function e(){return 0<arguments.length&&arguments[0]!==i&&r(e,arguments[0]),e._state.value}var n;return(n=e).constructor=a,n._state={id:t++,value:void 0,state:0,derive:void 0,recover:void 0,deps:{},parents:[],endStream:void 0,unregister:void 0},n.map=n["fantasy-land/map"]=l,n["fantasy-land/ap"]=d,n["fantasy-land/of"]=a,n.valueOf=f,n.toJSON=m,n.toString=f,Object.defineProperties(n,{end:{get:function(){if(!n._state.endStream){var t=a();t.map(function(e){return!0===e&&(c(n),t._state.unregister=function(){c(t)}),e}),n._state.endStream=t}return n._state.endStream}}}),0<arguments.length&&arguments[0]!==i&&r(e,arguments[0]),e}function r(e,t){for(var n in o(e,t),e._state.deps)s(e._state.deps[n],!1);null!=e._state.unregister&&e._state.unregister(),function(e){for(var t in e._state.changed=!1,e._state.deps)e._state.deps[t]._state.changed=!1}(e)}function o(e,t){e._state.value=t,e._state.changed=!0,2!==e._state.state&&(e._state.state=1)}function s(e,t){var n=e._state.parents;if(0<n.length&&n.every(p)&&(t||n.some(v))){var r=e._state.derive();if(r===i)return!1;o(e,r)}}function u(e,t){if(!t.every(h))throw new Error("Ensure that each item passed to stream.combine/stream.merge is a stream");return n=a(),r=t,i=function(){return e.apply(this,t.concat([t.filter(v)]))},(o=n._state).derive=i,o.parents=r.filter(g),function e(t,n){for(var r=0;r<n.length;r++)n[r]._state.deps[t._state.id]=t,e(t,n[r]._state.parents)}(n,o.parents),s(n,!0),n;var n,r,i,o}function c(e){for(var t=0;t<e._state.parents.length;t++){delete e._state.parents[t]._state.deps[e._state.id]}for(var n in e._state.deps){var r=e._state.deps[n],i=r._state.parents.indexOf(e);-1<i&&r._state.parents.splice(i,1)}e._state.state=2,e._state.deps={}}function l(t){return u(function(e){return t(e())},[this])}function d(e){return u(function(e,t){return e()(t())},[e,this])}function f(){return this._state.value}function m(){return null!=this._state.value&&"function"==typeof this._state.value.toJSON?this._state.value.toJSON():this._state.value}function h(e){return e._state}function p(e){return 1===e._state.state}function v(e){return e._state.changed}function g(e){return 2!==e._state.state}(a["fantasy-land/of"]=a).merge=function(e){return u(function(){return e.map(function(e){return e()})},e)},a.combine=u,a.scan=function(t,n,e){var r=u(function(e){return n=t(n,e._state.value)},[e]);return 0===r._state.state&&r(n),r},a.scanMerge=function(r,i){var e=r.map(function(e){var t=e[0];return 0===t._state.state&&t(void 0),t});return u(function(){var n=arguments[arguments.length-1];return e.forEach(function(e,t){-1<n.indexOf(e)&&(i=r[t][1](i,e._state.value))}),i},e)},a.HALT=i,e.exports=a}()}),h=function(e,t){var n=e.style;if(!t)return;for(var r in t)n[(i=r,i.replace(/-([a-z])/g,function(e){return e[1].toUpperCase()}))]=t[r];var i};function a(e,t){var n,r,i,o,a=function(e,t){t||(t={});var n=q();if(!_.isElement(e))throw new Error("Minno-time: canvas is not a DOM element");e.classList.add("minno-canvas");var r=m({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:e,property:"backgroundColor"},borderColor:{element:e,property:"borderColor"},borderWidth:{element:e,property:"borderWidth"}},_.pick(t,["background","canvasBackground","borderColor","borderWidth"]));return t.css&&h(e,t.css),n.map(d(e,t)),n({}),window.addEventListener("orientationchange",n),window.addEventListener("resize",n),n.end.map(function(){e.classList.remove("minno-canvas")}).map(function(){window.removeEventListener("orientationchange",n),window.removeEventListener("resize",n)}).map(r),n}(e,_.get(t,"settings.canvas",{})),s=function(e){var t=new u;if(t.createColl("trial"),t.createColl("stimulus"),t.createColl("media"),t.add("trial",e.trialSets||[]),t.add("stimulus",e.stimulusSets||[]),t.add("media",e.mediaSets||[]),!_.isArray(e.sequence))throw new Error("You must set a sequence array.");var n=t.sequence("trial",e.sequence);return n.go=c,t.currentSequence=n,t}(t);return n=t,r=x(x()),i=n.name||"anonymous minno-time",(o=n.current?n.current:{}).logs||(o.logs=[]),r[i]=r.current=o,{db:s,$resize:a,canvas:e,script:t,settings:t.settings||{}}}var s=[],p=[],v=0,g=_.memoize(function(r){return new Promise(function(e,t){var n=new XMLHttpRequest;n.open("GET",r,!0),n.onreadystatechange=function(){4===this.readyState&&(200<=this.status&&this.status<400?e(this.responseText):t(new Error("Template not found:"+r)))},n.send()})}),w={load:function(t,e){if(-1!==s.indexOf(t))return!1;var n="template"==e?g(t):(r=t,new Promise(function(e,t){var n=document.createElement("img");n.onload=function(){e(n)},n.onerror=function(){t(new Error("Image not found: "+r))},n.src=r}));var r;return n.then(function(){v++}).then(function(){w.onload&&w.onload(t)}).catch(function(e){w.onerror&&w.onerror(e,t)}),p.push(n),s.push(t),n},all:function(){return Promise.all(p)},progress:function(){return p.length?v/p.length:1}};function C(e,t,n){return"image"==n&&/^data:image/.test(t)?t:(_.isObject(e)&&(e=e[n]),e?"/"!=e[e.length-1]&&(e+="/"):e="",e+t)}function y(e,t){var n,r,i,o,a;return(n=e,r=n.mediaSets,i=_.map(n.stimulusSets,E),o=_.map(n.trialSets,b),a=_.filter(n.sequence,T).map(b),_.flattenDeep([r,i,o,a]).filter(A)).forEach(function(e){_.isUndefined(e.image)||w.load(C(t,e.image,"image"),"image");_.isUndefined(e.template)||w.load(C(t,e.template,"template"),"template")}),w}function b(e){return[_.map(e.input,function(e){return e.element}),_.map(e.stimuli,E),_.map(e.layout,E)]}function E(e){return e.media}function T(e){return!e.mixer}function A(e){return!_.isUndefined(e)}function P(e,n,t){var r=q(),i=n.element;return i&&(h(i,n.css),k.mutate(function(){t.appendChild(i)})),t.addEventListener(e,function(e){var t=e.target;return i&&t===i?r(e):i||t.getAttribute("data-handle")!==n.stimHandle?void 0:r(e)}),r.end.map(function(){i&&t.removeChild(i);t.removeEventListener(e,r)}),r}var S=[];function F(e){var t=q(),n=(Array.isArray(e.key)?e.key:[e.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e});return document.addEventListener("keydown",r),t.end.map(function(){document.removeEventListener("keydown",r)}),t;function r(e){S[e.which]||-1===n.indexOf(e.which)||(e.preventDefault(),S[e.which]=!0,t(e))}}function $(e){var t=q(),n=function(e,t){if(_.isArray(e))return e[Math.floor(Math.random()*e.length)];if(_.isFunction(e))return e.call(t);if(_.isPlainObject(e)){if(!_.isNumber(e.min)||!_.isNumber(e.max)||e.min>e.max)throw new Error("randomization objects need both a max and a minimum property, also max has to be larger than min");return e.min+(e.max-e.min)*Math.random()}return e}(e.duration)||0;return t.end.map(function(){clearTimeout(void 0)}),n?setTimeout(t.bind(null,{}),n):t({}),t}function j(e,t){var n,r,i,o=e.on;switch(o){case"keypressed":return F(e);case"keyup":return n=e,r=q(),i=(Array.isArray(n.key)?n.key:[n.key]).map(function(e){return"string"==typeof e?e.toUpperCase().charCodeAt(0):e}),document.addEventListener("keyup",function(e){if(-1!==i.indexOf(e.which))return e.preventDefault(),r(e)}),r.end.map(function(){document.removeEventListener("keyup",r)}),r;case"click":case"mousedown":return P("mousedown",e,t);case"mouseup":return P("mouseup",e,t);case"mouseenter":return P("mouseenter",e,t);case"mouseleave":return P("mouseleave",e,t);case"timeout":return $(e);case"enter":return F(_.assign({key:13},e));case"space":return F(_.assign({key:32},e));case"esc":return F(_.assign({key:27},e));case"leftTouch":return e.element=a(e.css,{position:"absolute",left:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),P("mousedown",e,t);case"rightTouch":return e.element=a(e.css,{position:"absolute",right:0,width:"30%",height:"100%",background:"#00FF00",opacity:.3}),P("mousedown",e,t);case"topTouch":return e.element=a(e.css,{position:"absolute",top:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),P("mousedown",e,t);case"bottomTouch":return e.element=a(e.css,{position:"absolute",bottom:0,width:"100%",height:"30%",background:"#00FF00",opacity:.3}),P("mousedown",e,t);default:throw new Error('You have an input element with an unrecognized "on" property: '+o)}function a(e,t){var n=document.createElement("div");return h(n,t),h(n,e),n}}function L(e,t){var n,r=function(e,t){var n;if(_.isFunction(e))return e(e,t,q);if(_.isPlainObject(e)){if(_.isString(e.on))return j(e,t);_.isFunction(e.on)&&(n=e.on(e,t,q)),_.isFunction(e.off)&&n.end.map(e.off)}throw new Error("Input must only contain objects and functions, do you have an undefined value?")}(e,t);if(!r._state)throw new Error("Input functions must return valid streams: "+(n=e,_.isFunction(n)?n.toString():JSON.stringify(n)));return"handle"in e&&(r.handle=e.handle),r}document.addEventListener("keyup",function(e){S[e.which]=!1});var O=window.performance.now?window.performance.now.bind(window.performance):Date.now.bind(Date);function M(n){var r,e,t,i=n.html||n.inlineTemplate||n.template;return _.isFunction(n)?(e=n(),(t=e)&&_.isFunction(t.then)?e.then(function(e){return _.isElement(e)?e:Promise.reject("Custom media must resolve with an element")}):Promise.reject(new Error("Custom media must return a promise"))):(z(n)&&(n={word:n}),z(n.word)?((r=document.createElement("div")).textContent=n.word,Promise.resolve(r)):i?((r=document.createElement("div")).innerHTML=i,Promise.resolve(r)):n.$image?new Promise(function(e,t){(r=document.createElement("img")).onload=function(){e(r)},r.onerror=function(){t(new Error("Image not found: "+r.src))},r.src=n.$image}):n.jquery?Promise.reject(new Error("Jquery is no longer supported in minno-time")):Promise.reject(new Error("Unrecognized media type")))}function z(e){return _.isString(e)||_.isNumber(e)}function N(e,t){var n,r=e.style,i=t.size||{};return i.font_size&&(r.fontSize=i.font_size),!D("height",i)||(n=t.media,_.isString(n)||_.isString(n.word))||(r.height=i.height+"%"),D("width",i)&&(r.width=i.width+"%"),e}function D(e,t){return e in t}var W="minno-stimulus-center-y",I="minno-stimulus-center-x";function U(n,e){var r=e.location||{};("center"==r.top||"center"==r.bottom||void 0===r.top&&void 0===r.bottom)&&n.classList.add(W),("center"==r.left||"center"==r.right||void 0===r.left&&void 0===r.right)&&n.classList.add(I),["top","bottom","left","right"].forEach(function(e){t=r[e],isNaN(+t)||(n.style[e]=r[e]+"%");var t})}function B(){var t=this.source,n=this.trial.$messages;if(!this.source.media)throw new Error("Media object not defined for "+this.name());return M(this.source.media).then(function(t,n){var r=this;return this.el=n,new Promise(function(e){k.mutate(function(){n.classList.add("minno-stimulus"),n.setAttribute("data-handle",r.handle),N(n,r.source),U(n,r.source),h(n,r.source.css||{}),r.source.isLayout&&n.classList.add("minno-stimulus-visible"),t.appendChild(n),document.documentMode?function(r,e){var i=r.style,o=r.classList.contains(I),a=r.classList.contains(W);if(!o&&!a)return e(r);k.measure(function(){var e=window.getComputedStyle(r),t=parseFloat(e.width),n=parseFloat(e.height);k.mutate(function(){i.transform="none",o&&(i.marginLeft="-"+t/2+"px"),a&&(i.marginTop="-"+n/2+"px")})})}(n,e):e(n)})})}.bind(this,this.canvas),function(e){throw n({type:"error",message:"trial.stimulus error",error:e,context:t}),e})}function R(){var e=this.el;if(!e)throw new Error("A stimulus can not be shown before init is called");k.mutate(function(){e.classList.add("minno-stimulus-visible")})}function G(){var e=this.el;if(!e)throw new Error("A stimulus can not be hidden before init is called");k.mutate(function(){e.classList.remove("minno-stimulus-visible")})}function H(){var e=this.el,t=this.canvas;k.mutate(function(){t.removeChild(e)})}function Y(){var e=this.source;return e.alias?e.alias:this.data.alias?this.data.alias:e.inherit&&e.inherit.set?e.inherit.set:this.handle?this.handle:void 0}function J(e){var t=this.source.media,n=e&&e.fullpath;if(t.alias)return t.alias;for(var r in t){if(X(["image","template"],r))return n?t[r]:t[r].replace(/^.*[\\/]/,"");if(X(["word","html","inlineTemplate"],r)&&t[r])return t[r]}}function X(e,t){return-1!=e.indexOf(t)}function V(r,i){ee("stimuli",r._source),ee("layout",r._source);var e=r._source,t=_.map(e.stimuli,a),n=_.map(e.layout,function(e){return e.isLayout=!0,e}).map(a),o=Promise.all(t.concat(n).map(function(e){return e.init()}));return{canvas:i,stimuli:t,layout:n,ready:o,getStimlist:K,getMedialist:Q,destroy:Z};function a(e){return(n={el:null,source:t=e,trial:r,canvas:i,init:B,show:R,hide:G,name:Y,mediaName:J,destroy:H}).data=t.data||{},n.handle=n.data.handle=n.data.handle||t.handle||t.set,n;var t,n}}function K(){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.name()||"stim"+t})}function Q(n){return this.stimuli.filter(function(e){return!e.source.nolog}).map(function(e,t){return e.mediaName(n)||"media"+t})}function Z(){this.stimuli.concat(this.layout).forEach(function(e){e.destroy()})}function ee(e,t){var n=t[e];if(n){if(!Array.isArray(n))throw new Error(e+" must be an array");if(!n.every(function(e){return"media"in e}))throw new Error("Each "+e+" stimulus must have a media property")}}var te=x(),ne={begin:function(e){return"begin"===e.type},inputEquals:function(e,t){return-1!==(Array.isArray(t.value)?t.value:[t.value]).indexOf(e.handle)},inputEqualsTrial:function(e,t,n){return e.handle===n.data[t.property]},inputEqualsStim:function(e,t,n){var r={};t.handle&&(r.handle=t.handle);return r[t.property]=e.handle,re(r,n)},trialEquals:function(e,t,n){if(_.isUndefined(t.property)||_.isUndefined(t.value))throw new Error('trialEquals requires both "property" and "value" to be defined');return t.value===n.data[t.property]},inputEqualsGlobal:function(e,t){if(_.isUndefined(t.property))throw new Error('inputEqualsGlobal requires "property" to be defined');return e.handle===te[t.property]},globalEquals:function(e,t){if(void 0===t.property||void 0===t.value)throw new Error('globalEquals requires both "property" and "value" to be defined');return t.value===te[t.property]},globalEqualsTrial:function(e,t,n){if(void 0===t.globalProp||void 0===t.trialProp)throw new Error('globalEqualsTrial requires both "globalProp" and "trialProp" to be defined');return te[t.globalProp]===n.data[t.trialProp]},globalEqualsStim:function(e,t,n){if(void 0===t.globalProp||void 0===t.stimProp)throw new Error('globalEqualsStim requires both "globalProp" and "stimProp" to be defined');var r={};t.handle&&(r.handle=t.handle);return r[t.stimProp]=te[t.globalProp],re(r,n)},currentEquals:function(e,t){var n=te.current;if(void 0===t.property||void 0===t.value)throw new Error('currentEquals requires both "property" and "value" to be defined');return t.value===n[t.property]},currentEqualsTrial:function(e,t,n){var r=te.current;if(void 0===t.currentProp||void 0===t.trialProp)throw new Error('currentEqualsTrial requires both "currentProp" and "trialProp" to be defined');return r[t.currentProp]===n.data[t.trialProp]},currentEqualsStim:function(e,t,n){var r=te.current;if(void 0===t.currentProp||void 0===t.stimProp)throw new Error('currentEqualsStim requires both "currentProp" and "stimProp" to be defined');var i={};t.handle&&(i.handle=t.handle);return i[t.stimProp]=r[t.currentProp],re(i,n)},inputEqualsCurrent:function(e,t){var n=te.current;if(void 0===t.property)throw new Error('inputEqualsCurrent requires "property" to be defined');return e.handle===n[t.property]},fn:function(e,t,n){return t.value.apply(n,[t,e,n])},custom:function(e,t,n){return t.fn.apply(null,[t,e,n])}};function re(r,e){return e.stimulusCollection.stimuli.some(function(e){var t=e.data;for(var n in r)if(r[n]!==t[n])return!1;return!0})}function ie(e,n,r){return e=Array.isArray(e)?e:[e],("begin"!=n.type||!e.every(function(e){return"begin"!=e.type}))&&e.every(function(e){var t=function(e){if(_.isFunction(e))return e;if(_.isFunction(ne[e.type]))return ne[e.type];throw new Error("Unknown condition type: "+JSON.stringify(e))}(e)(n,e,r);return e.negate?!t:t})}var oe={showStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.show()})},hideStim:function(e,t,n){var r=e.handle||e;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||e.hide()})},setStimAttr:function(e,t,n){var r=e.handle,i=e.setter;n.stimulusCollection.stimuli.forEach(function(e){"All"!=r&&e.handle!=r||(_.isFunction(i)?i.apply(e):_.extend(e.data,i))})},setTrialAttr:function(e,t,n){var r=e.setter;if(void 0===r)throw new Error("The setTrialAttr action requires a setter property");_.isFunction(r)?r.apply(n,[n.data,t]):_.extend(n.data,r)},setInput:function(e,t,n){if(void 0===e.input)throw new Error("The setInput action requires an input property");n.input.add(e.input)},trigger:function(e,t,n){if(void 0===e.handle)throw new Error("The trigger action requires a handle property");n.input.add({handle:e.handle,on:"timeout",duration:+e.duration||0})},removeInput:function(e,t,n){var r=n.input,i=e.handle;if(void 0===i)throw new Error("The removeInput action requires a handle property");Array.isArray(i)||(i=[i]),console.log(i),_.include(i,"All")?r.removeAll():i.forEach(r.remove)},goto:function(e,t,n){n._next=[e.destination,e.properties]},endTrial:function(){},resetTimer:function(e,t,n){function r(){t.latency=0,n.input.resetTimer()}e.immidiate?r():k.mutate(r)},log:function(e,t,n){n.$logs(arguments)},setGlobalAttr:function(e){switch(typeof e.setter){case"function":e.setter.apply(null,[x(),e]);break;case"object":_.extend(x(),e.setter);break;default:throw new Error('setGlobalAttr requires a "setter" property')}},custom:function(e,t,n){if("function"!=typeof e.fn)throw new Error("The custom action requires a fn propery");e.fn(e,t,n)},canvas:function(e,t,n){var r=n.cavnas,i=m({background:{element:document.body,property:"backgroundColor"},canvasBackground:{element:r,property:"backgroundColor"},borderColor:{element:r,property:"borderColor"},borderWidth:{element:r,property:"borderWidth"}},_.pick(e,["background","canvasBackground","borderColor","borderWidth"]));n.$end.map(i)},startMouseTracking:function(t,e,s){if(s.data.listener)return s.$message({type:"warn",message:"Mouse tracking has already been activated."});var u=performance.now(),c=s.canvas,l=t.logAs||"mousetracker",n=getComputedStyle(c),d=parseInt(n.getPropertyValue("border-top-width")),f=parseInt(n.getPropertyValue("border-left-width")),m=s.stimulusCollection.stimuli.filter(function(e){return _.contains(t.logStimulusLocation,e.handle)}),r=_.throttle(function(e){var t=c.getBoundingClientRect(),r=t.x+f,i=t.y+d,n={mouseX:e.clientX-r,mouseY:e.clientY-i},o=m.reduce(function(e,t){var n=t.el.getBoundingClientRect();return _.set(e,t.handle+"X",n.x-r),_.set(e,t.handle+"Y",n.y-i),_.set(e,t.handle+"Width",n.width),_.set(e,t.handle+"Height",n.height),e},n),a=_.mapValues(_.set(o,"time",performance.now()-u),Math.round);s.data[l].push(a)},t.logRate||15);s.data[l]||(s.data[l]=[]),s.data.$listener=r,document.addEventListener("mousemove",r),s.$events.end.map(function(){document.removeEventListener("mousemove",r)})},stopMouseTracking:function(e,t,n){_.isFunction(n.data.$listener)&&(document.removeEventListener("mousemove",n.data.$listener),n.data.$listener=null)}};function ae(e,n,r){var i=!1;return e=_.isArray(e)?e:[e],_.forEach(e,function(e){var t=_.isFunction(e)?e:oe[e.type];if(!t)throw new Error("unknown action: "+e.type);"endTrial"===e.type&&(i=!0),t(e,n,r)}),i}function se(s){var u=0,c=s._source.interactions;try{!function(e){if(!Array.isArray(e))throw new Error("Interactions must be an array");if(!e.length)throw new Error("There are no interactions defined");if(!e.every(_.isPlainObject))throw new Error("Interactions must be plain objects");if(!e.every(t("conditions")))throw new Error("Conditions must be either an array or a function");if(!e.every(t("actions")))throw new Error("Actions must be either an array or a function");function t(t){return function(e){return Array.isArray(e[t])||_.isFunction(e[t])}}}(c)}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e,context:s._source}),e}return function(e){var t,n,r,i,o="Event: "+(e.handle||e.type),a=[];if(50<u)throw new Error("It seem you have created an infinite loop. Minno has been halted");u++;try{for(t=0;t<c.length&&(n=c[t],r=ie(n.conditions,e,s),a.push([r,n.conditions]),r&&(i=ae(n.actions,e,s)),!i);t++);}catch(e){throw s.$messages({type:"error",message:"trial.interactions error",error:e}),e}u--,s.$messages({type:"debug",message:o,rows:a}),i&&s.end();return e}}var ue=0;function ce(e,t,n){if(!e.interactions)throw new Error("Interactions not defined");var r,i,o,a;this.canvas=t,this.settings=n,this._source=e,this.$logs=q(),this.$messages=q(),this.$events=q(),this.$end=this.$events.end,this.data=e.data||{},this._id=_.uniqueId("trial_"),this.counter=ue++,this.input=(r=this.$events,i=t,o=[],a=0,{add:function(e){if(!e)throw new Error("Missing input element. Could not add input listener");var t=L(e,i);t.map(function(e){return{handle:t.handle,event:e,timestamp:+new Date,latency:O()-a}}).map(r),o.push(t)},remove:function(e){for(var t=o.length-1;0<=t;t--){var n=o[t];n.handle===e&&(n.end(!0),o.splice(t,1))}},removeAll:function(){o.forEach(function(e){e.end(!0)}),o.length=0},resetTimer:function(){a=O()}}),this.stimulusCollection=V(this,t),this._next=["next",{}]}function le(e,t,n){var r=window.piGlobal,i=n.data,o=t,a=r.current.logs,s=_.get(n,"settings.logger.fullpath",!1),u=n.stimulusCollection.getStimlist(),c=n.stimulusCollection.getMedialist({fullpath:s});return{log_serial:a.length,trial_id:n.counter,name:n.name(),responseHandle:o.handle,latency:Math.floor(o.latency),stimuli:u,media:c,data:i}}function de(e){var o,t,n,r,i,a,s,u,c,l,d=e.canvas,f=e.db,m=e.settings,h=x(),p=q(),v=p.map(function(e){var t,n,r=o,i=o=new ce(e,d,m);return i.$logs.map(g),i.$messages.map(w),e.DEBUG&&window.DEBUG&&(n="Trial :"+(t=i).counter,console.group(n),t.$messages.map(function(e){return"debug"!==e.type||(e.rows?(console.groupCollapsed(e.message),e.rows.forEach(function(e){console.log.apply(console,e)}),console.groupEnd(e.message)):console.log(e.message)),e}),t.$events.end.map(function(){console.groupEnd(n)})),i.$end.map(function(){E(i._next)}),i.start(),r&&k.mutate(function(){r.stimulusCollection.destroy()}),i}),g=q(),w=q(),y=(t=g,s=e.script,u=h,c=_.assign({},_.get(s,"settings.logger")),l=_.assign({taskName:s.name},u.$meta,c.metaData),c.metaData=l,r=le,a=(n=c).logger||n.logMap||r,t.map((i=a,function(e){return i.apply(null,e)}))),b=_.get(m,"hooks.endTask",m.onEnd||_.noop);return y.map(function(e){h.current.logs.push(e)}),p.end.map(v.end).map(g.end).map(function(){var e=v();e&&e.stimulusCollection.destroy()}).map(b),_.extend({$trial:v,end:p.end.bind(null,!0),$logs:y,$messages:w,start:E.bind(null,["next",{}]),onEnd:function(e){p.end.map(e)}},e);function E(e){var t=function(i,o,e){var t,n=e[0],r=e[1],a=i.currentSequence,s=x(),u={global:s,current:s.current};return a.go(n,r,u),t=a.current(u,{skip:["layout","stimuli"]}),(t=_.clone(t))?(t.stimuli=_.map(t.stimuli||[],l,u),t.layout=_.map(t.layout||[],l,u),u.trialData=null,{value:t}):{done:!0};function c(e,t,n){var r=e[t];if(_.isUndefined(r))return!1;_.isString(r)&&(r={word:r}),(r=i.inflate("media",r,n)).image&&(r.$image=C(o.base_url,r.image,"image")),r.template&&(r.inlineTemplate=requirejs("text!"+C(o.base_url,r.template,"template")),r.inlineTemplate=_.template(r.inlineTemplate)(n)),e[t]=r,n.mediaData=null,n.mediaMeta=null}function l(e){var t=this;return e=i.inflate("stimulus",e,t,{skip:["media","touchMedia"]}),c(e=_.clone(e),"media",t),c(e,"touchMedia",t),t.stimulusData=null,t.stimulusMeta=null,e}}(f,m,e);t.done?p.end(!0):p(t.value)}}return _.extend(ce.prototype,{start:function(){var e=this;return e.stimulusCollection.ready.then(function(){var t;e.$events.map((t=e,function(e){return _.assign(e,{trialId:t._id,counter:t.counter})})).map(se(e)),_.forEach(e._source.input,e.input.add),e.input.resetTimer(),e.$events({type:"begin",latency:0})})},end:function(){this.input.removeAll(),this.$end(!0)},name:function(){return this.alias?this.alias:this.data.alias?this.data.alias:_.isString(this._source.inherit)?this._source.inherit:_.isPlainObject(this._source.inherit)?this._source.inherit.set:void 0}}),function(e,t){var n=de(a(e,t));return n.$trial.end.map(n.$resize.end),function(e,t,n){var r=y(t,t.settings.base_url);if(1==r.progress())return Promise.resolve().then(o);e.innerHTML='<div class="minno-progress"><div class="minno-progress-bar"></div></div>';var i=e.getElementsByClassName("minno-progress-bar")[0].style;return i.width=r.progress()+"%",r.onload=function(){k.mutate(function(){i.width=100*r.progress()+"%"})},r.onerror=function(e,t){n({type:"error",message:"Failed to preload",error:e,context:t})},r.all().then(o).catch(function(e){throw new Error("loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - "+e+")")});function o(){for(;e.firstChild;)e.removeChild(e.firstChild)}}(e,t,n.$messages).then(n.start),n}});
//# sourceMappingURL=time.js.map
