{"version":3,"file":"time.js","sources":["../src/polyfills.js","../src/app/global.js","../src/app/task/sequencer/sequenceGoto.js","../src/app/task/canvas/getSize.js","../src/app/task/canvas/adjust_canvas.js","../src/app/task/canvas/applyCanvasStyles.js","../src/app/setup.js","../src/app/task/canvas/canvasSetup.js","../src/app/task/sequencer/createDB.js","../src/app/task/sequencer/buildUrl.js","../src/app/task/sequencer/scriptPreloader.js","../src/app/trial/input/bindings/mouseEvents.js","../src/app/trial/input/bindings/keypressed.js","../src/app/trial/input/bindings/timeout.js","../src/app/trial/input/bindings/simpleRandomize.js","../src/app/trial/input/binder.js","../src/app/trial/input/bindings/keyup.js","../src/app/trial/input/createListener.js","../src/app/trial/stimulus/getMedia.js","../src/app/trial/stimulus/setSize.js","../src/app/trial/stimulus/setPlace.js","../src/app/trial/stimulus/Stimulus.js","../src/app/trial/stimulus/stimulusCollection.js","../src/app/trial/interactions/getConditionFn.js","../src/app/trial/interactions/conditionsEvaluate.js","../src/app/trial/interactions/action.js","../src/app/trial/interactions/interactions.js","../src/app/trial/Trial.js","../src/app/trial/input/input.js","../src/app/task/logger/post.js","../src/app/task/logger/poster.js","../src/app/task/logger/defaultLogMap.js","../src/app/playPhase.js","../src/app/task/sequencer/nextTrial.js","../src/app/task/logger/createLogStream.js","../node_modules/mithril-stream/stream.js","../node_modules/minno-css/css.js","../src/app/task/sequencer/preloader.js","../node_modules/fastdom/fastdom.js","../src/app/trial/input/now.js","../src/app/trial/interactions/actionList.js","../src/index.js","../src/app/preloadPhase.js"],"sourcesContent":["if (!Date.now) Date.now = function() { return new Date().getTime(); };\n\n(function(w){\n\tvar perfNow;\n\tvar perfNowNames = ['now', 'webkitNow', 'msNow', 'mozNow'];\n\tif(!!w['performance']) for(var i = 0; i < perfNowNames.length; ++i)\n\t{\n\t\tvar n = perfNowNames[i];\n\t\tif(!!w['performance'][n])\n\t\t{\n\t\t\tperfNow = function(){return w['performance'][n]()};\n\t\t\tbreak;\n\t\t}\n\t}\n\tif(!perfNow)\n\t{\n\t\tperfNow = Date.now;\n\t}\n\tw.perfNow = perfNow;\n})(window);\n\nfunction log(){ console.log.apply(console, arguments); }\nif (!console.group) console.group = log;\nif (!console.groupCollapsed) console.groupCollapsed = log;\nif (!console.groupEnd) console.groupEnd = log;\nif (!console.table) console.table = log;\n\n\n(function() {\n    'use strict';\n\n    var vendors = ['webkit', 'moz'];\n    for (var i = 0; i < vendors.length && !window.requestAnimationFrame; ++i) {\n        var vp = vendors[i];\n        window.requestAnimationFrame = window[vp+'RequestAnimationFrame'];\n        window.cancelAnimationFrame = (window[vp+'CancelAnimationFrame']\n            || window[vp+'CancelRequestAnimationFrame']);\n    }\n    // iOS6 is buggy\n    if (/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent) || !window.requestAnimationFrame || !window.cancelAnimationFrame) {\n        var lastTime = 0;\n        window.requestAnimationFrame = function(callback) {\n            var now = Date.now();\n            var nextTime = Math.max(lastTime + 16, now);\n            return setTimeout(function() { callback(lastTime = nextTime); },\n                              nextTime - now);\n        };\n        window.cancelAnimationFrame = clearTimeout;\n    }\n}());\n\n// Promise polyfill from https://github.com/MithrilJS/mithril.js/blob/next/promise/promise.js \n\"use strict\"\n/** @constructor */\nvar PromisePolyfill = function(executor) {\n    if (!(this instanceof PromisePolyfill)) throw new Error(\"Promise must be called with `new`\")\n        if (typeof executor !== \"function\") throw new TypeError(\"executor must be a function\")\n\n            var self = this, resolvers = [], rejectors = [], resolveCurrent = handler(resolvers, true), rejectCurrent = handler(rejectors, false)\n            var instance = self._instance = {resolvers: resolvers, rejectors: rejectors}\n            var callAsync = typeof setImmediate === \"function\" ? setImmediate : setTimeout\n            function handler(list, shouldAbsorb) {\n                return function execute(value) {\n                    var then\n                    try {\n                        if (shouldAbsorb && value != null && (typeof value === \"object\" || typeof value === \"function\") && typeof (then = value.then) === \"function\") {\n                            if (value === self) throw new TypeError(\"Promise can't be resolved w/ itself\")\n                                executeOnce(then.bind(value))\n                        }\n                        else {\n                            callAsync(function() {\n                                if (!shouldAbsorb && list.length === 0) console.error(\"Possible unhandled promise rejection:\", value)\n                                    for (var i = 0; i < list.length; i++) list[i](value)\n                                        resolvers.length = 0, rejectors.length = 0\n                                instance.state = shouldAbsorb\n                                instance.retry = function() {execute(value)}\n                            })\n                        }\n                    }\n                    catch (e) {\n                        rejectCurrent(e)\n                    }\n                }\n            }\n            function executeOnce(then) {\n                var runs = 0\n                function run(fn) {\n                    return function(value) {\n                        if (runs++ > 0) return\n                        fn(value)\n                    }\n                }\n                var onerror = run(rejectCurrent)\n                try {then(run(resolveCurrent), onerror)} catch (e) {onerror(e)}\n            }\n\n            executeOnce(executor)\n}\nPromisePolyfill.prototype.then = function(onFulfilled, onRejection) {\n    var self = this, instance = self._instance\n    function handle(callback, list, next, state) {\n        list.push(function(value) {\n            if (typeof callback !== \"function\") next(value)\n                else try {resolveNext(callback(value))} catch (e) {if (rejectNext) rejectNext(e)}\n        })\n        if (typeof instance.retry === \"function\" && state === instance.state) instance.retry()\n    }\nvar resolveNext, rejectNext\nvar promise = new PromisePolyfill(function(resolve, reject) {resolveNext = resolve, rejectNext = reject})\nhandle(onFulfilled, instance.resolvers, resolveNext, true), handle(onRejection, instance.rejectors, rejectNext, false)\nreturn promise\n}\nPromisePolyfill.prototype.catch = function(onRejection) {\n    return this.then(null, onRejection)\n}\nPromisePolyfill.resolve = function(value) {\n    if (value instanceof PromisePolyfill) return value\n    return new PromisePolyfill(function(resolve) {resolve(value)})\n}\nPromisePolyfill.reject = function(value) {\n    return new PromisePolyfill(function(resolve, reject) {reject(value)})\n}\nPromisePolyfill.all = function(list) {\n    return new PromisePolyfill(function(resolve, reject) {\n        var total = list.length, count = 0, values = []\n        if (list.length === 0) resolve([])\n            else for (var i = 0; i < list.length; i++) {\n                (function(i) {\n                    function consume(value) {\n                        count++\n                            values[i] = value\n                            if (count === total) resolve(values)\n                    }\n                if (list[i] != null && (typeof list[i] === \"object\" || typeof list[i] === \"function\") && typeof list[i].then === \"function\") {\n                    list[i].then(consume, reject)\n                }\n                else consume(list[i])\n                })(i)\n            }\n    })\n}\nPromisePolyfill.race = function(list) {\n    return new PromisePolyfill(function(resolve, reject) {\n        for (var i = 0; i < list.length; i++) {\n            list[i].then(resolve, reject)\n        }\n    })\n}\n\nif (typeof window.Promise === \"undefined\") window.Promise = PromisePolyfill\n","export default global;\n\n// initiate piGloabl\nvar glob = window.piGlobal || (window.piGlobal = {});\n\nfunction global(){\n    return glob;\n}\n\n","/**\n * Go to a destination within the sequence (must be a property of a sequence)\n * @param  {String} target destination type\n * @param  {Object} properties destination options\n * @return {Object}        result element\n */\n\nimport _ from 'lodash';\nexport default go;\n\nfunction go(destination, properties, context){\n    var mixerSequence = this.mixerSequence;\n\n    switch (destination){\n        case 'nextWhere':\n            where('next', properties, context, mixerSequence);\n            break;\n        case 'previousWhere':\n            where('next', properties, context, mixerSequence);\n            break;\n        case 'current':\n            // don't need to do anything...\n            break;\n        case 'first':\n            do {mixerSequence.prev(context);} while (mixerSequence.current(context));\n            break;\n        case 'last':\n            do {mixerSequence.next(context);} while (mixerSequence.current(context));\n            mixerSequence.prev();\n            break;\n        case 'end':\n            do {mixerSequence.next(context);} while (mixerSequence.current(context));\n            break;\n        case 'next' :\n            mixerSequence.next(context); // get the next trial, in case there are no more trials, returns undefined\n            break;\n        default:\n            throw new Error('Unknow destination \"' + destination + '\" for goto.');\n    }\n\n    return this;\n}\n\nfunction where(direction, properties, context, sequence){\n    var curr;\n\n    do {\n        sequence[direction]();\n        curr = sequence.current(context);\n    } while (curr && !_.callback(properties)(curr.data));\n}\n","export default getSize;\n\n// helper function: returns sizes of element;\nfunction getSize(el){\n    var computedStyle = window.getComputedStyle(el);\n    return {\n        height    : parse(el.offsetHeight) - parse(computedStyle.borderTopWidth) - parse(computedStyle.borderBottomWidth),\n        width    : parse(el.offsetWidth) - parse(computedStyle.borderLeftWidth) - parse(computedStyle.borderRightWidth)\n    };\n}\n\nfunction parse(num){ return parseFloat(num, 10) || 0;}\n","/*\n * adjust canvas according to window size and settings\n * this module is built to be part of the main view\n */\n\nimport _ from 'lodash';\nimport getSize from './getSize';\n\nexport default adjust_canvas;\n\n// the function to be used by the main view\nfunction adjust_canvas(canvas, settings){\n\n    return _.throttle(eventListener, 16);\n\n    function eventListener(event){\n        // we put this in a time out because of a latency of orientation change on android devices\n        if (event.type == 'orientationchange') setTimeout(resize, 500);\n        else resize();\n    }\n\n    function resize(){\n        var targetSize = getTargetSize(settings, canvas);\n\n        // remove border width and top margin from calculated width (can't depend on cool box styles yet...)\n        // we compute only margin-top because of a difference calculating margins between chrome + IE and firefox + mobile\n        var computedStyle = window.getComputedStyle(canvas);\n        targetSize.height -= parse(computedStyle.borderTopWidth) + parse(computedStyle.borderBottomWidth) + parse(computedStyle.marginTop);\n        targetSize.width -= parse(computedStyle.borderLeftWidth) + parse(computedStyle.borderRightWidth);\n\n        // reset canvas size\n        canvas.style.width = targetSize.width + 'px';\n        canvas.style.height = targetSize.height + 'px';\n        canvas.style.fontSize = targetSize.height*(settings.textSize || 3)/100 + 'px';\n\n        // scroll to top of window (hides some of the mess on the top of mobile devices)\n        window.scrollTo(0, 1);\n    }\n}\n\nfunction getProportions(settings){\n    // if proportions are an object they should include width and height\n    if (_.isPlainObject(settings.proportions)) {\n        if (typeof settings.proportions.height !== 'number' || typeof settings.proportions.width !== 'number'){\n            throw new Error('The canvas proportions object`s height and a width properties must be numeric');\n        }\n        return settings.proportions.height/settings.proportions.width; \n    } \n    return settings.proportions || 0.8; // by default proportions are 0.8\n}\n\nfunction getTargetSize(settings, canvas){\n    // calculate proportions (as height/width)\n    var proportions = getProportions(settings);\n\n    // static canvas size\n    // ------------------\n    if (settings.width) return {\n        width: settings.width,\n        height: settings.width*proportions\n    };\n\n    // dynamic canvas size\n    // -------------------\n\n    var docElement = window.document.documentElement; // used to get client view size\n\n    var maxHeight = docElement.clientHeight;\n    var maxWidth = Math.min(settings.maxWidth, docElement.clientWidth, getSize(canvas.parentNode).width);\n\n    // calculate the correct size for this screen size\n    if (maxHeight > proportions * maxWidth) return { height: maxWidth*proportions, width: maxWidth };\n    else return { height: maxHeight, width: maxHeight/proportions};\n}\n\nfunction parse(num){ return parseFloat(num, 10) || 0;}\n","/**\n *\n * This whole module taken from piManager\n *\n */\n\nimport _ from 'lodash';\nexport default canvasContructor;\n\n/**\n * Takes a map of css rules and applies them.\n * Returns a function that returns the page to its former condition.\n *\n * The rule map is an object of ruleName -> ruleObject.\n *\n * var ruleObject = {\n * \telement : wrapped element to affect\n * \tproperty: css property to modify\n * }\n *\n * @param  {Object} map      A hash of rules.\n * @param  {Object} settings A hash of ruleName -> value\n * @return {Function}        A function that undoes all the previous changes\n */\nfunction canvasContructor(map, settings){\n    var offArr;\n\n    if (!_.isPlainObject(map)) throw new Error('canvas(map): You must set a rule map for canvas to work properly');\n\n    // if settings is undefined return a function that doesn't do anything\n    // just so we don't need to make sure that the user modifies the canvas\n    if (_.isUndefined(settings)) return _.noop;\n    if (!_.isPlainObject(settings)) throw new Error('canvas(settings): canvas settings must be an object');\n\n    // create an array of off functions to undo any changes by this action\n    offArr = _.map(settings, function(value,key){\n        var rule = map[key];\n        if (rule) return on(rule.element, rule.property, value);\n        throw new Error('canvas('+ key +'): unknow key in canvas object.');\n    });\n\n    return function off(){\n        _.forEach(offArr, function(fn){fn.call();});\n    };\n}\n\nfunction on(el, property, value){\n    var old = el.style[property]; // save old value\n    el.style[property] = value; // set new value\n    return function(){el.style[property] = old;};  // create off function\n}\n\n","import _ from 'lodash';\nimport global from './global';\nimport createDB from './task/sequencer/createDB';\nimport canvasSetup from './task/canvas/canvasSetup';\n\nexport default setup;\n\nfunction setup(canvas, script){\n    var $resize = canvasSetup(canvas, _.get(script, 'settings.canvas', {}));\n    var db = createDB(script);\n    setupVars(script);\n\n    return {\n        db:db, \n        $resize:$resize,\n        canvas: canvas,\n        script: script,\n        settings: script.settings || {}\n    };\n}\n\nfunction setupVars(script){\n    // init global\n    var glob = global(global());\n    var name = script.name || 'anonymous minno-time';\n    var current = script.current ? script.current : {};\n\n    current.logs || (current.logs = []); // init logs object\n    glob[name] = glob.current = current; // create local namespace\n}\n","import _ from 'lodash';\nimport adjustCanvas from './adjust_canvas';\nimport applyCanvasStyles from './applyCanvasStyles';\nimport stream from 'mithril-stream';\nimport css from 'minno-css';\n\nexport default setupCanvas;\n\nfunction setupCanvas(canvas, canvasSettings){\n    canvasSettings || (canvasSettings = {});\n    var $resize = stream();\n\n    if (!_.isElement(canvas)) throw new Error('Minno-time: canvas is not a DOM element');\n\n    canvas.classList.add('minno-canvas');\n\n    // apply canvas styles\n    var map = {\n        background \t\t\t: {element: document.body, property: 'backgroundColor'},\n        canvasBackground\t: {element: canvas, property:'backgroundColor'},\n        borderColor\t\t\t: {element: canvas, property:'borderColor'},\n        borderWidth\t\t\t: {element: canvas, property:'borderWidth'}\n    };\n\n    var off = applyCanvasStyles(map, _.pick(canvasSettings,['background','canvasBackground','borderColor','borderWidth']));\n\n    canvasSettings.css && css(canvas, canvasSettings.css);\n\n    // setup canvas resize\n    $resize.map(adjustCanvas(canvas, canvasSettings));\n    $resize({});\n\n    window.addEventListener('orientationchange', $resize);\n    window.addEventListener('resize', $resize);\n\n    $resize.end\n        .map(function(){canvas.classList.remove('minno-canvas');})\n        .map(function removeListeners(){\n            window.removeEventListener('orientationchange',$resize);\n            window.removeEventListener('resize', $resize);\n        })\n        .map(off);\n\n\n\n    return $resize;\n\n}\n","/*\n * this file is resposible for taking the experiment script (json) and parsing it\n */\n\n// load dependancies\nimport _ from 'lodash';\nimport Database from 'minno-sequencer';\nimport go from './sequenceGoto';\n\nexport default createDB;\n\nfunction createDB(script){\n    var db = new Database();\n    db.createColl('trial');\n    db.createColl('stimulus');\n    db.createColl('media');\n\n    db.add('trial', script.trialSets || []);\n    db.add('stimulus', script.stimulusSets || []);\n    db.add('media', script.mediaSets || []);\n\n    if (!_.isArray(script.sequence)) throw new Error('You must set a sequence array.');\n\n    var sequence = db.sequence('trial', script.sequence);\n    sequence.go = go; // see sequence/goto.js to understand why we are doing this\n    db.currentSequence = sequence;\n    return db;\n}\n","/*\n * build the url for this src (add the generic baseUrl)\n */\n\nimport _ from 'lodash';\n\n/**\n * @param baseUrl {String|Object} the base url to prepend\n * @param url {String} the url we are dealing with\n * @param type {String} the type of resource we are dealing with (image or tempmlate) in case we have multiple base urls\n *\n * @returns String built url\n **/\nexport default function buildUrl(baseUrl, url, type){\n    // it this is a dataUrl type of image, we don't need to append the baseurl\n    if (type == 'image' && /^data:image/.test(url)) return url;\n\n    // the base url setting may be either a string, or an object with the type as a field\n    if (_.isObject(baseUrl)) baseUrl = baseUrl[type];\n\n    // make sure base url is set, and add trailing slash if needed\n    if (!baseUrl) baseUrl = '';\n    else if (baseUrl[baseUrl.length-1] != '/') baseUrl += '/';\n\n    return baseUrl + url;\n}\n","/*\n * gets all media that needs preloading and preloads it\n */\n\nimport _ from 'lodash';\nimport preloader from './preloader';\nimport buildUrl from './buildUrl';\n\nexport default preloadScript;\n\nfunction preloadScript(script, baseUrl){\n    getScriptMedia(script).forEach(loadMedia);\n    return preloader;\n\n    function loadMedia(media){\n        if (!_.isUndefined(media.image)) preloader.load(buildUrl(baseUrl, media.image, 'image'),'image');\n        if (!_.isUndefined(media.template)) preloader.load(buildUrl(baseUrl, media.template,'template'),'template');\n    }\n}\n\n/**\n * Iterates over a script and gathers all media\n **/\nexport function getScriptMedia(script){\n    var mediaSets = script.mediaSets;\n    var stimulusSets = _.map(script.stimulusSets, getStimMedia);\n    var trialSets = _.map(script.trialSets, getTrialMedia);\n    var sequence = _.filter(script.sequence,notMixer).map(getTrialMedia);\n\n    return _.flattenDeep([mediaSets, stimulusSets, trialSets, sequence]).filter(notUndefined);\n} \n\nfunction getTrialMedia(trial){\n    return [\n        _.map(trial.input, function(input){ return input.element; }),\n        _.map(trial.stimuli, getStimMedia),\n        _.map(trial.layout, getStimMedia)\n    ];\n}\n\nfunction getStimMedia(stim){ return stim.media; }\nfunction notMixer(trial){ return !trial.mixer; }\nfunction notUndefined(val){ return !_.isUndefined(val); }\n","import css from 'minno-css';\nimport fastdom from 'fastdom';\nimport stream from 'mithril-stream';\n\nexport default mouseEvents;\n\nfunction mouseEvents(eventName,inputObj, canvas){\n    var $listener = stream();\n    var element = inputObj.element;\n\n    if (element){\n        css(element, inputObj.css);\n        fastdom.mutate(function(){\n            canvas.appendChild(element);\n        });\n    }\n\n    canvas.addEventListener(eventName, clickListener);\n\n    $listener.end.map(removeClickListener);\n    return $listener;\n\n    function clickListener(e){\n        var target = e.target;\n        if (element && target === element) return $listener(e);\n        if (!element && target.getAttribute('data-handle') === inputObj.stimHandle) return $listener(e);\n        return;\n    }\n\n    function removeClickListener(){\n        if (element) canvas.removeChild(element);\n        canvas.removeEventListener(eventName, $listener);\n    }\n}\n","/*\n* key pressed listener\n* reqires key\n*\n* key can be either charCode or string.\n* or an array of charCode/strings.\n*/\n\n// we monitor all key up events so that we trigger only once per key down\nimport stream from 'mithril-stream';\nexport default keypressed;\n\nvar keyDownArr = [];\n\ndocument.addEventListener('keyup',function(e){ keyDownArr[e.which] = false; });// unset flag to prevent multi pressing of a key \n\nfunction keypressed(inputObj){\n    var $listener = stream();\n\n    // make sure key is an array\n    var keys = Array.isArray(inputObj.key) ? inputObj.key : [inputObj.key];\n\n    // map keys to keyCodes\n    var target = keys.map(function(value){ \n        return typeof value == 'string' ? value.toUpperCase().charCodeAt(0) : value; \n    });\n\n    document.addEventListener('keydown', keypressListener);\n\n    $listener.end.map(removeKeypressListener);\n    return $listener;\n\n    function keypressListener(e){\n        if (keyDownArr[e.which] || (target.indexOf(e.which) === -1)) return;\n        e.preventDefault(); // prevent FF from wasting about 10ms in browser-content.js (and fast search)\n        keyDownArr[e.which] = true; // set flag to prevent multi pressing of a key\n        $listener(e);\n    }\n\n    function removeKeypressListener(){\n        document.removeEventListener('keydown', keypressListener);\n    }\n}\n","import randomize from './simpleRandomize';\nimport stream from 'mithril-stream';\n\nexport default timeout;\n\nfunction timeout(inputObj){\n    var $listener = stream();\n    var timeoutID;\n    var duration = randomize(inputObj.duration) || 0;\n\n    $listener.end.map(cancel);\n\n    if (duration) setTimeout($listener.bind(null, {}), duration);\n    else $listener({}); // listener is already registered with $events so this should be immidiate\n\n    return $listener;\n\n    function cancel(){\n        clearTimeout(timeoutID);\n    }\n}\n","/**\n *\tTakes a properties objects and returns the result of a randomization:\n *\tIf it is an array - pick a random member\n *\tIf it is an object pick from within a range\n *\tIf it is a function return its result using the context\n *\tOtherwise simply return the properties\n */\nimport _ from 'lodash';\n\nexport default simpleRandomize;\n\nfunction simpleRandomize(properties, context){\n\n    if (_.isArray(properties)) {\n        var index = Math.floor(Math.random()*properties.length);\n        return properties[index];\n    }\n\n    if (_.isFunction(properties)) {\n        return properties.call(context);\n    }\n\n    // this must be after the test for arrays and functions, because they are considered objects too\n    if (_.isPlainObject(properties)) {\n        if (!_.isNumber(properties.min) || !_.isNumber(properties.max) || properties.min > properties.max) {\n            throw new Error('randomization objects need both a max and a minimum property, also max has to be larger than min');\n        }\n        return properties.min + (properties.max - properties.min) * Math.random();\n    }\n\n    // if this is not a randomization object simply return\n    return properties;\n}\n\n","\nimport _ from 'lodash';\nimport mouseEvents from './bindings/mouseEvents';\nimport keypressed from './bindings/keypressed';\nimport keyup from './bindings/keyup';\nimport timeout from './bindings/timeout';\nimport css from 'minno-css';\n\nexport default inputBinder;\n\n/**\n * The input binder is a hash of default input types\n * It returns a stream of events\n **/\nfunction inputBinder(inputObj, canvas){\n    var on = inputObj.on; // what type of binding is this?\n\n    switch (on){\n\n        case 'keypressed'\t: return keypressed(inputObj);\n\n        case 'keyup'\t\t: return keyup(inputObj);\n\n        case 'click'\t\t:\n        case 'mousedown'    :\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'mouseup'\t    : return mouseEvents('mouseup', inputObj, canvas);\n\n        case 'mouseenter'\t: return mouseEvents('mouseenter', inputObj, canvas);\n\n        case 'mouseleave'\t: return mouseEvents('mouseleave', inputObj, canvas);\n\n        case 'timeout'\t\t: return timeout(inputObj);\n\n        /*\n         * Shortcuts\n         */\n\n        case 'enter'\t: return keypressed(_.assign({key:13},inputObj));\n\n        case 'space'\t: return keypressed(_.assign({key:32},inputObj));\n\n        case 'esc'\t    : return keypressed(_.assign({key:27},inputObj));\n\n        case 'leftTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                left: 0,\n                width: '30%',\n                height: '100%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'rightTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                right: 0,\n                width: '30%',\n                height: '100%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'topTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                top: 0,\n                width: '100%',\n                height: '30%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        case 'bottomTouch'\t:\n            inputObj.element = createElement(inputObj.css, {\n                position: 'absolute',\n                bottom: 0,\n                width: '100%',\n                height: '30%',\n                background: '#00FF00',\n                opacity: 0.3\n            });\n\n            return mouseEvents('mousedown', inputObj, canvas);\n\n        default:\n            throw new Error('You have an input element with an unrecognized \"on\" property: ' + on);\n\n    }\n\n\n    function createElement(css2, css1){\n        var el = document.createElement('div');\n        css(el, css1);\n        css(el, css2);\n        return el;\n    }\n}\n","import stream from 'mithril-stream';\nexport default keyup; \n\nfunction keyup(inputObj){\n    var $listener = stream();\n    // make sure key is array\n    var keys = Array.isArray(inputObj.key) ? inputObj.key : [inputObj.key];\n\n    // map keys to keyCodes\n    var target = keys.map(function(value){ \n        return typeof value == 'string' ? value.toUpperCase().charCodeAt(0) : value; \n    });\n\n    document.addEventListener('keyup', keypressListener);\n\n    $listener.end.map(removeKeypressListener);\n    return $listener;\n\n    function keypressListener(e){\n        if (target.indexOf(e.which) === -1) return;\n        e.preventDefault();\n        return $listener(e);\n    }\n\n    function removeKeypressListener(){\n        document.removeEventListener('keyup', $listener);\n    }\n}\n","import binder from './binder';\nimport stream from 'mithril-stream';\nimport _ from 'lodash';\n\nexport default createListener;\n\nfunction createListener(inputObj,canvas){\n    var $listener = getListener(inputObj, canvas);\n\n    if (!isStream($listener)) throw new Error('Input functions must return valid streams: ' + logObj(inputObj));\n    if ('handle' in inputObj) $listener.handle = inputObj.handle;\n\n    return $listener;\n}\n\nfunction getListener(inputObj, canvas){\n    var $listener;\n\n    if (_.isFunction(inputObj)) return inputObj(inputObj, canvas, stream);\n\n    if (_.isPlainObject(inputObj)) {\n        if (_.isString(inputObj.on)) return binder(inputObj,canvas,stream);\n\n        if (_.isFunction(inputObj.on )) $listener = inputObj.on(inputObj,canvas,stream);\n        if (_.isFunction(inputObj.off)) $listener.end.map(inputObj.off);\n    }\n        \n    throw new Error('Input must only contain objects and functions, do you have an undefined value?');\n}\n\nfunction logObj(obj){\n    return _.isFunction(obj) ? obj.toString() : JSON.stringify(obj);\n}\n\n\nfunction isStream(stream) {return stream._state; }\n","import _ from 'lodash';\nexport default getMedia;\n\n\nfunction getMedia(media){\n    // all templateing is done within the inflate trial function and the sequencer\n    var template = media.html || media.inlineTemplate || media.template; // give inline template precedence over template, because tempaltes are loaded into inlinetemplate\n    var el;\n\n    if (_.isFunction(media)) return customMedia(media);\n\n    if (_.isString(media)) media = {word:media};\n\n    if (media.word) {\n        el = document.createElement('div');\n        el.textContent = media.word;\n        return Promise.resolve(el);\n    }\n\n    if (template) { // html | template | inlineTemplate\n        el = document.createElement('div');\n        el.innerHTML = template;\n        return Promise.resolve(el);\n    } \n\n    // at this time, we count on the preloader to throw for errors\n    // the reject option isn't really being used here...\n    if (media.image) return new Promise(function(resolve, reject){\n        el = document.createElement('img');\n        el.onload = function(){resolve(el);};\n        el.onerror = function(){reject(new Error('Image not found: ' + el.src ));};\n        el.src = media.image;\n    });\n\n    if (media.jquery) return Promise.reject(new Error('Jquery is no longer supported in minno-time'));\n\n    return Promise.reject(new Error('Unrecognized media type')); // this is not a supported html type\n}\n\nfunction customMedia(media){\n    var promise = media();\n    if (!isThenable(promise)) return Promise.reject(new Error('Custom media must return a promise'));\n    return promise.then(forceElement);\n\n    function isThenable(p){ return p && _.isFunction(p.then); }\n    function forceElement(el){ return _.isElement(el) ? el : Promise.reject('Custom media must resolve with an element');}\n}\n","import _ from 'lodash';\nexport default setSize;\n\nfunction setSize(el, stimulus){\n    var style = el.style;\n    var size = stimulus.size || {};\n\n    if (size.font_size) style.fontSize = size.font_size;\n\n    // if this is a word, we don't want to set height (it breaks centering)\n    if (isSet('height', size) && !isWordMedia(stimulus.media)) style.height = size.height + '%';\n\n    if (isSet('width', size)) style.width = size.width + '%';\n\n    return el;\n}\n\nfunction isSet(prop, obj){return prop in obj;}\nfunction isWordMedia(media){ return _.isString(media) || _.isString(media.word); }\n","import fastdom from 'fastdom';\n\nexport default setPlace;\n\nvar YCLASS = 'minno-stimulus-center-y';\nvar XCLASS = 'minno-stimulus-center-x';\n\nfunction setPlace(el,stimulus){\n    var location = stimulus.location || {};\n\n    // set offsets:\n    if (location.top == 'center' || location.bottom == 'center' || (location.top === undefined && location.bottom === undefined)) el.classList.add(YCLASS);\n    if (location.left == 'center' || location.right == 'center' || (location.left === undefined && location.right === undefined)) el.classList.add(XCLASS);\n\n    ['top','bottom','left','right'].forEach(setNumericLocation);\n\n    function isNumeric(val) {return !isNaN(+val);}\n    function setNumericLocation(attr){ if (isNumeric(location[attr])) el.style[attr] = location[attr] + '%'; }\n}\n\nexport function fixIE(el, resolve){\n    var style = el.style;\n\n    // count on setplace to findout when we need to center\n    var xCenter = el.classList.contains(XCLASS);\n    var yCenter = el.classList.contains(YCLASS);\n\n    if (!xCenter && !yCenter) return resolve(el);\n\n    fastdom.measure(function(){\n        var computedStyle = window.getComputedStyle(el);\n        var width = parseFloat(computedStyle.width);\n        var height = parseFloat(computedStyle.height);\n\n        fastdom.mutate(function(){\n            // location (left/top) is set to 50% within the center class\n            // we're adding the margin on IE where the transform does not work well\n            // we need to cancel the transform set within the class though...\n            style.transform = 'none';\n            if (xCenter) style.marginLeft = '-' + (width/2) + 'px';\n            if (yCenter) style.marginTop = '-' + (height/2) + 'px';\n        });\n\n    });\n}\n","import fastdom from 'fastdom';\nimport getMedia from './getMedia';\nimport setSize from './setSize';\nimport setPlace, {fixIE} from './setPlace';\nimport css from 'minno-css';\n\nexport default Stimulus;\n\nfunction Stimulus(stimulus, trial, canvas){\n    var self = {\n        el: null, // is set within init, some methods will break if not called before init...\n        source: stimulus,\n        trial: trial,\n        canvas: canvas,\n        init: init,\n        show: show,\n        hide: hide,\n        name: name,\n        mediaName: mediaName,\n        destroy: destroy\n    };\n\n    // make sure we have a data object\n    self.data = stimulus.data || {};\n\n    // set the handle\n    self.handle = self.data.handle = self.data.handle || stimulus.handle || stimulus.set;\n\n    return self;\n}\n\n\nfunction init(){\n    var source = this.source;\n    var $messages = this.trial.$messages;\n    if (!this.source.media) throw new Error('Media object not defined for ' + this.name());\n\n    return getMedia(this.source.media)\n        .then(setupElement.bind(this, this.canvas), onError);\n\n    function onError(error){\n        $messages({type:'error', message: 'trial.stimulus error', error:error, context:source});\n        throw error;\n    }       \n    \n\n}\n\nfunction setupElement(canvas, el){\n    var self = this;\n    this.el = el;\n    return new Promise(function(resolve){\n        fastdom.mutate(function initStim(){\n            // setup element\n            el.classList.add('minno-stimulus');\n            el.setAttribute('data-handle', self.handle); // data-handle for handeling of mouse/touch interactions\n            setSize(el, self.source);\n            setPlace(el, self.source);\n            css(el, self.source.css || {});\n\n            if (self.source.isLayout) el.classList.add('minno-stimulus-visible');\n\n            // append to canvas\n            canvas.appendChild(el);\n\n            if (document.documentMode) fixIE(el, resolve);\n            else resolve(el);\n        });\n    });\n}\n\nfunction show(){\n    var el = this.el;\n    if (!el) throw new Error('A stimulus can not be shown before init is called');\n\n    fastdom.mutate(function showStim(){\n        el.classList.add('minno-stimulus-visible');\n    });\n}\n\nfunction hide(){\n    var el = this.el;\n    if (!el) throw new Error('A stimulus can not be hidden before init is called');\n\n    fastdom.mutate(function hideStim(){\n        el.classList.remove('minno-stimulus-visible');\n    });\n}\n\nfunction destroy(){\n    var el = this.el;\n    var canvas = this.canvas;\n    fastdom.mutate(function removeStim(){\n        canvas.removeChild(el);\n    });\n}\n\nfunction name(){\n    var source = this.source;\n    // if we have an alias ues it\n    if (source.alias) {return source.alias;}\n    if (this.data.alias) {return this.data.alias;} // if we have an alias ues it\n\n    if (source.inherit && source.inherit.set) {return source.inherit.set;} // otherwise try using the set we inherited from\n    if (this.handle) {return this.handle;} // otherwise use handle\n\n    // if no individual name is given, we set a default at the collection level\n}\n\nfunction mediaName(options){\n    var media = this.source.media;\n    var fullpath = options && options.fullpath; // as set within settings\n\n    if (media.alias) {return media.alias;} // if we have an alias ues it\n\n    for (var prop in media) {\n        if (contains(['image','template'],prop)) return fullpath ? media[prop] : media[prop].replace(/^.*[\\\\/]/, '');\n\n        // sometimes we have an empty value (this happens when we load a template and then translate it into an inline template)\n        if (contains(['word','html','inlineTemplate'],prop) && media[prop]) return media[prop];\n    }\n\n    // if no individual name is given, we set a default at the collection level\n}\n\nfunction contains(arr, val){ return arr.indexOf(val) != -1;}\n","import Stimulus from './Stimulus';\nimport _ from 'lodash';\n\nexport default stimCollection;\n\nfunction stimCollection(trial, canvas){\n    validateStimuli('stimuli', trial._source);\n    validateStimuli('layout', trial._source);\n\n    var source = trial._source;\n    var stimuli = _.map(source.stimuli, toStim);\n    var layout = _.map(source.layout, toLayout).map(toStim);\n    var ready = Promise.all(stimuli.concat(layout).map(function(stim){return stim.init();}));\n\n    var self = {\n        canvas: canvas,\n        stimuli: stimuli,\n        layout: layout,\n        ready: ready,\n        getStimlist: getStimlist,\n        getMedialist: getMedialist,\n        destroy: destroy\n    };\n\n    return self;\n\n    function toStim(stim){ return Stimulus(stim, trial, canvas); }\n    function toLayout(stim){ stim.isLayout = true; return stim;}\n}\n\nfunction getStimlist(){\n    return this.stimuli\n        .filter(function(stim){return !stim.source.nolog;})\n        .map(function(stim, index){return stim.name() || ('stim' + index);});\n}\n\nfunction getMedialist(options){\n    return this.stimuli\n        .filter(function(stim){return !stim.source.nolog;})\n        .map(function(stim, index){return stim.mediaName(options) || ('media' + index);});\n}\n\nfunction destroy(){\n    this.stimuli.concat(this.layout).forEach(function(stim){stim.destroy();});\n}\n\nexport function validateStimuli(type, source){\n    var stimuli = source[type];\n    if (!stimuli) return;\n    if (!Array.isArray(stimuli)) throw new Error(type + ' must be an array');\n    if (!stimuli.every(function(stim){ return 'media' in stim; })) throw new Error('Each ' + type + ' stimulus must have a media property');\n}\n","import _ from 'lodash';\nimport globalGetter from '../../global';\n\nvar global = globalGetter();\nvar conditionHash = {\n    begin:begin,\n    inputEquals:inputEquals,\n    inputEqualsTrial:inputEqualsTrial,\n    inputEqualsStim:inputEqualsStim,\n    trialEquals:trialEquals,\n    inputEqualsGlobal:inputEqualsGlobal,\n    globalEquals:globalEquals,\n    globalEqualsTrial:globalEqualsTrial,\n    globalEqualsStim:globalEqualsStim,\n    currentEquals:currentEquals,\n    currentEqualsTrial:currentEqualsTrial,\n    currentEqualsStim:currentEqualsStim,\n    inputEqualsCurrent:inputEqualsCurrent,\n    fn:fn,\n    custom:custom,\n};\n\nexport default function getConditonFn(condition){\n    if (_.isFunction(condition)) return condition;\n    if (_.isFunction(conditionHash[condition.type])) return conditionHash[condition.type];\n    throw new Error('Unknown condition type: ' + JSON.stringify(condition));\n}\n\nfunction begin(inputData){ return inputData.type === 'begin'; }\n\nfunction inputEquals(inputData, condition){\n    var values = Array.isArray(condition.value) ? condition.value : [condition.value];\n    return values.indexOf(inputData.handle) !== -1;\n}\n\nfunction inputEqualsTrial(inputData, condition, trial){ return inputData.handle === trial.data[condition.property]; }\n\nfunction inputEqualsStim(inputData, condition, trial){\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.property] = inputData.handle;\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj,trial);\n}\n\nfunction trialEquals(inputData, condition, trial){\n    if (_.isUndefined(condition.property) || _.isUndefined(condition.value)) throw new Error('trialEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value === trial.data[condition.property];\n}\n\nfunction inputEqualsGlobal(inputData, condition){\n    if (_.isUndefined(condition.property)) throw new Error('inputEqualsGlobal requires \"property\" to be defined');\n    return inputData.handle === global[condition.property];\n}\n\nfunction globalEquals(inputData, condition){\n    if (typeof condition.property == 'undefined' || typeof condition.value == 'undefined') throw new Error('globalEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value === global[condition.property];\n}\n\nfunction globalEqualsTrial(inputData, condition, trial){\n    if (typeof condition.globalProp == 'undefined' || typeof condition.trialProp == 'undefined') throw new Error('globalEqualsTrial requires both \"globalProp\" and \"trialProp\" to be defined');\n    return global[condition.globalProp] !== trial.data[condition.trialProp];\n}\n\nfunction globalEqualsStim(inputData, condition, trial){\n    if (typeof condition.globalProp == 'undefined' || typeof condition.stimProp == 'undefined') throw new Error('globalEqualsStim requires both \"globalProp\" and \"stimProp\" to be defined');\n\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.stimProp] = global[condition.globalProp];\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj,trial);\n}\n\nfunction inputEqualsCurrent(inputData, condition){\n    var current = global.current;\n    if (typeof condition.property == 'undefined') throw new Error('inputEqualsCurrent requires \"property\" to be defined');\n    return inputData.handle === current[condition.property];\n}\nfunction currentEquals(inputData, condition){\n    var current = global.current;\n    if (typeof condition.property == 'undefined' || typeof condition.value == 'undefined') throw new Error('currentEquals requires both \"property\" and \"value\" to be defined');\n    return condition.value !== current[condition.property];\n}\n\nfunction currentEqualsTrial(inputData, condition, trial){\n    var current = global.current;\n    if (typeof condition.currentProp == 'undefined' || typeof condition.trialProp == 'undefined') throw new Error('currentEqualsTrial requires both \"currentProp\" and \"trialProp\" to be defined');\n    return current[condition.currentProp] === trial.data[condition.trialProp];\n}\n\nfunction currentEqualsStim(inputData, condition, trial){\n    var current = global.current;\n    if (typeof condition.currentProp == 'undefined' || typeof condition.stimProp == 'undefined') throw new Error('currentEqualsStim requires both \"currentProp\" and \"stimProp\" to be defined');\n\n    // create search object\n    var searchObj = {};\n    if (condition.handle) searchObj['handle'] = condition.handle;\n    searchObj[condition.stimProp] = current[condition.currentProp];\n\n    // are there stimuli answering this descriptions?\n    return hasData(searchObj, trial);\n}\n\nfunction fn(inputData, condition, trial){\n    return condition.value.apply(trial,[condition,inputData, trial]);\n}\n\nfunction custom(inputData, condition, trial){\n    return condition.fn.apply(null, [condition, inputData, trial]);\n}\n\nfunction hasData(searchObj, trial){\n    return trial.stimulusCollection.stimuli.some(function(stim){\n        var data = stim.data;\n        for (var key in searchObj) {\n            if (searchObj[key] !== data[key]) return false;\n        }\n        return true;\n    });\n}\n","/*\n * gets a condition array (or a single condition) and evaluates it\n * returns true if all statements are true, false otherwise\n *\n * a single condition looks like this:\n *\n *\tcondition = {\n *\t\ttype : 'begin/inputEquals/inputEqualsTrial/inputEqualsStim/function',\n *\t\tvalue: 'right/trialAttribute/stimAttribute/customFunction',\n *\t\thandle: 'stim handle' (optional in case we're targeting a stimulus)\n *\t}\n *\n */\n\nimport getConditionFn from './getConditionFn';\n\nexport default conditionsEvaluate;\n\nfunction conditionsEvaluate(conditions, inputData, trial){\n    // make sure conditions is an array\n    conditions = Array.isArray(conditions) ? conditions : [conditions];\n\n    // if this is a begin event, make sure we only run interactions that have begin in them\n    if (inputData.type == 'begin' && conditions.every(function(condition){return condition.type != 'begin';})) return false;\n\n    return conditions.every(checkCondition);\n\n\n    function checkCondition(condition){\n        return getConditionFn(condition)(inputData, condition, trial);\n    }\n}\n","/*\n * accepts an array of actions (or a single action)\n * and applies them\n *\n * actions = [\n *\t\t{type:actionName,more:options},\n *\t\t{actionName:options}\n * ]\n * @param actions: single action object or array of action objects\n * @param eventData: eventData object\n * @returns Boolean: endTrial whether this action stops further action activations\n */\n\nimport _ from 'lodash';\nimport actionList from './actionList';\n\nexport default applyActions;\n\nfunction applyActions(actions, eventData, trial){\n    // marks whether this is the final action to take\n    var endTrial = false;\n\n    actions = _.isArray(actions) ? actions : [actions];\n\n    _.forEach(actions,function(action){\n        var actionFn = _.isFunction(action) ? action : actionList[action.type];\n        if (!actionFn) throw new Error('unknown action: ' + action.type);\n\n        // the only reason to halt action activation is the endTrial command\n        if (action.type === 'endTrial') endTrial = true;\n        actionFn(action, eventData, trial);\n    });\n\n    return endTrial;\n}\n","/*\n* Organizer for the interaction function\n*/\n\nimport evaluate from './conditionsEvaluate';\nimport activate from './action';\nimport _ from 'lodash';\n\nexport default interactions;\n\n/*\n * Trial -> Event -> Event\n *\n * Can use trial to produce side efects\n **/\n\nvar MAX_RECURSION_DEPTH = 50;\nfunction interactions(trial){\n    var recursionDepth = 0;\n    var interactions = trial._source.interactions;\n\n    try {\n        validateInteractions(interactions);\n    } catch(error){\n        trial.$messages({type:'error', message: 'trial.interactions error', error:error, context:trial._source});\n        throw error;\n    }\n    return eventMap;\n\n    function eventMap(event){\n        var i, interaction, conditionTrue, endTrial;\n        var groupName = 'Event: ' + (event.handle || event.type);\n        var debugLog = [];\n\n        if (recursionDepth > MAX_RECURSION_DEPTH) throw new Error('It seem you have created an infinite loop. Minno has been halted');\n\n        recursionDepth++;\n        try{\n            // use an explicit for loop because we need to be able to break\n            for (i=0; i<interactions.length; i++){\n                interaction = interactions[i];\n\n                conditionTrue = evaluate(interaction.conditions, event, trial);\n                debugLog.push([conditionTrue, interaction.conditions]);\n\n                if (conditionTrue) endTrial = activate(interaction.actions, event, trial);\n\n                // if this action includes endTrial we want to stop evalutation immidiately\n                if (endTrial) break;\n            }\n\n        } catch(error){\n            trial.$messages({type:'error', message: 'trial.interactions error', error:error});\n            throw error;\n        }\n        recursionDepth--;\n\n        trial.$messages({type:'debug', message: groupName, rows: debugLog});\n\n        // this is here and not within actions so that messages can be sent befor ending the trial\n        if (endTrial) trial.end();\n\n        return event;\n    }\n}\n\nexport function validateInteractions(interactions){\n    if (!Array.isArray(interactions)) throw new Error('Interactions must be an array');\n    if (!interactions.length) throw new Error('There are no interactions defined');\n\n    if (!interactions.every(_.isPlainObject)) throw new Error('Interactions must be plain objects');\n    if (!interactions.every(isValidProp('conditions'))) throw new Error('Conditions must be either an array or a function');\n    if (!interactions.every(isValidProp('actions'))) throw new Error('Actions must be either an array or a function');\n\n    function isValidProp(prop){\n        return function(interaction) {\n            return Array.isArray(interaction[prop]) || _.isFunction(interaction[prop]);\n        };\n    }\n}\n\n","import _ from 'lodash';\nimport input from './input/input';\nimport stimulusCollection from './stimulus/stimulusCollection';\nimport interactions from './interactions/interactions';\nimport stream from 'mithril-stream';\n\nexport default Trial;\n\nvar gid = 0;\n\n// data is already fully inflated\nfunction Trial(source, canvas, settings){\n    // make sure we have all our stuff :)\n    if (!source.interactions) throw new Error('Interactions not defined');\n\n    this.canvas = canvas;\n    this.settings = settings;\n    this._source = source;\n\n    this.$logs = stream();\n    this.$messages = stream();\n    this.$events = stream();\n    this.$end = this.$events.end;\n\n    // make sure we always have a data container\n    this.data = source.data || {};\n\n    // create a uniqueId for this trial\n    this._id = _.uniqueId('trial_');\n    this.counter = gid++;\n\n    this.input = input(this.$events, canvas);\n    this.stimulusCollection = stimulusCollection(this, canvas);\n\n    // the next trial we want to play\n    // by default this is simply the next trial, this can be changed using the goto action\n    // the syntax is [destination, properties]\n    this._next = ['next',{}];\n}\n\n_.extend(Trial.prototype,{\n    start: function(){\n        var trial = this;\n\n        // wait until all simuli are loaded\n        return trial.stimulusCollection.ready.then(function(){\n            // listen for interactions\n            trial.$events\n                .map(addTrialDetails(trial))\n                .map(interactions(trial));\n\n            // activate input\n            _.forEach(trial._source.input, trial.input.add); // add each input\n            trial.input.resetTimer(); // reset the interface timer so that event latencies are relative to now.\n            // start running\n            trial.$events({type:'begin',latency:0});\n        });\n    },\n\n    end: function(){\n        // remove all listeners\n        this.input.removeAll();\n        this.$end(true);\n    },\n\n    name: function(){\n        // if we have an alias ues it\n        if (this.alias) { return this.alias; }\n        if (this.data.alias) { return this.data.alias; }\n\n        // otherwise try using the set we inherited from\n        if (_.isString(this._source.inherit)) return this._source.inherit;\n        if (_.isPlainObject(this._source.inherit)) return this._source.inherit.set;\n\n        // we're out of options here\n    }\n});\n\nfunction addTrialDetails(trial){\n    return function(event){\n        return _.assign(event, {\n            trialId     : trial._id,\n            counter     : trial.counter\n        });\n    };\n}\n","import createListener from './createListener';\nimport now from './now';\n\nexport default interfaceFn;\n\nfunction interfaceFn($events, canvas){\n    var listenerStack = []; // holds all active listeners\n    var baseTime = 0;\n\n    return { add:add,remove:remove,removeAll:removeAll,resetTimer:resetTimer };\n\n    function add(inputObj){\n        if (!inputObj) throw new Error('Missing input element. Could not add input listener');\n        var $listener = createListener(inputObj, canvas);\n        $listener.map(addDetails).map($events); // pipe events to $events\n        listenerStack.push($listener);\n\n        function addDetails(event){\n            return {\n                handle      : $listener.handle,\n                event       : event,\n                timestamp\t: +new Date(),\n                latency\t\t: now() - baseTime\n            };\n        }\n    }\n\n    function remove(handle){\n        // go through the listener stack and remove any listeners that fit the handle\n        // note that we do this in reverse so that the index does not change\n        for (var i = listenerStack.length - 1; i >= 0 ; i--){\n            var $listener = listenerStack[i];\n            if ($listener.handle === handle){\n                $listener.end(true);\n                listenerStack.splice(i,1);\n            }\n        }\n    }\n\n    function removeAll(){\n        listenerStack.forEach(function($listener){\n            $listener.end(true);\n        });\n        listenerStack.length = 0;\n    }\n\n    function resetTimer(){ baseTime = now(); }\n}\n","export default post;\n\nfunction post(url, data){\n    return new Promise(function(resolve, reject){\n        var request = new XMLHttpRequest();\n        request.open('POST',url, true);\n        request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');\n\n        request.onreadystatechange = function() {\n            if (this.readyState === 4) {\n                if (this.status >= 200 && this.status < 400) resolve(this.responseText);\n                else reject(new Error('Failed posting to: ' + url));\n            }\n        };\n\n        request.send(serialize(data));\n    });\n}\n\nfunction serialize(data) {\n    if (typeof data == 'string') return data;\n    return JSON.stringify(data);\n}\n","import _ from 'lodash';\nimport post from './post';\n\nexport default poster;\n\nfunction poster($logs, settings){\n    var cache = [];\n    var url = settings.url;\n\n    if (!url) return; // if we have no url, we can't log anything anyway\n\n    $logs.map(eachLog);\n    $logs.end.map(finalizefLogs);\n\n    function eachLog(log){\n        cache.push(log);\n        if (!settings.pulse) return;\n        if (cache.length >= settings.pulse) {\n            send(cache);\n            cache.length = 0;\n        }\n    }\n\n    function finalizefLogs(){\n        if (cache.length) send(cache);\n    }\n\n    function send(logs){\n        var serialize = settings.serialize || (settings.newServelet ? buildPost : buildPostOld);\n        var serializedPost = serialize(logs, settings.metaData);\n\n        return post(url,serializedPost)\n            .catch(function retry(){ return post(url, serializedPost); })\n            .catch(settings.error || _.noop);\n    }\n\n}\n\nexport function buildPost(logs, metaData){\n    var data = _.assign({ data:logs }, metaData);\n    return JSON.stringify(data);\n}\n\nexport function buildPostOld(logs, metaData){\n    var data = 'json=' + JSON.stringify(logs); // do not re-encode json\n    var meta = serialize(metaData);\n    return data + (meta ? '&'+meta : '');\n}\n\n\nfunction serialize(data){\n    var key, r = [];\n    for (key in data) r.push(encodeURIComponent(key) + '=' + encodeURIComponent(data[key]));\n    return r.join('&').replace(/%20/g, '+');\n}\n","import _ from 'lodash';\n\nexport default transformLogs;\n\nfunction transformLogs(action,eventData,trial){\n    var global = window.piGlobal;\n    var trialData = trial.data, inputData = eventData, logStack = global.current.logs;\n    var fullpath = _.get(trial, 'settings.logger.fullpath', false);\n\n    var stimList = trial.stimulusCollection.getStimlist();\n    var mediaList = trial.stimulusCollection.getMedialist({fullpath:fullpath});\n\n    return {\n        log_serial : logStack.length,\n        trial_id: trial.counter,\n        name: trial.name(),\n        responseHandle: inputData.handle,\n        latency: Math.floor(inputData.latency),\n        stimuli: stimList,\n        media: mediaList,\n        data: trialData\n    };\n}\n","import _ from 'lodash';\nimport stream from 'mithril-stream';\nimport fastdom from 'fastdom';\n\nimport Trial from './trial/Trial';\nimport nextTrial from './task/sequencer/nextTrial';\nimport createLogs from './task/logger/createLogStream';\nimport defaultLogMap from './task/logger/defaultLogMap';\nimport global from './global';\n\nexport default playerPhase;\n\n/**\n * run the task\n * Essentialy wiring up all the play phase stuff\n * @TODO: document this function, its super complicated\n **/\n\nfunction playerPhase(sink){\n\n    var canvas = sink.canvas;\n    var db = sink.db;\n    var settings = sink.settings;\n\n    var $source = stream(); // a stream of trial POJO\n    var $trial = $source.map(activateTrial());\n    var $sourceLogs = stream();\n    var $messages = stream();\n    var $logs = createLogs($sourceLogs, composeLoggerSettings(sink.script, global()), defaultLogMap);\n\n    $logs.map(function(log){\n        global().current.logs.push(log);\n    });\n\n    var onDone = _.get(settings, 'hooks.endTask', settings.onEnd || _.noop);\n\n    $source.end\n        .map(clearCanvas)\n        .map(onDone);\n\n    return _.extend({\n        $trial:$trial, \n        end: $source.end.bind(null,true), \n        $logs: $logs,\n        $messages: $messages,\n        start: play.bind(null, ['next', {}]),\n        onEnd: function(fn){ $source.end.map(fn); }\n    }, sink);\n\n    function clearCanvas(){\n        var trial = $trial();\n        if (trial) trial.stimulusCollection.destroy();\n    }\n\n    function play(goto){\n        var next = nextTrial(db, settings, goto);\n        if (next.done) $source.end(true);\n        else $source(next.value);\n    }\n\n    function activateTrial(cache){\n        return activate;\n        function activate(source){\n            var oldTrial = cache;\n            var trial = cache = new Trial(source, canvas, settings);\n            trial.$logs.map($sourceLogs); \n            trial.$messages.map($messages); \n\n            // must be *before* the subscription to $end for the next trial\n            if (source.DEBUG && window.DEBUG) setupDebug(trial);\n\n            trial.$end.map(function(){\n                play(trial._next); // when we're done try to play the next one\n            });\n\n            trial.start();\n\n            // we leave the old stimuli until the current ones are visiblie to maintain the continuity between trials\n            // This mutate waits until the first mutation in order to schedudual the removal of the old stimuli\n            if (oldTrial) fastdom.mutate(function oldtrial(){\n                oldTrial.stimulusCollection.destroy();\n            });\n\n            return trial;\n        }\n    }\n}\n\nfunction setupDebug(trial){\n    /* eslint-disable no-console */\n    var trialName = 'Trial :' + trial.counter;\n    console.group(trialName);\n    trial.$messages.map(debugLog);\n    trial.$events.end.map(function(){ console.groupEnd(trialName); });\n\n    function debugLog(log){\n        if (log.type !== 'debug') return log;\n        if (log.rows){\n            console.groupCollapsed(log.message);\n            log.rows.forEach(function(row){ console.log.apply(console, row); });\n            console.groupEnd(log.message);\n        }\n        else console.log(log.message);\n        return log;\n    }\n    /* eslint-enable no-console */\n}\n\n// create metaDeta to add to post\nexport function composeLoggerSettings(script, global){\n    var loggerSettings = _.assign({}, _.get(script, 'settings.logger'));\n    var metaData = _.assign({taskName:script.name}, global.$meta, loggerSettings.metaData);\n    loggerSettings.metaData = metaData;\n    return loggerSettings;\n}\n","import _ from 'lodash';\nimport globalGetter from '../../global';\nimport buildUrl from './buildUrl';\n\nexport default nextTrial;\n\nfunction nextTrial(db, settings, goto){\n    var destination = goto[0], properties = goto[1];\n    var sequence = db.currentSequence;\n    var global = globalGetter();\n    var context = {global: global, current: global.current};\n    var source;\n\n    sequence.go(destination, properties, context);\n    source = sequence.current(context, {skip:['layout','stimuli']});\n\n    if (!source) return {done:true};\n\n    source.stimuli = _.map(source.stimuli || [], buildStim, context);\n    source.layout = _.map(source.layout || [], buildStim, context);\n\n    context.trialData = null;\n\n    return {value:source};\n\n    function buildMedia(stim, prop, context){\n        var val = stim[prop];\n\n        if (_.isUndefined(val)) return false;\n        if (_.isString(val)) val = {word: val};\n\n        val = db.inflate('media', val, context);\n\n        // note that the base url is added to the media object during the sequence preload\n        // if needed, build url\n        if (val.image) val.image = buildUrl(settings.base_url, val.image, 'image');\n\n        if (val.template){\n            // @TODO: remove dependency on requirejs\n            val.inlineTemplate = requirejs('text!' + buildUrl(settings.base_url, val.template, 'template'));\n            val.inlineTemplate = _.template(val.inlineTemplate)(context);\n        }\n\n        stim[prop] = val;\n\n        context.mediaData = null;\n        context.mediaMeta = null;\n    }\n\n    function buildStim(stim){\n        var context = this;\n\n        stim = db.inflate('stimulus', stim, context, {skip:['media','touchMedia']});\n        buildMedia(stim, 'media', context);\n        buildMedia(stim, 'touchMedia', context);\n        context.stimulusData = null;\n        context.stimulusMeta = null;\n        return stim;\n    }\n}\n","import poster from './poster';\n\nexport default createLogs;\n\nfunction createLogs($sourceLogs, settings, defaultLogMap){\n    var $logs = $sourceLogs.map(applyMap(settings.logger || settings.logMap || defaultLogMap));\n\n    if (settings.poster) settings.poster($logs, settings, poster);\n    else poster($logs, settings);\n\n    return $logs;\n\n    // $logs is a stream of array, we want to apply them as args to the transform function\n    function applyMap(fn){\n        return function(args){ return fn.apply(null,args); };\n    }\n}\n","/* eslint-disable */\r\n;(function() {\r\n\"use strict\"\r\n/* eslint-enable */\r\n\r\nvar guid = 0, HALT = {}\r\nfunction createStream() {\r\n\tfunction stream() {\r\n\t\tif (arguments.length > 0 && arguments[0] !== HALT) updateStream(stream, arguments[0])\r\n\t\treturn stream._state.value\r\n\t}\r\n\tinitStream(stream)\r\n\r\n\tif (arguments.length > 0 && arguments[0] !== HALT) updateStream(stream, arguments[0])\r\n\r\n\treturn stream\r\n}\r\nfunction initStream(stream) {\r\n\tstream.constructor = createStream\r\n\tstream._state = {id: guid++, value: undefined, state: 0, derive: undefined, recover: undefined, deps: {}, parents: [], endStream: undefined, unregister: undefined}\r\n\tstream.map = stream[\"fantasy-land/map\"] = map, stream[\"fantasy-land/ap\"] = ap, stream[\"fantasy-land/of\"] = createStream\r\n\tstream.valueOf = valueOf, stream.toJSON = toJSON, stream.toString = valueOf\r\n\r\n\tObject.defineProperties(stream, {\r\n\t\tend: {get: function() {\r\n\t\t\tif (!stream._state.endStream) {\r\n\t\t\t\tvar endStream = createStream()\r\n\t\t\t\tendStream.map(function(value) {\r\n\t\t\t\t\tif (value === true) {\r\n\t\t\t\t\t\tunregisterStream(stream)\r\n\t\t\t\t\t\tendStream._state.unregister = function(){unregisterStream(endStream)}\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn value\r\n\t\t\t\t})\r\n\t\t\t\tstream._state.endStream = endStream\r\n\t\t\t}\r\n\t\t\treturn stream._state.endStream\r\n\t\t}}\r\n\t})\r\n}\r\nfunction updateStream(stream, value) {\r\n\tupdateState(stream, value)\r\n\tfor (var id in stream._state.deps) updateDependency(stream._state.deps[id], false)\r\n\tif (stream._state.unregister != null) stream._state.unregister()\r\n\tfinalize(stream)\r\n}\r\nfunction updateState(stream, value) {\r\n\tstream._state.value = value\r\n\tstream._state.changed = true\r\n\tif (stream._state.state !== 2) stream._state.state = 1\r\n}\r\nfunction updateDependency(stream, mustSync) {\r\n\tvar state = stream._state, parents = state.parents\r\n\tif (parents.length > 0 && parents.every(active) && (mustSync || parents.some(changed))) {\r\n\t\tvar value = stream._state.derive()\r\n\t\tif (value === HALT) return false\r\n\t\tupdateState(stream, value)\r\n\t}\r\n}\r\nfunction finalize(stream) {\r\n\tstream._state.changed = false\r\n\tfor (var id in stream._state.deps) stream._state.deps[id]._state.changed = false\r\n}\r\n\r\nfunction combine(fn, streams) {\r\n\tif (!streams.every(valid)) throw new Error(\"Ensure that each item passed to stream.combine/stream.merge is a stream\")\r\n\treturn initDependency(createStream(), streams, function() {\r\n\t\treturn fn.apply(this, streams.concat([streams.filter(changed)]))\r\n\t})\r\n}\r\n\r\nfunction initDependency(dep, streams, derive) {\r\n\tvar state = dep._state\r\n\tstate.derive = derive\r\n\tstate.parents = streams.filter(notEnded)\r\n\r\n\tregisterDependency(dep, state.parents)\r\n\tupdateDependency(dep, true)\r\n\r\n\treturn dep\r\n}\r\nfunction registerDependency(stream, parents) {\r\n\tfor (var i = 0; i < parents.length; i++) {\r\n\t\tparents[i]._state.deps[stream._state.id] = stream\r\n\t\tregisterDependency(stream, parents[i]._state.parents)\r\n\t}\r\n}\r\nfunction unregisterStream(stream) {\r\n\tfor (var i = 0; i < stream._state.parents.length; i++) {\r\n\t\tvar parent = stream._state.parents[i]\r\n\t\tdelete parent._state.deps[stream._state.id]\r\n\t}\r\n\tfor (var id in stream._state.deps) {\r\n\t\tvar dependent = stream._state.deps[id]\r\n\t\tvar index = dependent._state.parents.indexOf(stream)\r\n\t\tif (index > -1) dependent._state.parents.splice(index, 1)\r\n\t}\r\n\tstream._state.state = 2 //ended\r\n\tstream._state.deps = {}\r\n}\r\n\r\nfunction map(fn) {return combine(function(stream) {return fn(stream())}, [this])}\r\nfunction ap(stream) {return combine(function(s1, s2) {return s1()(s2())}, [stream, this])}\r\nfunction valueOf() {return this._state.value}\r\nfunction toJSON() {return this._state.value != null && typeof this._state.value.toJSON === \"function\" ? this._state.value.toJSON() : this._state.value}\r\n\r\nfunction valid(stream) {return stream._state }\r\nfunction active(stream) {return stream._state.state === 1}\r\nfunction changed(stream) {return stream._state.changed}\r\nfunction notEnded(stream) {return stream._state.state !== 2}\r\n\r\nfunction merge(streams) {\r\n\treturn combine(function() {\r\n\t\treturn streams.map(function(s) {return s()})\r\n\t}, streams)\r\n}\r\n\r\nfunction scan(reducer, seed, stream) {\r\n\tvar newStream = combine(function (s) {\r\n\t\treturn seed = reducer(seed, s._state.value)\r\n\t}, [stream])\r\n\r\n\tif (newStream._state.state === 0) newStream(seed)\r\n\r\n\treturn newStream\r\n}\r\n\r\nfunction scanMerge(tuples, seed) {\r\n\tvar streams = tuples.map(function(tuple) {\r\n\t\tvar stream = tuple[0]\r\n\t\tif (stream._state.state === 0) stream(undefined)\r\n\t\treturn stream\r\n\t})\r\n\r\n\tvar newStream = combine(function() {\r\n\t\tvar changed = arguments[arguments.length - 1]\r\n\r\n\t\tstreams.forEach(function(stream, idx) {\r\n\t\t\tif (changed.indexOf(stream) > -1) {\r\n\t\t\t\tseed = tuples[idx][1](seed, stream._state.value)\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\treturn seed\r\n\t}, streams)\r\n\r\n\treturn newStream\r\n}\r\n\r\ncreateStream[\"fantasy-land/of\"] = createStream\r\ncreateStream.merge = merge\r\ncreateStream.combine = combine\r\ncreateStream.scan = scan\r\ncreateStream.scanMerge = scanMerge\r\ncreateStream.HALT = HALT\r\n\r\nif (typeof module !== \"undefined\") module[\"exports\"] = createStream\r\nelse if (typeof window.m === \"function\" && !(\"stream\" in window.m)) window.m.stream = createStream\r\nelse window.m = {stream : createStream}\r\n\r\n}());\r\n","module.exports = css;\n\n/**\n * @arg el DOMElement any dom element\n * @arg obj Object a hash of styleName:value, where the style name may be either css-style or jsStyle (camelCase)\n * @returns void\n *\n * The function applies the styles set in obj to the el\n **/\n\nfunction css(el, obj){\n    var style = el.style;\n\n    if (!obj) return;\n\n    for (var key in obj) style[camelCase(key)] = obj[key];\n\n    function camelCase(str){ \n        return  str.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); }); \n    }\n}\n","\n/*\n * media preloader\n * TODO: turn into factory, possibly make progress into a stream.\n */\nimport _ from 'lodash';\nexport default loader;\n\nvar srcStack = [];\t\t\t\t// an array holding all our sources\nvar defStack = [];\t\t\t\t// an array holding all the deferreds\nvar stackDone = 0;\t\t\t\t// the number of sources we have completed downloading\nvar images = {};\nvar getText = _.memoize(getXhr);\n\nvar loader = {\n    // loads a single source\n    load: load,\n\n    all: function(){\n        return Promise.all(defStack);\n    },\n\n    progress: function(){\n        return defStack.length ? stackDone/defStack.length : 1;\n    }\n};\n\n// load a single source\nfunction load(src, type){\n    // the source was already loaded\n    if (srcStack.indexOf(src) !== -1) return false;\n\n    // if we haven't loaded this yet\n    var promise = type == 'template' ? getText(src) : getImage(src);\n\n    promise\n        .then(function(){stackDone++;})\n        .then(function(){\n            loader.onload && loader.onload();\n        });\n\n    // keep defered and source for later.\n    defStack.push(promise);\n    srcStack.push(src);\n\n    return promise;\n}\n\nfunction getImage(url){\n    return  new Promise(function(resolve, reject){\n        var el = document.createElement('img');\n        el.onload = function(){resolve(el);};\n        el.onerror = function(){reject(new Error('Image not found: ' + url ));};\n        el.src = url;\n        images[url] = el;\n    });\n}\nfunction getXhr(url){\n    return new Promise(function(resolve, reject){\n        var request = new XMLHttpRequest();\n        request.open('GET',url, true);\n        request.onreadystatechange = function() {\n            if (this.readyState === 4) {\n                if (this.status >= 200 && this.status < 400) resolve(this.responseText);\n                else reject(new Error('Template not found:' + url));\n            }\n        };\n        request.send();\n    });\n}\n","!(function(win) {\n\n/**\n * FastDom\n *\n * Eliminates layout thrashing\n * by batching DOM read/write\n * interactions.\n *\n * @author Wilson Page <wilsonpage@me.com>\n * @author Kornel Lesinski <kornel.lesinski@ft.com>\n */\n\n'use strict';\n\n/**\n * Mini logger\n *\n * @return {Function}\n */\nvar debug = 0 ? console.log.bind(console, '[fastdom]') : function() {};\n\n/**\n * Normalized rAF\n *\n * @type {Function}\n */\nvar raf = win.requestAnimationFrame\n  || win.webkitRequestAnimationFrame\n  || win.mozRequestAnimationFrame\n  || win.msRequestAnimationFrame\n  || function(cb) { return setTimeout(cb, 16); };\n\n/**\n * Initialize a `FastDom`.\n *\n * @constructor\n */\nfunction FastDom() {\n  var self = this;\n  self.reads = [];\n  self.writes = [];\n  self.raf = raf.bind(win); // test hook\n  debug('initialized', self);\n}\n\nFastDom.prototype = {\n  constructor: FastDom,\n\n  /**\n   * Adds a job to the read batch and\n   * schedules a new frame if need be.\n   *\n   * @param  {Function} fn\n   * @public\n   */\n  measure: function(fn, ctx) {\n    debug('measure');\n    var task = !ctx ? fn : fn.bind(ctx);\n    this.reads.push(task);\n    scheduleFlush(this);\n    return task;\n  },\n\n  /**\n   * Adds a job to the\n   * write batch and schedules\n   * a new frame if need be.\n   *\n   * @param  {Function} fn\n   * @public\n   */\n  mutate: function(fn, ctx) {\n    debug('mutate');\n    var task = !ctx ? fn : fn.bind(ctx);\n    this.writes.push(task);\n    scheduleFlush(this);\n    return task;\n  },\n\n  /**\n   * Clears a scheduled 'read' or 'write' task.\n   *\n   * @param {Object} task\n   * @return {Boolean} success\n   * @public\n   */\n  clear: function(task) {\n    debug('clear', task);\n    return remove(this.reads, task) || remove(this.writes, task);\n  },\n\n  /**\n   * Extend this FastDom with some\n   * custom functionality.\n   *\n   * Because fastdom must *always* be a\n   * singleton, we're actually extending\n   * the fastdom instance. This means tasks\n   * scheduled by an extension still enter\n   * fastdom's global task queue.\n   *\n   * The 'super' instance can be accessed\n   * from `this.fastdom`.\n   *\n   * @example\n   *\n   * var myFastdom = fastdom.extend({\n   *   initialize: function() {\n   *     // runs on creation\n   *   },\n   *\n   *   // override a method\n   *   measure: function(fn) {\n   *     // do extra stuff ...\n   *\n   *     // then call the original\n   *     return this.fastdom.measure(fn);\n   *   },\n   *\n   *   ...\n   * });\n   *\n   * @param  {Object} props  properties to mixin\n   * @return {FastDom}\n   */\n  extend: function(props) {\n    debug('extend', props);\n    if (typeof props != 'object') throw new Error('expected object');\n\n    var child = Object.create(this);\n    mixin(child, props);\n    child.fastdom = this;\n\n    // run optional creation hook\n    if (child.initialize) child.initialize();\n\n    return child;\n  },\n\n  // override this with a function\n  // to prevent Errors in console\n  // when tasks throw\n  catch: null\n};\n\n/**\n * Schedules a new read/write\n * batch if one isn't pending.\n *\n * @private\n */\nfunction scheduleFlush(fastdom) {\n  if (!fastdom.scheduled) {\n    fastdom.scheduled = true;\n    fastdom.raf(flush.bind(null, fastdom));\n    debug('flush scheduled');\n  }\n}\n\n/**\n * Runs queued `read` and `write` tasks.\n *\n * Errors are caught and thrown by default.\n * If a `.catch` function has been defined\n * it is called instead.\n *\n * @private\n */\nfunction flush(fastdom) {\n  debug('flush');\n\n  var writes = fastdom.writes;\n  var reads = fastdom.reads;\n  var error;\n\n  try {\n    debug('flushing reads', reads.length);\n    runTasks(reads);\n    debug('flushing writes', writes.length);\n    runTasks(writes);\n  } catch (e) { error = e; }\n\n  fastdom.scheduled = false;\n\n  // If the batch errored we may still have tasks queued\n  if (reads.length || writes.length) scheduleFlush(fastdom);\n\n  if (error) {\n    debug('task errored', error.message);\n    if (fastdom.catch) fastdom.catch(error);\n    else throw error;\n  }\n}\n\n/**\n * We run this inside a try catch\n * so that if any jobs error, we\n * are able to recover and continue\n * to flush the batch until it's empty.\n *\n * @private\n */\nfunction runTasks(tasks) {\n  debug('run tasks');\n  var task; while (task = tasks.shift()) task();\n}\n\n/**\n * Remove an item from an Array.\n *\n * @param  {Array} array\n * @param  {*} item\n * @return {Boolean}\n */\nfunction remove(array, item) {\n  var index = array.indexOf(item);\n  return !!~index && !!array.splice(index, 1);\n}\n\n/**\n * Mixin own properties of source\n * object into the target.\n *\n * @param  {Object} target\n * @param  {Object} source\n */\nfunction mixin(target, source) {\n  for (var key in source) {\n    if (source.hasOwnProperty(key)) target[key] = source[key];\n  }\n}\n\n// There should never be more than\n// one instance of `FastDom` in an app\nvar exports = win.fastdom = (win.fastdom || new FastDom()); // jshint ignore:line\n\n// Expose to CJS & AMD\nif ((typeof define) == 'function') define(function() { return exports; });\nelse if ((typeof module) == 'object') module.exports = exports;\n\n})( typeof window !== 'undefined' ? window : this);\n","export default window.performance.now\n    ? window.performance.now.bind(window.performance)\n\n    // We aren't using the absoulte time anywhere so we can use raw Date.now as a replacement\n    // if we're not on IE9\n    : Date.now.bind(Date);\n","import _ from 'lodash';\nimport fastdom from 'fastdom';\nimport global from '../../global';\nimport applyCanvasStyles from '../../task/canvas/applyCanvasStyles';\n\nexport default actions;\n\n// @TODO: see if we can afford to change the signature of actions\n// I'd like to have the trial go first here (used almost always).\nvar actions = {\n    /*\n     * Stimulus actions\n     */\n    showStim: function(action, eventData, trial){\n        var handle = action.handle || action;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) stim.show();\n        });\n    },\n\n    hideStim: function(action, eventData, trial){\n        var handle = action.handle || action;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) stim.hide();\n        });\n    },\n\n    setStimAttr: function(action, eventData, trial){\n        var handle = action.handle;\n        var setter = action.setter;\n        trial.stimulusCollection.stimuli.forEach(function(stim){\n            if (handle == 'All' || stim.handle == handle) {\n                if (_.isFunction(setter)) setter.apply(stim);\n                else _.extend(stim.data, setter);\n            }\n        });\n    },\n\n    /*\n     * Trial actions\n     */\n\n    setTrialAttr: function(action, eventData, trial){\n        var setter = action.setter;\n        if (typeof setter == 'undefined') throw new Error('The setTrialAttr action requires a setter property');\n        if (_.isFunction(setter)) setter.apply(trial, [trial.data,eventData]);\n        else _.extend(trial.data,setter);\n    },\n\n    setInput: function(action, eventData, trial){\n        if (typeof action.input == 'undefined') throw new Error('The setInput action requires an input property');\n        trial.input.add(action.input);\n    },\n\n    trigger: function(action, eventData, trial){\n        if (typeof action.handle == 'undefined') throw new Error('The trigger action requires a handle property');\n        trial.input.add({handle:action.handle, on:'timeout', duration:+action.duration || 0});\n    },\n\n    removeInput: function(action, eventData, trial){\n        var input = trial.input;\n        var handleList = action.handle;\n        if (typeof handleList == 'undefined') throw new Error('The removeInput action requires a handle property');\n        if (handleList == 'All' || _.include(handleList,'All')) input.removeAll();\n        else input.remove(handleList);\n    },\n\n    goto: function(action, eventData, trial){\n        trial._next = [action.destination,action.properties];\n    },\n\n    endTrial: function(){\n        // this is explicitly managed in interaction.js\n        // in order to improve trial lifecycle control\n    },\n\n    resetTimer: function(action,eventData,trial){\n        // when to reset timer\n        action.immidiate ? reset() :  fastdom.mutate(reset);\n\n        function reset(){\n            eventData.latency = 0;\n            trial.input.resetTimer();\n        }\n    },\n\n    /*\n     * Logger\n     */\n\n    log: function(action,eventData,trial){\n        trial.$logs(arguments);\n    },\n\n    /*\n     * Misc\n     */\n\n    setGlobalAttr: function(action){\n        switch (typeof action.setter){\n            case 'function':\n                action.setter.apply(null,[global(), action]);\n                break;\n            case 'object':\n                _.extend(global(), action.setter);\n                break;\n            default:\n                throw new Error('setGlobalAttr requires a \"setter\" property');\n        }\n    },\n\n    custom: function(action,eventData, trial){\n        if (typeof action.fn != 'function') throw new Error('The custom action requires a fn propery');\n        action.fn(action, eventData, trial);\n    },\n\n    canvas: function(action, eventData, trial){\n        var canvas = trial.cavnas;\n        var map = {\n            background \t\t\t: {element: document.body, property: 'backgroundColor'},\n            canvasBackground\t: {element: canvas, property:'backgroundColor'},\n            borderColor\t\t\t: {element: canvas, property:'borderColor'},\n            borderWidth\t\t\t: {element: canvas, property:'borderWidth'}\n        };\n\n        // settings activator\n        var off = applyCanvasStyles(map, _.pick(action,['background','canvasBackground','borderColor','borderWidth']));\n        trial.$end.map(off);\n    }\n};\n\n","import './polyfills';\nimport './time.css';\n\nimport setup from './app/setup';\nimport preloadPhase from './app/preloadPhase';\nimport playPhase from './app/playPhase';\n\nexport default activate;\n\n/**\n * activate : (HTMLelement, timeScript) -> Sink\n *\n * timeScript : {settings, sequence, trialSets, stimulusSets, mediaSets, current}\n * Sink: {$trial, $logs, play, end}\n **/\nfunction activate(canvas, script){\n    var sink = setup(canvas, script);\n    var playSink = playPhase(sink);\n\n    playSink.$trial.end.map(playSink.$resize.end.bind(null, true)); // end resize stream\n\n    // preload Images, then start \"playPhase\"\n    preloadPhase(canvas, script).then(playSink.start);\n\n    return playSink;\n}\n\n","import scriptPreloader from './task/sequencer/scriptPreloader';\nimport fastdom from 'fastdom';\n\nexport default preloadPhase;\n\nfunction preloadPhase(canvas, script){\n    var preloader = scriptPreloader(script, script.base_url);\n\n    if (preloader.progress() == 1) return Promise.resolve().then(emptyCanvas);\n\n    canvas.innerHTML = '<div class=\"minno-progress\"><div class=\"minno-progress-bar\"></div></div>';\n\n    var barStyle = canvas.getElementsByClassName('minno-progress-bar')[0].style;\n    barStyle.width = preloader.progress() + '%';\n    preloader.onload = function(){\n        fastdom.mutate(function(){\n            barStyle.width = preloader.progress()*100 + '%';\n        });\n    };\n\n    return preloader.all()\n        .then(emptyCanvas)['catch'](function(src){\n            throw new Error('loading resource failed, do something about it! (you can start by checking the error log, you are probably reffering to the wrong url - ' + src +')');\n        });\n\n    function emptyCanvas(){\n        while (canvas.firstChild) canvas.removeChild(canvas.firstChild);\n    }\n}\n\n"],"names":["log","console","apply","arguments","global","glob","go","destination","properties","context","mixerSequence","this","where","prev","current","next","Error","direction","sequence","curr","_","callback","data","parse","num","parseFloat","adjust_canvas","canvas","settings","resize","targetSize","proportions","isPlainObject","height","width","getProportions","docElement","window","document","documentElement","maxHeight","clientHeight","maxWidth","Math","min","clientWidth","el","computedStyle","getComputedStyle","offsetHeight","borderTopWidth","borderBottomWidth","offsetWidth","borderLeftWidth","borderRightWidth","getSize","parentNode","getTargetSize","marginTop","style","fontSize","textSize","scrollTo","throttle","event","type","setTimeout","canvasContructor","map","offArr","isUndefined","noop","value","key","rule","property","old","on","element","forEach","fn","call","setup","script","$resize","canvasSettings","stream","isElement","classList","add","off","applyCanvasStyles","background","body","canvasBackground","borderColor","borderWidth","pick","css","adjustCanvas","addEventListener","end","remove","removeEventListener","canvasSetup","get","db","Database","createColl","trialSets","stimulusSets","mediaSets","isArray","currentSequence","createDB","name","logs","setupVars","buildUrl","baseUrl","url","test","isObject","length","preloadScript","getStimMedia","getTrialMedia","filter","notMixer","flattenDeep","notUndefined","getScriptMedia","media","image","preloader","load","template","trial","input","stimuli","layout","stim","mixer","val","mouseEvents","eventName","inputObj","$listener","fastdom","mutate","appendChild","e","target","getAttribute","stimHandle","removeChild","keypressed","keypressListener","keyDownArr","which","indexOf","preventDefault","Array","toUpperCase","charCodeAt","timeout","timeoutID","duration","floor","random","isFunction","isNumber","max","randomize","clearTimeout","bind","inputBinder","createElement","css2","css1","keyup","assign","position","left","opacity","right","top","bottom","createListener","isString","binder","getListener","_state","isStream","obj","toString","JSON","stringify","logObj","handle","getMedia","html","inlineTemplate","promise","p","then","isThenable","Promise","reject","customMedia","word","textContent","resolve","innerHTML","onload","onerror","src","jquery","setSize","stimulus","size","font_size","isSet","isWordMedia","prop","setPlace","location","undefined","YCLASS","XCLASS","attr","isNaN","isNumeric","init","source","$messages","self","setAttribute","isLayout","documentMode","xCenter","contains","yCenter","measure","transform","marginLeft","fixIE","error","message","show","hide","destroy","alias","inherit","set","mediaName","options","fullpath","replace","arr","stimCollection","toStim","Stimulus","validateStimuli","_source","ready","all","concat","getStimlist","getMedialist","nolog","index","every","hasData","searchObj","stimulusCollection","some","conditionsEvaluate","conditions","inputData","condition","conditionHash","getConditionFn","applyActions","actions","eventData","endTrial","action","actionFn","actionList","interactions","recursionDepth","isValidProp","interaction","validateInteractions","i","conditionTrue","groupName","debugLog","MAX_RECURSION_DEPTH","evaluate","push","activate","rows","Trial","$logs","$events","$end","_id","uniqueId","counter","gid","listenerStack","baseTime","timestamp","Date","latency","now","splice","removeAll","resetTimer","_next","post","request","XMLHttpRequest","open","setRequestHeader","onreadystatechange","readyState","status","responseText","send","serialize","poster","serializedPost","newServelet","metaData","meta","r","encodeURIComponent","join","catch","cache","pulse","transformLogs","piGlobal","trialData","logStack","stimList","mediaList","log_serial","trial_id","responseHandle","playerPhase","sink","play","goto","buildMedia","inflate","base_url","requirejs","mediaData","mediaMeta","buildStim","skip","stimulusData","stimulusMeta","globalGetter","done","nextTrial","$source","$trial","oldTrial","$sourceLogs","DEBUG","trialName","group","groupCollapsed","row","groupEnd","setupDebug","start","activateTrial","defaultLogMap","args","applyMap","logger","logMap","createLogs","loggerSettings","taskName","$meta","composeLoggerSettings","onDone","onEnd","extend","getTime","w","perfNow","perfNowNames","n","table","vendors","requestAnimationFrame","vp","cancelAnimationFrame","navigator","userAgent","lastTime","nextTime","PromisePolyfill","executor","handler","list","shouldAbsorb","execute","callAsync","resolvers","rejectors","instance","state","retry","TypeError","executeOnce","rejectCurrent","run","runs","resolveCurrent","_instance","setImmediate","prototype","onFulfilled","onRejection","resolveNext","rejectNext","total","count","values","consume","race","createStream","HALT","updateStream","constructor","id","guid","derive","recover","deps","parents","endStream","unregister","ap","valueOf","toJSON","Object","defineProperties","unregisterStream","initStream","updateState","updateDependency","changed","finalize","mustSync","active","combine","streams","valid","dep","notEnded","registerDependency","initDependency","dependent","s1","s2","merge","s","scan","reducer","seed","newStream","scanMerge","tuples","tuple","idx","module","g","srcStack","defStack","stackDone","getText","memoize","loader","getImage","progress","win","FastDom","reads","writes","raf","scheduleFlush","scheduled","debug","runTasks","tasks","task","shift","array","item","webkitRequestAnimationFrame","mozRequestAnimationFrame","msRequestAnimationFrame","cb","ctx","clear","props","child","create","hasOwnProperty","mixin","initialize","exports","performance","begin","inputEquals","inputEqualsTrial","inputEqualsStim","trialEquals","inputEqualsGlobal","globalEquals","globalEqualsTrial","globalProp","trialProp","globalEqualsStim","stimProp","currentEquals","currentEqualsTrial","currentProp","currentEqualsStim","inputEqualsCurrent","custom","showStim","hideStim","setStimAttr","setter","setTrialAttr","setInput","trigger","removeInput","handleList","include","reset","immidiate","setGlobalAttr","cavnas","trialId","addTrialDetails","playSink","playPhase","emptyCanvas","firstChild","scriptPreloader","barStyle","getElementsByClassName","preloadPhase"],"mappings":"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"}